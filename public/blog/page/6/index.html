
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Spring in Practice</title>
  <meta name="author" content="Willie Wheeler">

  
  <meta name="description" content="In this tutorial we&rsquo;re going to learn how to get started with Hibernate Validator, which as its name suggests is a validation framework &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://springinpractice.com/blog/page/6">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Spring in Practice" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Forum' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31137459-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <ul class="social-links">
    <li><a href="https://twitter.com/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/twitter.png" alt="Twitter" /></a></li>
    <li><a href="https://github.com/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/github.png" alt="GitHub" /></a></li>
    <li><a href="http://stackoverflow.com/users/41871/willie-wheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/stackoverflow.png" alt="Stack Overflow" /></a></li>
    <li><a href="http://www.linkedin.com/in/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/linkedin.png" alt="LinkedIn" /></a></li>
  </ul>
  <h1><a href="/">Spring in Practice</a></h1>
  
    <h2>Willie Wheeler's Spring blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives/">Archives</a></li>
  <li><a href="/book/">The Book</a></li>
  <li><a href="/consulting/"><span style="padding-left:20px;background:url(http://springinpractice.com/images/leaf.png) left no-repeat">Spring Consulting</span></a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/02/02/getting-started-with-hibernate-validator/">Getting Started With Hibernate Validator</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-02T07:00:16-08:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2009</time>
        
         | <a href="/2009/02/02/getting-started-with-hibernate-validator/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we&rsquo;re going to learn how to get started with Hibernate Validator, which as its name suggests is a validation framework associated with the Hibernate project. This article is really a follow-up to <a href="http://springinpractice.com/2008/07/17/annotation-based-validation-with-the-spring-bean-validation-framework/">my earlier article on using the Bean Validation Framework</a> (part of the larger <a href="https://springmodules.dev.java.net/">Spring Modules</a> project), which is a competing framework that seems to have lost the battle for Spring&rsquo;s &ldquo;preferred validation provider&rdquo; status to Hibernate Validator. Both Uri Boness (in an e-mail correspondence) and Juergen Hoeller (at SpringOne) agreed that people should start moving toward Hibernate Validator since that will eventually support the emerging <a href="http://jcp.org/en/jsr/detail?id=303">JSR 303</a> standard.</p>

<p>Hibernate Validator is nice because it (like the Bean Validation Framework) supports declarative validation via <a href="http://java.sun.com/j2se/1.5.0/docs/guide/language/annotations.html">Java 5 annotations</a>. Let&rsquo;s say you create a bean class, like an <code>Account</code> or a <code>PurchaseOrder</code> or whatever. With Hibernate Validator you can attach validation annotations to the bean properties and that will define the validation constraints for the bean. Moreover, unlike earlier approaches to validation (such as Struts Validation), Hibernate Validator isn&rsquo;t tied to the web tier, and so if you want to validate your beans from within your service beans, or within your DAOs, or even just before you ORM them into your database, no sweat. You can do just that.</p>

<p>Anyway, for now we&rsquo;re just going to look at some of the basics: how to specify annotation constraints and how to check for constraint violations. We&rsquo;re not going to worry about integrating Hibernate Validator with Spring&rsquo;s native validation framework (so that, for instance, we might render Hibernate Validator error messages out using Spring Web MVC taglibs) though I&rsquo;ll probably write another article on that sometime in the future if people are interested.</p></p>

<p>For this article we&rsquo;re using Java 5 or higher (we need Java 5 annotations) and Hibernate Validator 3.1.0. For your convenience I&rsquo;ve created a <a href="http://maven.apache.org/">Maven 2</a> project that you can download: <a href="http://wheelersoftware.s3.amazonaws.com/articles/hibernate-validator/hibernate-validator-demo.zip">hibernate-validator-demo.zip</a></p>

<p>OK, let&rsquo;s jump into some examples of annotated bean classes.</p>

<h3>Specifying validation constraints with Hibernate Validator annotations</h3>


<p>Here are a couple of examples of annotated bean classes: a <code>User</code> class and an <code>Address</code> class. Note that the two objects are related in a parent-child fashion.</p>

<p>First, here is the <code>User</code> bean class:</p>

<pre>package com.wheelersoftware.demos.hibernatevalidator;

import org.hibernate.validator.Email;
import org.hibernate.validator.Length;
import org.hibernate.validator.NotEmpty;
import org.hibernate.validator.Valid;

public class User {
    private String username;
    private String firstName;
    private String lastName;
    private Address address;
    private String email;
    private String password;

    @NotEmpty
    @Length(max = 20)
    public String getUsername() { return username; }

    public void setUsername(String username) {
        this.username = username;
    }

    @NotEmpty
    @Length(max = 20)
    public String getFirstName() { return firstName; }

    public void setFirstName(String firstName) {
        this.firstName = firstName;
    }

    @NotEmpty
    @Length(max = 20)
    public String getLastName() { return lastName; }

    public void setLastName(String lastName) {
        this.lastName = lastName;
    }

    @Valid
    public Address getAddress() { return address; }

    public void setAddress(Address address) {
        this.address = address;
    }

    @NotEmpty
    @Email
    public String getEmail() { return email; }

    public void setEmail(String email) {
        this.email = email;
    }

    @NotEmpty
    @Length(max = 20)
    public String getPassword() { return password; }

    public void setPassword(String password) {
        this.password = password;
    }
}</pre>


<p>Let&rsquo;s talk a little about what&rsquo;s going on with the code above. As we noted earlier, we have a bean class (here, a class that represents user accounts of some sort) and we&rsquo;re using annotations to specify validation constraints. For a full list of the built-in constraints, see the <a href="http://www.hibernate.org/hib_docs/validator/reference/en/html/validator-defineconstraints.html#validator-defineconstraints-builtin">official Hibernate Validator documentation</a>, but we&rsquo;ll just focus on a small handful for right now.</p>

<p>First notice that we&rsquo;ve attached our annotations to the getter methods. This is how we specify the validation constraints that attach to the associated properties.</p>

<p>We&rsquo;ve used <code>@NotEmpty</code> in several places. This annotation means that the annotated property can&rsquo;t be null and it can&rsquo;t be the empty string either. There&rsquo;s also a <code>@NotNull</code> annotation that we could have used if we&rsquo;d wanted to, but in this case I wanted to prevent the empty string from being used as values.</p>

<p>Another annotation that appears multiple times is the <code>@Length</code> annotation. We can specify associated minimum and maximum lengths by using the <code>min</code> and <code>max</code> elements, respectively, though in the example above we&rsquo;ve specified only maximum lengths. (In the example that follows we&rsquo;ll see how to specify a minimum length as well.) So for example we&rsquo;ve specified that passwords can&rsquo;t be any longer than 20 characters.</p>

<p>A third annotation is the <code>@Email</code> annotation. As you would guess, this indicates that the property must contain a valid e-mail address.</p>

<p>The fourth and final annotation of the ones that appear above is the <code>@Valid</code> annotation. This tells Hibernate Validator that it should validate the associated object&mdash;here an associated <code>Address</code> object&mdash;using whatever validation annotations we define on the <code>Address</code> class.</p>

<p>And that&rsquo;s our segue into our second example, the <code>Address</code> bean class, which appears below.</p>

<pre>package com.wheelersoftware.demos.hibernatevalidator;

import org.hibernate.validator.Length;
import org.hibernate.validator.NotEmpty;
import org.hibernate.validator.Pattern;

public class Address {
    private String street1;
    private String street2;
    private String city;
    private String state;
    private String zip;

    @NotEmpty
    @Length(max = 40)
    public String getStreet1() { return street1; }

    public void setStreet1(String street1) {
        this.street1 = street1;
    }

    // No validation constraints
    public String getStreet2() { return street2; }

    public void setStreet2(String street2) {
        this.street2 = street2;
    }

    @NotEmpty
    @Length(max = 40)
    public String getCity() { return city; }

    public void setCity(String city) {
        this.city = city;
    }

    @NotEmpty
    @Length(max = 3)
    public String getState() { return state; }

    public void setState(String state) {
        this.state = state;
    }

    @NotEmpty
    @Length(min = 5, max = 5, message = "{zip.length}")
    @Pattern(regex = "[0-9]+")
    public String getZip() { return zip; }

    public void setZip(String zip) {
        this.zip = zip;
    }
}</pre>


<p>Our validation annotations for <code>Address</code> are pretty similar to what we saw for <code>User</code>, but there are a few differences worth mentioning. First, notice that we don&rsquo;t have to attach validation constraints to every property. It&rsquo;s OK, for example, for <code>street2</code> to be null or anything else, so we simply refrain from defining validation constraints for this property.</p>

<p>Second, we&rsquo;re using a <code>@Pattern</code> annotation for the <code>zip</code> property. This allows us to specify regular expression match patterns.</p>

<p>The third and final difference is the <code>@Length</code> annotation we&rsquo;ve defined for the <code>zip</code> property. Besides including a <code>min</code> element (which, when combined with the <code>max</code> element, indicates that the ZIP code must be exactly five characters long), we&rsquo;ve also included a <code>message</code> element. We can use this element to do either of two things. First, we can use it to define a hardcoded message to display when the given validation constraint fails. That&rsquo;s not what we&rsquo;re doing here. Instead we&rsquo;re doing the second thing we can do, which is specify a message key using the brace syntax: <code>message = {key_name}</code>. The idea is that we&rsquo;ll eventually use this message key to look up a message in a resource bundle, thus externalizing the message. Later in the tutorial we&rsquo;ll map the <code>zip.length</code> message key to an actual message using a resource bundle.</p>

<p>That&rsquo;s it for the validation constraints themselves. Now let&rsquo;s see how we can tell Hibernate Validator to use them to perform our bean validation.</p>

<h3>How to tell Hibernate Validator to validate annotated beans</h3>


<p>It&rsquo;s fairly straightforward to get Hibernate Validator to validate our annotated beans. The following listing presents some demo code for doing exactly this. Let&rsquo;s take a look.</p>

<pre>package com.wheelersoftware.demos.hibernatevalidator;

import org.hibernate.validator.ClassValidator;
import org.hibernate.validator.InvalidValue;

public final class Demo {
    private static ClassValidator&lt;User&gt;
        userValidator = new ClassValidator&lt;User&gt;(User.class);

    public static void main(String[] args) {
        validateUser(createUser());
    }

    private static User createUser() {
        User user = new User();
        user.setFirstName("123456789012345678901");
        user.setEmail("aol.com");

        Address addr = new Address();
        addr.setStreet1("");
        addr.setCity("Moreno Valley");
        addr.setState("CA");
        addr.setZip("QWERTY");
        user.setAddress(addr);

        return user;
    }

    private static void validateUser(User user) {
        InvalidValue[] invalidValues = userValidator.getInvalidValues(user);
        for (InvalidValue value : invalidValues) {
            System.out.println("========");
            System.out.println(value);
            System.out.println("message=" + value.getMessage());
            System.out.println("propertyName=" + value.getPropertyName());
            System.out.println("propertyPath=" + value.getPropertyPath());
            System.out.println("value=" + value.getValue());
        }
    }
}</pre>


<p>There are really only a few interesting things happening here. First, we create a <code>ClassValidator&lt;User&gt;</code> instance for validating our <code>User</code> beans. We have to associate the <code>ClassValidator</code> with a type (here, <code>User</code>) because this is where Hibernate Validator goes in and reads all the annotations off of the bean class in question.</p>

<p>Next, we have to create the bean we want to validate. Usually this would come from a user form (for example, a web-based form, or maybe a Swing-based form) though that&rsquo;s not necessarily the case. Here we just create a bean manually, and we intentionally make a lot of the fields invalid so we can see how Hibernate Validator responds.</p>

<p>Finally we make the call <code>userValidator.getInvalidValues(user)</code>. This generates an array of <code>InvalidValue</code> instances&mdash;one for each validation constraint violation. Let&rsquo;s examine the <code>InvalidValue</code> class in more detail.</p>

<h3>Understanding InvalidValue</h3>


<p>To understand <code>InvalidValue</code> it will help to run the demo. So do that right now. You should see output that looks something like this:</p>

<pre>26 [main] INFO org.hibernate.validator.Version - Hibernate Validator 3.1.0.GA
45 [main] INFO org.hibernate.annotations.common.Version - Hibernate Commons Annotations 3.1.0.GA
========
username may not be null or empty
message=may not be null or empty
propertyName=username
propertyPath=username
value=null
========
firstName length must be between 0 and 20
message=length must be between 0 and 20
propertyName=firstName
propertyPath=firstName
value=123456789012345678901
========
lastName may not be null or empty
message=may not be null or empty
propertyName=lastName
propertyPath=lastName
value=null
========
email not a well-formed email address
message=not a well-formed email address
propertyName=email
propertyPath=email
value=aol.com
========
password may not be null or empty
message=may not be null or empty
propertyName=password
propertyPath=password
value=null
========
street1 may not be null or empty
message=may not be null or empty
propertyName=street1
propertyPath=address.street1
value=
========
zip {zip.length}
message={zip.length}
propertyName=zip
propertyPath=address.zip
value=QWERTY
========
zip must match "[0-9]+"
message=must match "[0-9]+"
propertyName=zip
propertyPath=address.zip
value=QWERTY</pre>


<p>If you look at the source code for <code>Demo.validateUser()</code> you&rsquo;ll see that we&rsquo;re printing out each <code>InvalidValue</code> instance itself (the first line) as well as the values of the <code>message</code>, <code>propertyName</code>, <code>propertyPath</code> and <code>value</code> properties (the rest of the lines). When we print out the instance itself, we get Hibernate Validator&rsquo;s attempt at a user-friendly validation eror message. It starts with the property name and then appends the message; examples include</p>

<ul class="square">
<li><code>email not a well-formed e-mail address</code></li>
<li><code>password may not be null or empty</code></li>
<li><code>zip must match "[0-9]+"</code></li>
</ul>


<p>Each <code>message</code> value (such as <code>may not be null or empty</code>) is a default associated with a validation annotation (such as <code>@NotEmpty</code>). Note that in the case of the length violation for the <code>zip</code> property, we&rsquo;re seeing not the default length message, but instead the new message key name (namely, <code>zip.length</code>) we specified in listing 2. We&rsquo;ll see how to map <code>zip.length</code> to an actual message using a resource bundle in a little bit. For now we&rsquo;re seeing just the key name because we haven&rsquo;t yet associated a message with the key.</p>

<p>The <code>propertyName</code> property specifies the name of the bean property whose value is invalid. For example, if we provide a bad ZIP code, then <code>propertyName</code> is <code>zip</code>.</p>

<p>The <code>propertyPath</code> property is similar to <code>propertyName</code> property, except that with <code>propertyPath</code> we get to see the path from the top-level bean down to the invalid property. You can see the difference, for instance, with the invalid ZIP code: <code>propertyName</code> is <code>zip</code> but <code>propertyValue</code> is <code>address.zip</code>.</p>

<p>Finally, <code>value</code> is just the bad value that violated the validation constraint in the first place.</p>

<p>While we can use <code>InvalidValue</code> itself as a source of semi-user-friendly messages, it&rsquo;s clear that the defaults leave something to be desired. After all, <code>zip must match &ldquo;[0-9]+&rdquo;</code> wouldn&rsquo;t be what most users would consider user-friendly. We can however provide a resource bundle to improve the error messages and that&rsquo;s what we&rsquo;ll look at now.</p>

<h3>Improving validation error messages using ValidatorMessages.properties</h3>


<p>With Hibernate Validator we can override the default messages associated with the various validation annotations. We can also provide highly specific error messages associated with property/constraint pairs. We do this using resource bundles. Though it&rsquo;s possible to provide Hibernate Validator with arbitrary resource bundles, the easiest approach is to create a <code>ValidatorMessages.properties</code> resource bundle on the classpath and use that. Hibernate Validator knows to look for that particular bundle (including any associated localizations) and use it as a message source. The next listing presents a simple example.</p>

<pre>validator.notEmpty=may not be null or empty!
validator.length=must be {max} or fewer characters.
zip.length=Please enter a {max}-character ZIP code.</pre>


<p>The first two lines of listing 3 provide alternatives for the <code>validator.notEmpty</code> and <code>validator.length</code> message keys. The key names are defined by the validation annotations themselves, so consult the Javadocs for the annotations if you need the key names (though you should be able to figure them out using the examples above).</p>

<p>Notice the <code>{max}</code> that appears in the message for the <code>validator.length</code> key. You can reference annotation elements from messages using the brace syntax. Consult the Javadocs for the various annotations&mdash;or else the Hibernate Validator reference manual&mdash;for a complete list of annotations and annotation elements.</p>

<p>The third line also specifies a message, but this time we&rsquo;re associating a message with the <code>zip.length</code> custom key we defined in listing 2. Note that here we don&rsquo;t use the braces for the key name. And also note that we can still reference annotation elements using the brace syntax. The custom message key approach is useful when you want to be very specific about the error message you provide to the end user.</p>

<p>Here&#8217;s what it looks like when you run it:</p>




<pre>29 [main] INFO org.hibernate.validator.Version - Hibernate Validator 3.1.0.GA
59 [main] INFO org.hibernate.annotations.common.Version - Hibernate Commons Annotations 3.1.0.GA
========
username may not be null or empty!
message=may not be null or empty!
propertyName=username
propertyPath=username
value=null
========
firstName must be 20 or fewer characters.
message=must be 20 or fewer characters.
propertyName=firstName
propertyPath=firstName
value=123456789012345678901
========
lastName may not be null or empty!
message=may not be null or empty!
propertyName=lastName
propertyPath=lastName
value=null
========
email not a well-formed email address
message=not a well-formed email address
propertyName=email
propertyPath=email
value=aol.com
========
password may not be null or empty!
message=may not be null or empty!
propertyName=password
propertyPath=password
value=null
========
street1 may not be null or empty!
message=may not be null or empty!
propertyName=street1
propertyPath=address.street1
value=
========
zip Please enter a 5-character ZIP code.
message=Please enter a 5-character ZIP code.
propertyName=zip
propertyPath=address.zip
value=QWERTY
========
zip must match "[0-9]+"
message=must match "[0-9]+"
propertyName=zip
propertyPath=address.zip
value=QWERTY</pre>




<h3>Discussion</h3>


<p>That wraps it up for this tutorial. It&rsquo;s a good idea to get familiar with Hibernate Validator for a number of reasons:</p>

<ul class="square">
<li>Annotation-based declarative annotations are an intuitive and convenient way to specify validation constraints.</li>
<li>Hibernate Validator isn&#8217;t tied to any particular application tier.</li>
<li>It will support the JSR 303 standard once that finalizes.</li>
</ul>


<p>We haven&rsquo;t explored everything that Hibernate Validator has to offer. For instance, it&rsquo;s possible to configure it such that Hibernate ORM automatically runs Hibernate Validator when performing persistence operations.</p>

<p>One slight annoyance that I&rsquo;ve found is that there doesn&rsquo;t seem to be built-in way to substitute the bad value into the message itself. Sometimes I like to have messages like</p>

<p><code>willie2gmail.com is not a valid e-mail address</code></p>

<p>I suppose that I could create messages like</p>

<p><code>{1} is not a valid e-mail address</code></p>

<p>and then perform the substitution when processing the <code>InvalidValue</code> array, but it would be nice to be able to do this out of the box. Maybe there&rsquo;s a way to do it after all, but if so, I haven&rsquo;t found it.</p>

<p>Also, the documentation for Hibernate Validator is a little thin, both with respect to the reference manual and the Javadocs. Hopefully as JSR 303 matures we&rsquo;ll see improvements in this area. In the meantime, this tutorial will be my contribution to helping people understand Hibernate Validator.</p>

<div class="endnote">Post migrated from my Wheeler Software site.</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/12/03/new-stuff-in-spring-30-part-2/">New Stuff in Spring 3.0, Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-03T07:34:41-08:00" pubdate data-updated="true">Dec 3<span>rd</span>, 2008</time>
        
         | <a href="/2008/12/03/new-stuff-in-spring-30-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>[Here&rsquo;s <a href="http://springinpractice.wordpress.com/2008/12/02/new-stuff-in-spring-30/">part 1</a> if you missed it.]</p>

<p>As promised, here&rsquo;s the rest of my notes dump on what&rsquo;s new in Spring 3.0, or really Spring 3.x since a  lot of what comes in Spring 3.x is waiting on JEE 6, which probably won&rsquo;t be finalized until after Spring 3.0 is already released.</p>

<h3>More about Spring 3 and its support for JEE 6</h3>


<p>Before I continue describing Juergen&rsquo;s first talk, I did attend another of his talks just a while ago and it seems like Spring 3/JEE 6 integration is going to be &ldquo;interesting,&rdquo; especially as concerns Spring integration with the forthcoming Java Web Beans effort (and to a lesser extent, EJB 3.1).  He didn&rsquo;t work too hard to hide his displeasure at the unattributed fashion in which many of the core ideas from Spring are making their way into the JEE specs. He described Web Beans as being a standardized DI framework with a focus on supporting scoped beans (request, conversation, session, application, etc.), and noted that many of the annotations from Web Beans and EJB 3.1 have direct counterparts in Spring. Taken together it sounds like Web Beans + EJB 3.1 will compete with Spring, with Web Beans handling the user component model and EJB 3.1 providing platform services (transaction management, container-managed security and so forth).</p>

<p>Anyway regarding Spring 3 and JEE 6, it will be fun to watch as it unfolds.  :&ndash;)</p>

<p>Here&rsquo;s some more information related to how Spring 3 will support JEE 6:</p>

<ul>
<li>JSF 2.0: full compatibility as managed bean facility</li>
<li>JPA 2.0: support for lock modes and query timeouts (Hibernate supports these, but this is new for JPA)</li>
<li>JAX-RS and Jersey reference implementation (part of Glassfish): Spring will support these though they see JAX-RS as an alternative to Spring Web MVC&#8217;s REST support. Juergen said that he sees JAX-RS for more &#8220;hardcore&#8221; RESTful web service applications, and it&#8217;s a completely separate component model for building programmatic resource endpoints.</li>
<li>JSR 236 WorkManager and TimerManager: Rich, standardized access to thread pools. This spec is behind schedule so it won&#8217;t be in Spring 3. Maybe Spring 3.1. Juergen is excited about this though it sounded like it&#8217;s more from the framework perspective than from the app developer perspective.</li>
<li>Servlet 3.0: This won&#8217;t be supported til Spring 3.1 or Spring 3.2, but two major items here are (1) auto-deployment of framework integration classes (I didn&#8217;t fully catch what this meant&#8211;I couldn&#8217;t tell if it&#8217;s about hot-deploying JARs or what), and (2) support for Comet requests. The Comet support would include new HTTP request and response types.
<li>EJB 3.1 and Web Beans as described above. Just depends where the specs go.</li>
</ul>


<p>The Spring team is tracking GlassFish 3 and Tomcat 7 as well.</p>

<h3>JSR 303: Bean Validation</h3>


<p>This one looks like it will be for Spring 3.1 rather than Spring 3.0 since the Bean Validation spec isn&rsquo;t done yet. The idea though is that JSR 303 provides a declarative, annotation-based model for defining validation constraints, and so instead of forcing developers to invoke validation manually, the framework would automatically invoke it at appropriate places.  I haven&rsquo;t played much with Hibernate Validator yet but I think you can make Hibernate automatically validate persistent objects before saving them.  So the same sort of thing would occur elsewhere.  For example Spring Web MVC will I believe automatically invoke validation after doing form binding.</p>

<p>I did ask about the Bean Validation Framework (from the Spring Modules project), and whether that was dead. I think for a brief moment he didn&rsquo;t know what I was talking about when I said &ldquo;Bean Validation Framework&rdquo; (not a good sign for the BVF), and when I mentioned Spring Modules he said [paraphrasing here]: yeah, BVF is pretty much dead, use Hibernate Validator instead. My brother asked Uri Boness (BVF lead) about it several months back and he said roughly the same thing, that the best bet is for people to use Hibernate Validator and plan on JSR 303 being the future of validation.</p>

<p>Spring 3.0 will support Hibernate Validator annotations but the real goal is to support JSR 303 annotations.</p>

<h3>Portlet 2.0 support</h3>


<p>Some major Portlet 2.0 capabilities include:</p>

<ul>
<li>An explicit action name concept for dispatching</li>
<li>Two new request types: resource requests for servlet-style serving, and events for inter-portlet communication</li>
<li>Portlet filters, which are analogous to servlet filters</li>
</ul>


<p>Spring 3 will have Portlet 2.0 support. In particular, Portlet MVC 3.0 will support the following mapping annotations: <code>@ActionMapping</code>, <code>@RenderMapping</code>, <code>@ResourceMapping</code>, and <code>@EventMapping</code>. Conceptually these are specializations of Spring Web MVC&rsquo;s <code>@RequestMapping</code> annotation even though there&rsquo;s no explicit subtype relationship here.</p>

<p>Some other odds and ends:</p>

<ul>
<li>In the Spring EL there will be some scope-sensitive Portlet-related implicit objects such as the current <code>PortletRequest</code> and <code>PortletSession</code>.</li>
<li>The <code>@RequestHeader</code> and <code>@CookieValue</code> annotations I mentioned yesterday will work for both Servlet MVC and Portlet MVC.</li>
</ul>


<p>Juergen also described some areas of research. These aren&rsquo;t necessarily going into Spring 3 anytime soon but they&rsquo;re just taking a look right now.</p>

<h3>Research area #1: Conversation management</h3>


<p>A key problem in conversation management is isolating concurrent windows in the same browser. Historically this has been the domain of Spring Web Flow, but there&rsquo;s some thought of moving some level of conversation management to Spring Core. The idea is to introduce a new scope that&rsquo;s larger than a single request but smaller than an entire session&mdash;a conversation&mdash;and be able to handle that, along the lines of the MyFaces Orchestra project.</p>

<p>This is just me editorializing now, but I&rsquo;m myself a little dubious of the usefulness of a conversation scope if the goal is really just managing different browser windows. To me it seems like running a single app in multiple browser windows is a corner case. I suspect that what&rsquo;s going on is that Spring is responding to the fact that JEE 6 Web Beans will have a conversation scope.</p>

<p>If the goal is to handle Spring Web Flow-type scenarios (single window) then yeah, that I can see. Anyway.</p>

<h3>Research area #2: Scoped bean serializability</h3>


<p>Sometimes you want to be able to serialize beans, but you can&rsquo;t, because they contain references (either directly or indirectly) to unserializable objects, like e.g. DataSources. They&rsquo;re looking at ways to address this.</p>

<p>I&rsquo;m not sure what sorts of serialization scenarios they have in mind. Originally I was thinking Juergen was talking about saving out sessions during server shutdowns (like Tomcat does) and stuff like that, but as I write this, that doesn&rsquo;t seem right, because your domain objects wouldn&rsquo;t have DataSource references. So apparently some people want to save managed objects, which seems odd since those managed objects (controllers, service beans, DAOs, etc.) are usually stateless. Oh well. I don&rsquo;t doubt that somebody has some reasonable use case here; I just don&rsquo;t myself know exactly what people have in mind on this one.</p>

<p>Hm&hellip; but scoped beans would typically be domain objects&hellip; heh, I&rsquo;m totally confused on this one.  :&ndash;)</p>

<p>Anyway, the Spring team is thinking about how best to handle this. Juergen offered that one &ldquo;solution&rdquo; is just to design your apps so that they don&rsquo;t involve serializing scoped beans. Another idea might be to have serializable proxies that are able to reconstitute the scoped bean when the proxy is initialized.</p>

<p>Spring 3 will also address a handful of housekeeping items.</p>

<h3>Housekeeping and portfolio rearrangements</h3>


<p>Some portfolio rearrangements include:</p>

<ul>
<li>There will be a revised OXM modules as part of the core, rather than just being part of Spring Web Services, as there are broader areas of applicability, including XML payloads in REST and XML datatypes in the database.</li>
<li>The binding and type conversion infrastructure will be revised. It will include capabilities from Spring Web Flow&#8217;s binding, and there will be EL integration here.</li>
<li>Spring 3.0 will include the core functionality of Spring JavaConfig, which basically allows you to configure application contexts from Java instead of using XML.</li>
</ul>




<h3>Deprecation and pruning</h3>


<p>The following will be deprecated:</p>

<ul>
<li>The traditional MVC controller class hierarchy (deprecated in Spring 3.0, removed entirely in Spring 3.1).</li>
<li>Traditional JUnit 3.8 test class hierarchy (this will be replaced with the test context framework)</li>
<li>Various outdated helper classes</li>
</ul>


<p>The following will be removed in Spring 3.0:</p>

<ul>
<li>Commons Attributes support</li>
<li>TopLink API support (replace with JPA/EclipseLink)</li>
<li>Support for Struts 1.x subclass-style actions</li>
</ul>


<p><strong>Some related links:</strong></p>

<ul>
<li><a href="http://greybeardedgeek.net/?p=83">SpringOne Americas 2008 - Day 3</a></li>
<li><a href="http://ptrthomas.wordpress.com/2008/12/04/springone-2008-day-3/">SpringOne 2008 Day 3</a></li>
</ul>


<p>[Update: Here&rsquo;s <a href="http://www.infoq.com/news/2008/12/springone-2008">a related InfoQ article</a>.]</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/12/02/new-stuff-in-spring-30/">New Stuff in Spring 3.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-02T11:59:26-08:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2008</time>
        
         | <a href="/2008/12/02/new-stuff-in-spring-30/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This morning I attended a talk by Juergen Hoeller on what&rsquo;s coming in Spring 3.0. First, he said that we can expect the first milestone release sometime this week, and said that he expected there to be about three milestone releases I think. RC1 is supposed to be out around March 2009 and final around April 2009.</p>

<p>Echoing something I&rsquo;ve heard Keith Donald say, Juergen said that Spring 3.0 is intended to complete the work that was started in Spring 2.5. Keith described the release as being &ldquo;evolutionary, not revolutionary.&rdquo; That may be, but there&rsquo;s still quite a bit to be excited about.  Here&rsquo;s what I got from the talk today. (Hold onto your hats because I took good notes.)</p>

<h3>Java and JEE compatibility</h3>


<p>Spring 3.0 will be the first release that requires Java 5+. From SpringSource&rsquo;s perspective this is nice because they can avail themselves to generics, varargs, etc. But from the app developer&rsquo;s perspective, the idea is that the platform is really pushing use of annotations as the preferred way of doing configuration. So that means Java 5+.</p>

<p>Spring 3.0 will continue to be compatible with J2EE 1.4 and JEE 5. Also, as JEE 6 matures, Spring 3.0 will try to provide early support, but progress on JEE 6 has been somewhat slow and Spring 3.0 should be out before JEE 6. So Spring 3.1 and 3.2 will probably continue work in this direction. Anyway, SpringSource plans to support JSF 2.0, JPA 2.0, Servlet 3.0 when it&rsquo;s ready, etc.)</p>

<h3>Spring EL (Unified EL++)</h3>


<p>Juergen described support for expression languages as probably the most important and powerful feature in Spring 3.0. It will be a proprietary EL parser implementation&mdash;one of the few new modules that Spring 3.0 will introduce&mdash;and it sounded like it would like Unified EL but on steroids. They&rsquo;re trying to keep the EL pretty similar to how it works in JSF, and Spring&rsquo;s EL is designed to be stylistically and syntactically compatible with Unified EL. Also, even though right now Spring Web Flow 2 uses external EL implementations (JBoss EL implementation of Unified EL, I think, or else OGNL), SWF 3 will use Spring EL instead of an external implementation.</p>

<p>Here&rsquo;s a code example he gave. This one is for EL in bean definitions:</p>

<pre>&lt;bean class="mycompany.RewardsTestDatabase"&gt;
    &lt;property name="databaseName" value="#{systemProperties.databaseName}"/&gt;
    &lt;property name="keyGenerator" value="#{strategyBean.databaseKeyGenerator}"/&gt;
&lt;/bean&gt;</pre>


<p>The idea is this. Just like in other ELs, you will have some implicit objects&mdash;objects that you can reference in your EL either because the objects are global in scope or else because the object lives in your current scope (e.g., request scope, session scope, etc.). So in the example above, <code>systemProperties</code> is a global implicit object, and <code>strategyBean</code> is a bean name. Bean names will be available as EL objects then.</p>

<p>I&rsquo;m assuming that the <code>databaseName</code> and <code>keyGenerator</code> properties will be evaluated each time they are accessed. Otherwise it wouldn&rsquo;t be much of an expression language. I&rsquo;m kind of curious to see how they do this. My guess is that the approach will be to proxy beans with EL-based properties, with the proxies evaluating the reference upon demand.</p>

<p>Juergen gave another example, this time of EL in component annotations. Here it is:</p>

<pre>
@Repository
public class RewardsTestDatabase {

    @Value("#{systemProperties.databaseName}")
    public void setDatabaseName(String dbName) { ... }

    @Value("#{strategyBean.databaseKeyGenerator}")
    public void setKeyGenerator(KeyGenerator kg) { ... }
}
</pre>


<p>I <i>believe</i> these two configuration examples are different in a subtle way. The value of the <code>@Value</code> attribute is a default value for the property if a value isn&rsquo;t explicitly defined in the app context. One practical benefit we get has to do with how component scanning currently works. When we component scan, we depend on autowiring to establish injected references. The problem is that if our dependencies are primitive types, autowiring is no longer an option and so we have to go explicit with our bean definitions. With EL-based defaults, we can keep the component scanning, and just set the primitive types using a bean, or maybe using system properties, etc.</p>

<h3>REST support</h3>


<p>Another big topic in Spring 3.0 is REST support. Spring Web MVC will provide first-class support for RESTful web services, and not necessarily just XML-based. Keith was saying that there will be a JSON view as well. So the web services would be useful not only in integration efforts but also for example when you have JavaScript widgets that want to make AJAX calls back to the server and get JSON. Anyway, Spring Web MVC&rsquo;s current design is such that it&rsquo;s really easy to tweak it a bit to support REST, and that&rsquo;s what they&rsquo;re doing. So one aspect of this would be to continue to use <code>@RequestMapping</code> to specify an HTTP method, such as <code>RequestMethod.PUT</code>.  Another piece would be to introduce a new <code>@PathVariable</code> annotation that works pretty much like <code>@RequestParam</code> currently works, but handles URL path segments instead of HTTP parameters. Here&rsquo;s a code example that shows how it will work:</p>

<pre>
@RequestMapping(value = "/show/{id}", method = GET)
public Reward show(@PathVariable("id") long id) {
    return this.rewardsAdminService.findReward(id);
}
</pre>


<p>I like it!</p>

<p>Another feature of the REST support is support for different representations, i.e. content negotiation. They want to use the HTTP <code>Accept</code> header as a new way to do view resolution. So presumably there will be a new <code>ViewResolver</code> implementation that looks at the <code>Accept</code> header and returns, say, an XML view (accepts <code>application/xml</code>), a JSON view (accepts <code>application/json</code>) or an ATOM view (accepts <code>application/atom+xml</code>) according to that header. This would be the preferred way of doing view resolution for the hardcore REST purists. But Spring Web MVC would also support extension-based resolution; e.g. <code>.json</code> maps to a <code>JsonView</code>, etc.</p>

<h3>Some @MVC refinements</h3>


<p>They&rsquo;re planning to add a couple of new @MVC annotations besides <code>@RequestParam</code> (which already exists) and the new <code>@PathVariable</code> annotation. These are:</p>

<ul>
<li><code>@RequestHeader</code>: Grab HTTP request header data.</li>
<li><code>@CookieValue</code>: Grab cookie value. (Surprise!)</li>
</ul>


<p>These will allow us to get at the data without having to declare the raw <code>HttpServletRequest</code> as we currently have to do.  Here&rsquo;s a code sample:</p>

<pre>
@RequestMapping("/show")
public Reward show(@RequestHeader("region") long regionId,
    @CookieValue("language") String langId) {

    ...
}
</pre>


<p>There&rsquo;s quite a bit more, but this post is pretty long as it is and I need to hit the sack. I&rsquo;ll try to post a little more tomorrow.</p>

<p>[Update: Here&rsquo;s <a href="http://springinpractice.wordpress.com/2008/12/03/new-stuff-in-spring-30-part-2/">part 2</a>.]</p>

<p>[Update: Here&rsquo;s <a href="http://www.infoq.com/news/2008/12/springone-2008">a related InfoQ article</a>.]</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/12/01/rod-johnsons-keynote-address-at-springone-americas-2008/">Rod Johnson&#8217;s Keynote Address at SpringOne Americas 2008</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-12-01T14:44:13-08:00" pubdate data-updated="true">Dec 1<span>st</span>, 2008</time>
        
         | <a href="/2008/12/01/rod-johnsons-keynote-address-at-springone-americas-2008/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m at SpringOne right now, and very much enjoying the <a href="http://www.diplomatresort.com/">Westin Diplomat</a>. My room is on the 21st floor and it overlooks the Atlantic. My balcony door is open and I can hear the waves crashing on the shore as I write. This is how life should always be. :&ndash;)</p>

<p>I attended Rod Johnson&rsquo;s keynote a couple of hours back. The keynote itself was informative, offering a pretty good glimpse into where SpringSource sees itself going over the coming year, and I had a chance to chat it up with Thomas Risberg and Colin Sampaleanu just a little bit since we were all sitting at the same table. Recognizing an opportunity when I see one, I asked them when they thought Spring 3 would be coming out and they laughed in a way that suggested that this wasn&rsquo;t the first time somebody had asked. Right now they&rsquo;re shooting for late March or thereabouts, though that was just their impression as opposed to a definite statement.</p>

<p>Anyway, here are some highlights from the keynote.</p>

<h3>SpringSource in 2008</h3>


<p>Rod started the keynote with some SpringSource efforts and accomplishments over 2008. I won&rsquo;t go into those in detail, but he mentioned several items, including</p>

<ul>
    <li><a href="http://www.springsource.org/webflow">Spring Web Flow 2.0</a> GA: I remember it well as I wrote <a href="http://wheelersoftware.com/articles/spring-web-flow-2.0.html">an article</a> about it just before the GA and I wanted to make sure that nothing important had changed.</li>
    <li><a href="http://static.springsource.org/spring-batch/">Spring Batch</a> GA</li>
    <li>Launched new <a href="http://www.springsource.org/spring-integration">Spring Integration</a> project</li>
    <li>Preparing for Spring 3.0 GA</li>
    <li><a href="http://www.springsource.com/products/suite/dmserver">SpringSource dm Server</a></li>
    <li><a href="http://www.regdeveloper.co.uk/2008/01/29/springsource_buys_covalent/">Covalent Technologies acquisition</a>: ten years supporting Apache HTTP server and leading support provider for Tomcat (which is important to SpringSource&#8217;s strategy, as I&#8217;ll describe below)</li>
    <li><a href="http://broadcast.oreilly.com/2008/11/springsource-getting-into-the.html">G2One acquisition</a>: Bringing Groovy and Grails into SpringSource</li>
    <li>Several commercial software releases, including the <a href="http://www.springsource.com/products/suite/sts">SpringSource Tool Suite</a>, <a href="http://www.springsource.com/products/suite/ams">SpringSource Application Management Suite</a> and the <a href="http://www.springsource.com/products/suite/apfororacledb">SpringSource Advanced Pack for Oracle</a>.</li>
</ul>


<p>They&rsquo;ve clearly been a busy company over the past year, but it may not be entirely clear what they&rsquo;re up to. (Well, part of it is clear enough&mdash;they&rsquo;re moving into the app server space.) The next part of the keynote explained where SpringSource is going as a company.</p>

<h3>SpringSource in 2009</h3>


<p>Rod noted that 2008 has been a tough year for the world economy in general, and thus one reasonable prediction is that that&rsquo;s going to translate into pressure on IT budgets. One development he expects to see is license costs coming under increased scrutiny. Another is that he thinks IT will begin paying more attention to the costs associated with complexity, and will invest more in reducing that complexity.</p>

<p>I know from my own workplace that his ideas here are correct. Even before news broke that everything&rsquo;s melting down, we were reevaluating our license situation and indeed even in some cases making changes. And one of the themes that our CIO has sounded time and time again is that we need to work to reduce complexity when we can. I suspect that these are common themes anyway, but with the tough economic times it&rsquo;s pretty easy to believe that one can build a business strategy around this, and that&rsquo;s what SpringSource is doing.</p>

<h3>The SpringSource strategy: help customers control costs by managing and reducing complexity</h3>


<p>This was really the theme of the keynote and Rod noted that they&rsquo;d even changed their tagline to reflect it: &ldquo;Weapons for the War on Java Complexity.&rdquo; He explained how the various efforts over 2008 are generally aligned with managing complexity on different fronts. For example:</p>

<p><b>Continue targeting complexity in development by expanding the Spring Framework in a way that simplifies application development.</b> Rod showed how with each new release of Spring, the SLOC for the pet store application dropped. He highlighted Spring Web MVC, Spring Web Flow and the acquisition of G2One in particular as representing a continued commitment to simplifying application development. Another notable item here includes Spring 2.5-style configuration via annotations.</p>

<p>Spring 3.0 moves the platform further along in this simplifying direction. Some highlights:</p>

<ul>
    <li>Spring 3.0 will support EL in XML configuration and in annotations. He didn&#8217;t say exactly where this would appear.</li>
    <li>Spring Web MVC will provide first-class support for RESTful web services. The match is strong (Spring Web MVC already has a @RequestMapping attribute that serves well here), and RESTful remoting is simpler than say SOAP-based web services.</li>
    <li>With Spring Web MVC, developers should adopt the annotated POJO model as Spring 3.0 will deprecate the Controller hierarchy and 3.1 will probably eliminate it altogether. Again the argument is that this is simpler than XML configuration.</li>
    <li>Spring Web Flow should be seen not as a niche technology but as a core part of their web framework that potentially applies any time there&#8217;s a directed navigation requirement. Examples include wizards, back button, refresh, multiple UIs, and UI reuse.</li>
    <li>Speaking of their web framework, they&#8217;re treating the following four projects as constituting a coherent, layered set: Spring Web MVC (the core), Spring JavaScript and Spring Web Flow (sitting on top of Spring Web MVC), and Spring Faces (sitting on top of the other three). He said that historically Spring hadn&#8217;t simplified web development as much as it could have, and their converging the four aforementioned web technologies into a single group is an effort to address this.</li>
</ul>


<p>Finally (we&rsquo;re still on the topic of managing complexity in development), Rod suggested that we take a look at <a href="http://static.springframework.org/spring/docs/2.5.x/api/org/springframework/beans/factory/annotation/Configurable.html">@Configurable</a> (which was available in Spring 2.0) and consider it a &ldquo;secret weapon&rdquo; against complexity.</p>

<p>The other major way in which SpringSource aims to manage/reduce complexity:</p>

<p><b>Target complexity not only in development but also in operations:</b> Though it&rsquo;s by no means unanimous, lots of people feel that Spring has done a pretty nice job of simplifying JEE development. Their idea is now to take that to the data center. Their commercial offerings align with this; for example, the Application Management Suite provides deep diagnostics for Spring-based applications, and the dm Server aims to make release management simpler and more flexible. Besides their commercial offerings, their investment in Covalent Technologies (better access to Apache and Tomcat expertise) represents a desire to strengthen their offering in hosting and operations.</p>

<p>They see Tomcat as being the platform of choice where WAR-based deployments are concerned, but they see server-side OSGi as the wave of the future. Because Tomcat is currently widely deployed (I think Rod said something like 70% of enterprises have deployed Tomcat?), SpringSource wants to be involved there, and that&rsquo;s why they bought Covalent. But at the same time they are trying to encourage their customers and indeed the industry at large to make the transition to OSGi-based deployment.</p>

<p>And this leads to a couple of announcements he made.</p>

<h3>A couple of product announcements</h3>


<p><b>tc Server:</b> The first announcement was that SpringSource will be releasing another server product to complement their current dm Server offering. This one is called tc Server for (you guessed it) Tomcat Server, and the idea is that it&rsquo;s an enhanced version of Tomcat, one that includes management functionality to make it &ldquo;ready for the data center.&rdquo; The AMS product comes with it, and it will provide features such as visibility into Tomcat and app performance stats, deadlock detection, heap and thread dumps, and stuff like that. It will also be possible to manage tc Server WAR deployments through AMS. They&rsquo;re expecting (if I understood correctly) a GA release in January 2009.</p>

<p>Rod emphasized that the Spring Framework itself would remain server-agnostic, despite the fact that SpringSource is a server vendor.</p>

<p><b>SpringSource Application Platform Configurator:</b> The second announcement is that SpringSource will be making available a web application called the SpringSource Application Platform Configurator. Again, managing complexity is the driver here. This time they are addressing the complexity associated with managing dependencies between JAR files, eliminating version conflicts, and that sort of thing. The idea is that you go to this app (which they host), and you specify a bunch of parameters such as the app type (web app, Grails, batch, etc.), whether you&rsquo;re OK with including pre-release software (such as milestone releases) or whether you allow only GAs, what sorts of capabilities you want and where your religious allegiances lie (is it OK to include JSF? is it OK to include Flex?), what hosting provider you&rsquo;re using (WebSphere, WebLogic, dm Server, etc.), what OS, etc. (By the way, they don&rsquo;t explicitly ask &ldquo;where are your religious allegiances,&rdquo; but Rod noted that they recognize this reality of how software is sometimes chosen and the configurator is designed accordingly.) Then at the end you register (free), get a text dump of the JARs you just chose, and get a dynamically-generated ZIP containing those JARs (and they&rsquo;re of course mutually consistent so as to avoid versioning conflicts). That&rsquo;s a cool idea. They don&rsquo;t know though when this will be available for use; it&rsquo;s not even in beta yet.</p>

<p>Well, there you have it. If you weren&rsquo;t at the keynote, now it&rsquo;s as if you were.  :&ndash;)</p>

<p>I&rsquo;ll post more as the conference progresses. Here&rsquo;s <a href="http://greybeardedgeek.net/?p=66">another post</a> on the same keynote.</p>

<p>[Update: Here&rsquo;s <a href="http://www.infoq.com/news/2008/12/springone-2008">a related InfoQ article</a>.]</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/11/27/springone-americas-2008/">SpringOne Americas 2008</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-27T15:37:58-08:00" pubdate data-updated="true">Nov 27<span>th</span>, 2008</time>
        
         | <a href="/2008/11/27/springone-americas-2008/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ll be at <a href="http://americas.springone.com/conference/hollywood/2008/12/index.html">SpringOne Americas 2008</a> this week. Check this space for information about the conference as it unfolds.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/11/25/publish-an-rss-feed-with-spring-3-0/">Publish an RSS Feed With Spring 3.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-25T06:27:00-08:00" pubdate data-updated="true">Nov 25<span>th</span>, 2008</time>
        
         | <a href="/2008/11/25/publish-an-rss-feed-with-spring-3-0/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>At the time of this writing, Spring 3.0 isn&rsquo;t out yet, but that doesn&rsquo;t mean we can&rsquo;t start goofing around with the <a href="http://static.springframework.org/downloads/nightly/snapshot-download.php?project=SPR">nightly snapshots</a>. I&rsquo;ve been doing just that, and in this article I&rsquo;ll show you how to publish an RSS feed using the new <code>AbstractRssFeedView</code> class from Spring 3.0.</p>

<p>Those familiar with <a href="https://springmodules.dev.java.net/">Spring Modules</a> might recognize our view class. It began life as <code>AbstractRssView</code> in the Spring Modules project. But as of Spring 3.0, it&rsquo;s now a first-class member of the framework (though it&rsquo;s been renamed to <code>AbstractRssFeedView</code>), along with the <code>AbstractAtomFeedView</code> class for Atom feeds, and the <code>AbstractFeedView</code>, which serves as a base class for both. The new classes, like the old one, are based on Sun&rsquo;s <a href="https://rome.dev.java.net/">ROME API</a>.</p>

<p>You&rsquo;ll need to know Spring Web MVC to get the most out of this article. In particular, you&rsquo;ll need to understand the relationship between controllers and views, which in a nutshell is this: when a controller is done processing a request, it returns a logical view name that a view resolver subsequently maps to a view.</p>

<p>Without further ado, let&rsquo;s look at some code.</p>

<h3>The controller</h3>


<p>Let&rsquo;s start with the controller, since processing starts there, and since that&rsquo;s probably more familiar to more readers than implementing views. Here&rsquo;s a pretty basic controller for a news feed.</p>

<pre>package rssdemo.web;

import javax.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Required;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import rssdemo.model.NewsItem;
import rssdemo.service.NewsService;

@Controller
public final class NewsController {
    private NewsService newsService;
    private String rssNewsFeedView;
    
    @Required
    public void setNewsService(NewsService newsService) {
        this.newsService = newsService;
    }
    
    @Required
    public void setRssNewsFeedView(String rssNewsFeedView) {
        this.rssNewsFeedView = rssNewsFeedView;
    }
    
    @RequestMapping("/news.rss")
    public String rss(HttpServletResponse res, Model model) {
        List&lt;NewsItem&gt; newsItems = newsService.getAllNewsItems();
        model.addAttribute(newsItems);                                     // 1
        return rssNewsFeedView;                                            // 2
    }
}
</pre>


<p>As you can see, this controller really is as simple as I said it would be. Our <code>rss()</code> method grabs a list of <code>NewsItem</code>s from the <code>NewsService</code> <span class="cueball">1</span> and places it on the <code>Model</code> under a conventionally-generated key, which in this case would be <code>newsItemList</code>. Then we simply return an injected logical view name <span class="cueball">2</span>, which we&rsquo;re going to map to an actual view shortly. (We inject the view name to maintain the separation between the controller and the view.)</p>

<p>Now let&rsquo;s check out the star of the show, which would be our view.</p>

<h3>The view, via Spring 3.0&#8217;s new AbstractRssFeedView</h3>


<p>Now we come to the meat of the subject. Here we&rsquo;re going to implement a Spring Web MVC view by extending Spring 3.0&rsquo;s new <code>AbstractRssFeedView</code> class and by using ROME to model our news feed. Once we have the view in place, we&rsquo;ll be ready to configure the mapping from the logical view name we set in the controller to the view.</p>

<p>The next listing what&rsquo;s involved in implementing a view for an RSS feed. If you&rsquo;re doing an Atom feed, the approach is entirely analogous, but you would just need to extend <code>AbstractAtomFeedView</code> instead of <code>AbstractRssFeedView</code>.</p>

<pre>package rssdemo.web;

import java.util.*;
import javax.servlet.http.*;
import org.springframework.beans.factory.annotation.Required;
import org.springframework.web.servlet.view.feed.AbstractRssFeedView;
import com.sun.syndication.feed.rss.Channel;
import com.sun.syndication.feed.rss.Description;
import com.sun.syndication.feed.rss.Item;
import rssdemo.model.NewsItem;

public final class RssNewsFeedView extends AbstractRssFeedView {           // 1
    private String feedTitle;                                              // 2
    private String feedDesc;
    private String feedLink;
    
    @Required
    public void setFeedTitle(String feedTitle) {
        this.feedTitle = feedTitle;
    }
    
    @Required
    public void setFeedDescription(String feedDesc) {
        this.feedDesc = feedDesc;
    }
    
    @Required
    public void setFeedLink(String feedLink) {
        this.feedLink = feedLink;
    }

    @Override
    protected void buildFeedMetadata(
            Map model, Channel feed, HttpServletRequest request) {         // 3
        
        feed.setTitle(feedTitle);
        feed.setDescription(feedDesc);
        feed.setLink(feedLink);
    }
    
    @Override
    protected List&lt;Item&gt; buildFeedItems(
            Map model,
            HttpServletRequest request,
            HttpServletResponse response)
        throws Exception {                                                 // 4
        
        @SuppressWarnings("unchecked")
        List&lt;NewsItem&gt; newsItems =
            (List&lt;NewsItem&gt;) model.get("newsItemList");                    // 5
        
        List&lt;Item&gt; feedItems = new ArrayList&lt;Item&gt;();
        for (NewsItem newsItem : newsItems) {                              // 6
            Item feedItem = new Item();
            feedItem.setTitle(newsItem.getTitle());
            feedItem.setAuthor(newsItem.getAuthor());
            feedItem.setPubDate(newsItem.getDatePublished());
            
            Description desc = new Description();
            desc.setType("text/html");
            desc.setValue(newsItem.getDescription());
            feedItem.setDescription(desc);
            
            feedItem.setLink(newsItem.getLink());
            feedItems.add(feedItem);
        }
        
        return feedItems;
    }
}</pre>


<p>So what&rsquo;s going on here? Well, we begin by extending the <code>AbstractRssFeedView</code> class <span class="cueball">1</span>. Then we include some injected fields for feed metadata <span class="cueball">2</span>. We use these in the optional <code>buildFeedMetadata()</code> method <span class="cueball">3</span>. I say &ldquo;optional&rdquo; because the <code>AbstractRssFeedView</code> provides a dummy implementation (actually, its superclass <code>AbstractFeedView</code> provides it).</p>

<p>The method we&rsquo;re required to implement is <code>buildFeedItems()</code> <span class="cueball">4</span>. Here&rsquo;s where we map our list of domain objects (here, a list of <code>NewsItem</code> objects that are just something we cooked up ourselves) to the ROME API, which provides a structure for modeling feeds. We begin by grabbing the <code>NewsItem</code> list off the model (recall from listing 1 that we placed the list on the model in the controller) <span class="cueball">5</span>. Then we iterate over the <code>NewsItem</code> list, mapping each one to a ROME <code>Item</code> <span class="cueball">6</span>.</p>

<p>That should be pretty straightforward-looking. And we&rsquo;re almost done. There&rsquo;s just one part that remains, and that&rsquo;s establishing the mapping between the logical view name we return from the controller and the <code>RssNewsFeedView</code> that we just created. We do that in the application context.</p>

<h3>Configure the view resolver for your RSS feed</h3>


<p>The last thing we need to take care of is configuring up the right view resolver in our application context. We can&rsquo;t use the standard <code>InternalResourceViewResolver</code> here because we&rsquo;re not mapping to a URL; instead we want to map to a view (namely, the <code>RssNewsFeedView</code> that we just created) and we want that view to handle generating the output directly.</p>

<p>The simplest approach here is to use something called the <code>BeanNameViewResolver</code>. The idea with this type of resolver is quite simple. Whenever a controller returns a logical view name, the <code>BeanNameViewResolver</code> will attempt to find a bean on the application context with the same name (or ID). If there&rsquo;s a match, then it interprets that bean as the mapped view. Otherwise, the other resolvers are given their shot at matching the view name.</p>

<p>To add a <code>BeanNameViewResolver</code>, all we need to add is this:</p>

<pre>&lt;bean class="org.springframework.web.servlet.view.BeanNameViewResolver"/&gt;</pre>


<p>We also need to inject the view name into our controller, as we saw in listing 1. Here&rsquo;s how we can do that:</p>

<pre>&lt;bean class="rssdemo.web.NewsController"
    p:newsService-ref="newsService"
    p:rssNewsFeedView="rssNewsFeedView"/&gt;</pre>


<p>We just chose the name <code>rssNewsFeedView</code> more or less arbitrarily; we could have chosen anything. It&rsquo;s good to choose something accurate and descriptive just to keep things clear and the minimize the chance of a mapping conflict, since the name you choose is going to be a bean name. Speaking of which, we&rsquo;ll need to put our view on the app context too:</p>

<pre>&lt;bean id="rssNewsFeedView"
    class="rssdemo.web.RssNewsFeedView"
    p:feedTitle="Ye Olde Cigar Shoppe"
    p:feedDescription="Latest and greatest news about cigars"
    p:feedLink="http://yeoldecigarshoppe.com/"/&gt;</pre>


<p>And there you have it! When the <code>DispatcherServlet</code> gets a request for the RSS feed, it will run the controller method and then grab the resulting view name, which we&rsquo;ve configured to be <code>rssNewsFeedView</code>. Then the <code>BeanNameViewResolver</code> will find the corresponding view bean on the app context&mdash;in this case our <code>RssNewsFeedView</code>&mdash;and the view bean will finish up the request as required. All in all a nice, clean way of handling feed publication.</p>

<p><span class="icon stickyNote">Post migrated from my Wheeler Software site.</span></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/11/15/aop-101-speeding-up-springs-javamailsenderimpl-with-aop/">AOP 101: Speeding Up Spring&#8217;s JavaMailSenderImpl With AOP</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-15T10:40:35-08:00" pubdate data-updated="true">Nov 15<span>th</span>, 2008</time>
        
         | <a href="/2008/11/15/aop-101-speeding-up-springs-javamailsenderimpl-with-aop/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="alert info">This material is based on an earlier version of <a href="http://www.manning.com/wheeler/">Spring in Practice, chapter 8</a>&mdash;one that predates the <code>@Async</code> annotation. Nowadays I would recommend using <code>@Async</code> and the Spring Task Execution API for making JavaMail calls asynchonous. The book covers the newer approach. The material in this post is still useful for understanding what you can do with AOP though.</div>


<p>In this article we&rsquo;ll learn how we can speed up Spring&rsquo;s <code>JavaMailSenderImpl</code> with some thread-forking AOP. Though we&rsquo;re using JavaMail as an example, this tutorial should be useful to people looking for a code-based introduction to Spring&rsquo;s support for AOP. Note at the outset that I don&rsquo;t really go into AOP concepts and terminology, but I do show some simple code that you should be able to follow if you already know the basic concepts and just want to see what the code looks like.</p>

<p>There are lots of situations in which we want our application to send out an automated e-mail. You might for instance want to send a confirmation e-mail in response to new user registrations or mailing list subscriptions and unsubscriptions. In Spring this probably means that you would use one of the various <code>JavaMailSenderImpl.send()</code> methods. Here&rsquo;s a sample <code>applicationContext.xml</code> file.</p>

<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:jee="http://www.springframework.org/schema/jee"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
        http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.5.xsd&gt;
    
    &lt;jee:jndi-lookup id="mailSession" jndi-name="mail/Session" resource-ref="true"/&gt;
    
    &lt;bean id="mailSender"
        class="org.springframework.mail.javamail.JavaMailSenderImpl"
        p:session-ref="mailSession"/&gt;
    
    &lt;bean id="mailingListService"
        class="app.service.MailingListServiceImpl"
        p:mailSender-ref="mailSender"/&gt;
        
    ...
    
&lt;/beans&gt;</pre>


<p>Here&rsquo;s how it looks from the Java side:</p>

<pre>package app.service;

... imports ...

public class MailingListServiceImpl implements MailingListService {
    private JavaMailSender mailSender;
    
    public void setMailSender(JavaMailSender mailSender) {
        this.mailSender = mailSender;
    }
    
    private void sendConfirmSubscriptionEmail(Subscriber subscriber) {
        MimeMessage message = mailSender.createMimeMessage();
        MimeMessageHelper helper = new MimeMessageHelper(message);
        
        String text = ...
        
        try {
            helper.setSubject("Please confirm your subscription");
            helper.setTo(subscriber.getEmail());
            helper.setFrom(noReplyEmailAddress);
            helper.setSentDate(subscriber.getDateCreated());
            helper.setText(text, true);
        } catch (MessagingException e) {
            throw new RuntimeException(e);
        }
        
        mailSender.send(message);
    }
    
    ...
}</pre>


<p>(For more information on Spring/JavaMail integration, please see my article <a href="#">Send E-mail Using Spring and JavaMail</a>.)</p>

<p>This works fine, but one thing your end users might notice is a fairly significant delay while <code>JavaMailSenderImpl.send()</code> does whatever it&rsquo;s doing to send your e-mail (presumably <a href="http://springinpractice.com/2008/05/05/smtp-and-smtp-auth/">negotiating with the SMTP server and sending the actual e-mail</a>). While the delay probably isn&rsquo;t large enough to provoke rioting in the streets, it&rsquo;s certainly noticeable, and in many use cases it&rsquo;s unnecessary. E-mail is itself an asynchronous communications medium, so unless there&rsquo;s an important reason to let the end user know about errors that may occur while trying to send the e-mail (and there may be), one option you might consider is making the <code>send()</code> call on a separate thread.</p>

<p>Now let&rsquo;s look at a few different ways to do that.</p>

<h3>Method 1: Spawn a new thread manually</h3>


<p>One possibility would be to spawn a new thread manually whenever you want to call <code>JavaMailSenderImpl.send()</code>. In other words, you implement the <code>Runnable</code> interface with a call to <code>send()</code>, you pass it into a <code>Thread</code>, and then you start the thread.</p>

<p>This technique has some advantages. It&rsquo;s conceptually straightforward. Also it&rsquo;s easy to be selective about the cases in which you do and don&rsquo;t want to fork. Again, there may well be times where you want the end user to know if the <code>send()</code> call generated an exception, and if that&rsquo;s true, then you simply refrain from forking the thread.</p>

<p>If you&rsquo;re not careful, the approach can lead to widespread violation of the <a href="http://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY principle</a>. You might end up rewriting the same thread-forking code every time you send an e-mail. You can of course control this by creating one or more utility methods to send an e-mail on a separate thread, and that is a good approach.</p>

<p>One drawback with this approach, though, is that it may be either inconvenient or else a non-option. If you have an existing app with lots of calls to create e-mail, then you&rsquo;d need to update all the instances of that code with the new code. In most cases that&rsquo;s probably doable though it may be inconvenient. But it may be that you&rsquo;re not in a position to change the client code. (Maybe it&rsquo;s a third-party library, for instance.) The client code calls an injected <code>JavaMailSender</code> instance, say, and that&rsquo;s the way it is. In that event you&rsquo;ll want to consider one of the two following alternative methods.</p>

<h3>Method 2: Create a JavaMailSender wrapper</h3>


<p>Another method would be to implement a <code>JavaMailSender</code> wrapper. (<code>JavaMailSender</code> is of course the interface to which <code>JavaMailSenderImpl</code> conforms.) The <code>JavaMailSender</code> interface has six different <code>send()</code> methods (<a href="http://static.springframework.org/spring/docs/2.5.6/api/org/springframework/mail/javamail/JavaMailSender.html">here are the Javadocs</a>), and so you can just implement the thread-forking code for each of the six methods. (Probably each method would create a <code>Runnable</code> and then pass that to a thread-forking utility method.) Then you inject your wrapper into your service beans instead of injecting the <code>JavaMailSenderImpl</code> bean directly.</p>

<p>This approach is pretty good. It&rsquo;s still straightforward, and it allows you to avoid violating DRY. Also, because it&rsquo;s entirely transparent to client code, it can deal with cases in which you either can&rsquo;t or else don&rsquo;t want to modify said client code.</p>

<p>One possible challenge is that you may find it a little tough to exercise fine-grained control over the cases in which you use the wrapper and the cases in which you don&rsquo;t. If it&rsquo;s important for your code to exercise that kind of control, then arguably it would be reasonable to associate the forking/non-forking semantics injected <code>JavaMailSender</code> beans. You might for example inject two <code>JavaMailSender</code> instances into the service bean&mdash;one forking and one non-forking.</p>

<p>A minor grumble about the wrapper method is that it ties the thread-forking behavior to specific interfaces, such as <code>JavaMailSender</code>. That&rsquo;s not too big a deal in this particular case, since it&rsquo;s not such a problem to spawn a new thread. But if you have other cases where you decide you want to create a new thread, you might decide that you&rsquo;d like to factor thread-forking out as a separate behavior and be able to apply that in multiple contexts.</p>

<p>So let&rsquo;s see how to do that using Spring&rsquo;s support for AspectJ-flavored AOP.</p>

<h3>Method 3: Use AOP to wrap JavaMailSenderImpl.send()</h3>


<p>This is a fun and elegant method. Even though this article is called &ldquo;AOP 101&rdquo;, I&rsquo;m not planning to explain the concepts or weird terminology; rather I just want to show you the code and assume that you&rsquo;ll be able to see what&rsquo;s happening.</p>

<p>First we need to create an &ldquo;advice&rdquo; class. This is the code that we&rsquo;re going to wrap around our <code>send()</code> invocations.</p>

<pre>package app.aop;

import org.apache.log4j.Logger;
import org.aspectj.lang.ProceedingJoinPoint;

public class ForkAdvice {
    private static final Logger log = Logger.getLogger(ForkAdvice.class);
    
    public void fork(final ProceedingJoinPoint pjp) {
        new Thread(new Runnable() {
            public void run() {
                log.info("Forking method execution: " + pjp);
                try {
                    pjp.proceed();
                } catch (Throwable t) {
                    // All we can do is log the error.
                    log.error(t);
                }
            }
        }).start();
    }
}</pre>


<p>The fork method is &ldquo;around&rdquo; advice that we&rsquo;re going to use to advise our calls to <code>JavaMailSenderImpl.send()</code>. As you can see, it creates a new thread and starts it. In the <code>run()</code> body, we simply execute the advised method by calling <code>pjp.proceed()</code>.</p>

<p>As an aside, the <code>ProceedingJoinPoint</code> class is provided by the AspectJ class library, but note that we&rsquo;re not using full-blown AspectJ here&mdash;we&rsquo;re in fact using Spring AOP. Full AspectJ involves a special aspect language and compiler to generate classes with the advice woven into the class bytecode itself. Spring AOP on the other hand uses dynamic proxies (either the interface variety that comes with Java, or else class proxies via CGLIB) to advise classes. While Spring AOP borrows classes and also the AspectJ pointcut language from AspectJ, its use of dynamic (runtime) proxies as opposed to bytecode-level advice integration distinguishes it from AspectJ.</p>

<p>Now it&rsquo;s time to update our application context with our AOP configuration.</p>

<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:aop="http://www.springframework.org/schema/aop"
    xmlns:jee="http://www.springframework.org/schema/jee"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
        http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.5.xsd&gt;
    
    &lt;jee:jndi-lookup id="mailSession" jndi-name="mail/Session" resource-ref="true"/&gt;
    
    &lt;bean id="mailSender"
        class="org.springframework.mail.javamail.JavaMailSenderImpl"
        p:session-ref="mailSession"/&gt;
    
    &lt;bean id="mailingListService"
        class="app.service.MailingListServiceImpl"
        p:mailSender-ref="mailSender"/&gt;
        
    &lt;bean id="forkAdvice" class="app.aop.ForkAdvice"/&gt;
    
    &lt;aop:config&gt;
        &lt;aop:aspect ref="forkAdvice"&gt;
            &lt;aop:around method="fork"
pointcut="execution(* org.springframework.mail.javamail.JavaMailSenderImpl.send(..))"/&gt;
        &lt;/aop:aspect&gt;
    &lt;/aop:config&gt;
    
    ...
    
&lt;/beans&gt;</pre>


<p>This is similar to what we had before, but there are a couple of differences. First, note that we&rsquo;ve declared the <code>aop</code> namespace here. That of course allows us to use the namespace configuration feature that Spring 2.0 introduced. The other change is that we&rsquo;ve added a definition for our advice bean as well as some AOP configuration. In <code>aop:aspect</code> we point to our <code>forkAdvice</code> as the advising class to be applied, we indicate that it will be &ldquo;around&rdquo; advice, we specify the advising method, and finally we specify a pointcut that indicates which method calls will be advised/wrapped. We use the <a href="http://www.eclipse.org/aspectj/doc/released/progguide/semantics-pointcuts.html">AspectJ pointcut language</a> to specify a pointcut. Here we&rsquo;re indicating that we want all calls to any of the <code>JavaMailSenderImpl.send()</code> methods to be advised.</p>

<p>As mentioned previously, this technique is like the wrapper technique in that you can use it to add the forking behavior in a way that&rsquo;s transparent to client code. Moreover you can use it not just for JavaMail but really for any method where you want to create a new thread before executing the method. You just add the appropriate <code>aop:around</code> definitions to the <code>aop:aspect</code> definition and you&rsquo;re in business.</p>

<div class="endnote">Post migrated from my Wheeler Software site.</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/10/27/spring-paranoia-with-initializingbean-and-assert/">Spring Paranoia With InitializingBean and Assert</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-27T07:51:40-07:00" pubdate data-updated="true">Oct 27<span>th</span>, 2008</time>
        
         | <a href="/2008/10/27/spring-paranoia-with-initializingbean-and-assert/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this quick post, I&rsquo;m going to show you how to use the <code>InitializingBean</code> interface and the <code>Assert</code> utility class, both part of the Spring Framework, to express any deep-seated feelings of initialization paranoia you may have.</p>

<p>Let&rsquo;s just jump right in with a code example.</p>

<pre>package com.example.user.service;

import org.springframework.beans.factory.InitializingBean;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.util.Assert;

import com.example.user.dao.UserDao;

public class UserServiceImpl implements UserService, InitializingBean {
    private UserDao userDao;
    private JavaMailSender mailSender;

    public void setUserDao(UserDao userDao) {
        Assert.notNull(userDao, "userDao can't be null"); // 1
        this.userDao = userDao;
    }

    public void setMailSender(JavaMailSender mailSender) {
        Assert.notNull(mailSender, "mailSender can't be null"); // 2
        this.mailSender = mailSender;
    }

    public void afterPropertiesSet() {
        Assert.notNull(userDao, "userDao required"); // 3
        Assert.notNull(mailSender, "mailSender required");
    }

    ...service methods...
}</pre>


<p>In the example above, we have a hypothetical user service with two dependencies: a DAO and a mail sender. The idea here is that we want to do some sanity checks as we initialize our service bean. First, when setting the user DAO, we want to make sure that we don&rsquo;t set it to a null value <span class="cueball">1</span>. We conduct the same test for the mail sender <span class="cueball">2</span>. In each case we use the Spring <code>Assert</code> utility class to perform the test. (Be sure not to confuse this with the <code>assert</code> keyword from the Java language, or the JUnit class of the same name.)</p>

<p>Finally, we implement the single method required by the <code>InitializingBean</code> interface, <code>afterPropertiesSet</code>. Here we check to see that all required properties have actually been set <span class="cueball">3</span>. If they haven&rsquo;t, then Spring complains. Compliant <code>BeanFactory</code> implementations call the <code>afterPropertiesSet</code> method as part of the standard bean lifecycle; see the <a href="http://static.springframework.org/spring/docs/2.5.5/api/org/springframework/beans/factory/BeanFactory.html">BeanFactory Javadocs</a> for more information.</p>

<p>This technique is handy for being sure that your dependency injections actually happen. This is especially useful when using autowiring, where it&rsquo;s easy to miss the fact that some required injection didn&rsquo;t actually occur.</p>

<p>You can use <code>InitializingBean</code> and <code>Assert</code> for any Spring-managed bean, not just service beans. I&rsquo;ve just used a service bean here as an example.</p>

<p>Obviously, if you use the <code>InitializingBean</code> interface then you tie your bean APIs to the Spring Framework. You&rsquo;ll have to decide whether that&rsquo;s something you can live with. With <code>Assert</code>, on the other hand, you&rsquo;re only building in an implementation dependency on Spring, which is less objectionable. (It may still be a minor nuisance if you were to decide to move away from Spring, but nothing you couldn&rsquo;t easily handle. I&rsquo;d probably say the same thing of using <code>InitializingBean</code> in this case, incidentally.)</p>

<p>Anyway, now you know the pros and cons of the approach. Have fun!</p>

<p><span class="icon stickyNote">Post migrated from my Wheeler Software site.</span></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Concurrent Programming for Practicing Software Engineers, Part 3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-15T09:06:02-07:00" pubdate data-updated="true">Oct 15<span>th</span>, 2008</time>
        
         | <a href="/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="intro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Part 3</a></span>
</div>


<p>This third and final post in our series on concurrency explains how synchronization mistakes can lead to the problem of deadlocks, and what you can do to minimize or eliminate them.</p>

<h3>How synchronization gives rise to deadlocks</h3>


<p>We saw in the <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">previous post</a> how a thread will grab a lock just before entering a critical section, thereby forcing other threads to &ldquo;block&rdquo; (concurrency lingo for &ldquo;wait for another thread to release a lock&rdquo;) until they can acquire the lock. Normally this blocking behavior is unremarkable. It is a standard part of concurrent programming since we&rsquo;re trying to protect data from data races.</p>

<p>If there&rsquo;s too much contention for locks, that can of course have a negative effect on performance since threads are sitting around waiting instead of doing work. But usually this just means subpar performance rather than hanging.</p>

<p>The pathological case of contention for locks is <em>deadlocking</em>. This is characterized by two or more threads becoming permanently hung. They are notoriously difficult to predict, avoid and handle, but it&rsquo;s not impossible. The secret to understanding deadlocks is to understand that they arise when threads wait for each other to release a lock in a cyclic fashion. The simplest case would be thread T<sub>1</sub> waiting for T<sub>2</sub> to release a lock, and T<sub>2</sub> waiting for T<sub>1</sub> to release a lock. Neither one can make forward progress. The next simplest case is T<sub>1</sub> waiting for T<sub>2</sub>, T<sub>2</sub> waiting for T<sub>3</sub>, and T<sub>3</sub> waiting for T<sub>1</sub>. Now we have three deadlocked threads. Obviously the cycle can be of arbitrary length; all threads involved will be deadlocked.</p>

<p>Here&rsquo;s a diagram that shows how it works:</p>

<div style="margin: 20px auto; width: 584px;">
    <div><img src="http://wheelersoftware.s3.amazonaws.com/articles/concurrent-programming/deadlocks.jpg" alt="The cyclic nature of deadlocks" /></div>
    <div class="caption"><span class="figure-label">Figure 1.</span> Deadlocks arise from circular dependencies between threads.</div>
</div>


<p>In figure 1, you can see that each thread holds the lock needed by the preceding thread. As the dependencies are circular, there is no way for any of the threads to make forward progress once something like the above happens. All five threads are hung&mdash;that is, deadlocked.</p>

<div style="margin-right: 10px; float: left">
    <div><img src="http://wheelersoftware.s3.amazonaws.com/articles/concurrent-programming/vambrace-m16.jpg" alt="" /></div>
    <div class="photo-caption" style="text-align: center">Photo credit: <a href="http://www.flickr.com/photos/gladius/2296372699/">gladius</a></div>
</div>




<h4>A furry aside</h4>


<p>By now you might understand what I meant at the beginning of the article when I said that concurrent programming is kind of like an arms race. We start with single threads, but sometimes that&rsquo;s too slow, so we introduce multithreading. That causes a problem though, which is that the threads can interfere with one another when working with shared data. So we introduce turn-taking through mutexes (and through the <code>synchronized</code> keyword in particular). But that has the effect of limiting parallelism, and if we take that too far, we can end up sacrificing the parallelism (and performance) that we sought in the first place. In the most extreme case, we can inadvertently cause threads to deadlock.</p>

<p>(Maybe <a href="http://en.wikipedia.org/wiki/Whac-a-mole">Whac-A-Mole</a> is a better metaphor. That&rsquo;s OK. I&rsquo;m going to stick with arms race just because I really like the mech/cyber photo. Think of it as an arms race between software engineers and small furry rodents.)</p>

<div style="clear: both"></div>


<p>Now let&rsquo;s consider an example of code vulnerable to deadlocks.</p>

<h4>Some deadlocky code</h4>


<p>For this one we&rsquo;re going to use the standard bank account funds transfer example. Yes, it&rsquo;s a clich&egrave;d example, but it&rsquo;s such a good example and originality is overrated anyway. Here&rsquo;s listing 3:</p>

<div>
    <div><span class="code-listing">Listing 3.</span> A deadlock just waiting to happen</div>
        <pre>public void transferFunds(Account from, Account to, Money amount) {
    synchronized (from) {
        synchronized (to) {
            from.decreaseBy(amount);
            to.increaseBy(amount);
        }
    }
}</pre>
</div>


<p>(We&rsquo;ll ignore exceptional conditions such as insufficient funds. Or, if you like, assume that <code>decreaseBy()</code> throws an unchecked <code>InsufficientFundsException</code>.)</p>

<p>If it isn&rsquo;t obvious, the method is a service method that transfers funds from one account to another account. Before going further, take a look at the code and see if you can figure out how the deadlock can occur. Keep in mind what we said about cyclic dependencies.</p>

<h4>Here&#8217;s how a deadlock can occur</h4>


<p>Recall from the discussion above that deadlocks involve multiple threads. Each one grabs a lock that one of the other threads needs, and needs a lock that one of the other threads has. Here, we have two <code>synchronized</code> blocks, and each entry point corresponds to a place where a thread will try to grab a lock, maybe successfully and maybe not.</p>

<p>With that information it&rsquo;s straightforward to construct the sequence of events that leads to the deadlock:</p>

<ol>

<li>Thread T<sub>1</sub> enters the method, with the source account being account 4 and the destination account being account 14. T<sub>1</sub> is able to acquire the lock for account 4, but then there&#8217;s a context switch before it can enter the second <code>synchronized</code> block.</li>

<li>Thread T<sub>2</sub> also enters the method, with the source account being account 14 and the destination account being account 4. T<sub>2</sub> is able to acquire the lock for account 14, but then gets blocked when trying to acquire the lock for account 4. That stands to reason, since T<sub>1</sub> has it. Context switch.</li>

<li>T<sub>1</sub> tries to grab the lock for account 14, but of course it can&#8217;t since T<sub>2</sub> has it. Threads T<sub>1</sub> and T<sub>2</sub> are now deadlocked.</li>

</ol>


<p>That&rsquo;s a fairly intricate bit of logic, and developers new to concurrent programming may wonder how in the heck they are supposed to anticipate problems like that. They may also wonder whether this series of events is so implausible that is just isn&rsquo;t worth worrying about. To answer the second concern first, deadlocks most certainly do occur in real code. Keep in mind that although the situations that produce them may be implausible, the problem is that CPU clock speeds are pretty incredible, and so things that seem implausible suddenly become just a matter of time.</p>

<p>As to how to defend against deadlocks, we&rsquo;ll look at that right now.</p>

<h3>Solving deadlocks with globally-defined lock orderings</h3>


<p>There are different ways to either minimize the likelihood of deadlocking or else just avoid it altogether. One best practice is to minimize the scope of your critical sections so as to decrease the time that threads hang onto locks, and hence to decrease the likelihood of a deadlock. That however doesn&rsquo;t solve the issue; deadlocks can still occur.</p>

<p>Another technique is to avoid the sort of nested locking that we saw in the example in the previous page. Instead of locking each account individually, we might define a single lock that any thread must acquire before doing a transfer. While this does indeed eliminate deadlocks, it does so at a very steep cost: acquiring the single lock becomes a bottleneck, and limits the parallelism we&rsquo;re trying to achieve in the first place. It does not scale.</p>

<p>A third technique is to use timeouts. Under this approach, if any thread is blocked for a sufficiently lengthy period of time, it just gives up.</p>

<p>Those are all legitimate techniques, but in this section we&rsquo;ll discuss global lock orders.</p>

<h4>What is a globally-defined lock order?</h4>


<p>Recall in our discussion of deadlocks that they arise from circular dependencies between the threads. Any given thread depends on a resource (a lock) that the previous thread in the ring holds. So one way to stamp out deadlocks is to define a global ordering on the locks so that such cycles can never arise. In other words, you define and publish rules around which locks to acquire before which other locks. This approach requires significant discipline from developers since there isn&rsquo;t any automatic way to enforce it. It is however extremely useful since it makes deadlocks impossible.</p>

<p>Let&rsquo;s see how we might apply a global lock order to the funds transfer example.</p>

<h4>The funds transfer example reconsidered</h4>


<p>At first glance you might think, &ldquo;Wait a minute. The source account&rsquo;s lock is always grabbed before the destination account&rsquo;s lock, so how is it possible for a deadlock to occur?&rdquo; But upon closer examination it&rsquo;s clear that that&rsquo;s not a correct analysis. Whatever global lock order we define needs to translate ultimately down to instances, not roles in a transaction. Sometimes account 4 will be the source account, and sometimes it will be the destination account. Similarly for account 14. Whatever global lock order we define needs to handle that.</p>

<p>One straightforward way to define a lock order for our current example would be to say that we always grab the lock for the account with the lower ID first. Listing 4 shows the new code:</p>

<div>
    <div><span class="code-listing">Listing 4.</span> Applying a globally-defined lock order</div>
    <pre>public void transferFunds(Account from, Account to, Money amount) {
    long fromId = from.getId();
    long toId = to.getId();
    long lowId = (fromId &lt; toId ? fromId : toId);
    long highId = (fromId &lt; toId ? toId : fromId);
    synchronized (lowId) {
        synchronized (highId) {
            from.decreaseBy(amount);
            to.increaseBy(amount);
        }
    }
}</pre>
</div>


<p>The code above is deadlock-free, because cyclic dependencies are impossible. Say thread T<sub>1</sub> wants to transfer funds from account 4 to account 14, and thread T<sub>2</sub> wants to transfer funds from account 14 to account 4. Both threads will try to grab the lock for account 4 before trying to grab the lock for account 14. Thus it&rsquo;s impossible to wait for the lock on account 4 while holding the lock for account 14, at least as long as all code observes the same globally-defined lock ordering that we&rsquo;ve observed here. (Hence &ldquo;global&rdquo;.)</p>

<h3>Conclusion and recommended readings</h3>


<p>In this series we looked at several key areas of concurrent programming that (in my opinion, anyway) all practicing software developers should understand. As regards concurrency, there is a gap between what typical developers <em>should</em> know and what they <em>actually</em> know, and that causes real-world production issues on a regular basis. I wrote this series to try to narrow that gap.</p>

<p>There are of course lots of good resources for concurrent programming. Here are some of my favorites:</p>

<ul class="square">

<li><a href="http://www.infoq.com/presentations/goetz-concurrency-past-present">Concurrency: Past and Present</a>, by Brian Goetz: An entertaining presentation on concurrency. Goetz is a well-known authority on concurrent programming.</li>

<li><a href="http://jcip.net/">Java Concurrency in Practice</a>, by Brian Goetz. A really great and approachable book.</li>

<li><a href="http://www.amazon.com/Concurrent-Programming-Java-TM-Principles/dp/0201310090">Concurrent Programming in Java(TM): Design Principles and Pattern (2nd Edition)</a>, by Doug Lea. Another great book on concurrency; probably the standard. More academic than the Goetz book but still quite approachable.</li>

<li><a href="http://sunnyday.mit.edu/papers/therac.pdf">The Therac-25 Accidents</a>: A classic software engineering paper on how race conditions actually injured and killed people. The basic idea is that the Therac-25 machine, which was designed to administer radiation to cancer patients, was vulnerable to race conditions that occurred as the human operator became more experienced with operating the machine (and thus keyboarded commands more quickly). The race conditions led to massive radiation overdoses. Long but well worth the read.</li>

</ul>




<div class="outro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Part 3</a></span>
</div>




<div class="endnote">Post migrated from my Wheeler Software site.</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Concurrent Programming for Practicing Software Engineers, Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-14T08:44:32-07:00" pubdate data-updated="true">Oct 14<span>th</span>, 2008</time>
        
         | <a href="/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="intro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Part 3</a></span>
</div>


<p>This post is the second in a three-part series on concurrent programming. In the <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">first post</a> we learned some basic concepts such as threads and serial vs. parallel execution. In this post we&rsquo;ll learn how parallel execution can create problems if we&rsquo;re not careful.</p>

<h3>How parallelism gives rise to race conditions</h3>


<p>Even among parallelizable problems, some are harder than others. The easy ones are the ones that don&rsquo;t involve threads sharing state with one another. For example, if you have five independent work queues, and the goal is simply to process all the tasks in all the queues, then there&rsquo;s nothing especially tough about this. You start five threads, run them against the five queues, and then move on once they&rsquo;re done.</p>

<p>The trickier problems are the ones that involve threads sharing state with one another. Let&rsquo;s see why.</p>

<h4>Threads and shared state</h4>


<p>Shared state presents a challenge in concurrent programming because threads can interfere with one another if their access to that shared state isn&rsquo;t properly coordinated. If you&rsquo;ve ever tried to collaborate with other authors on a single document, you might have some experience with this problem. (Though Google Docs does a nice job of supporting multiple simultaneous authors.) You make some changes to the document, hoping that your coauthor didn&rsquo;t make his own changes to the part that you worked on. If he did, then there may be a mess to clean up.</p>

<p>The essence of the problem is that at least one guy is updating the document while somebody else is either reading it or writing it. We talked about the case where you have two authors writing to the document, but it can be one guy writing and someone else reading. If one person is in the middle of updating emergency information for hurricane evacuees and another person reads a partial update, the result could be dangerous.</p>

<p>Note that there&rsquo;s no problem if you have a bunch of people simply <em>reading</em> a document at the same time. The problem only comes up if at least one of them is <em>writing</em> to it.</p>

<p>The problem we&rsquo;ve just described is called a <em>race condition</em>. The idea is that if threads aren&rsquo;t properly coordinated, then their concurrent work is vulnerable to problems associated with &ldquo;unlucky timing&rdquo;. There can be situations in which one thread is trying to update shared state and one or more other threads are trying to access it (either read or write). In effect the threads &ldquo;race&rdquo; against one another and the outcome of their work is dependent on the nondeterministic outcome of their race.</p>

<p>Let&rsquo;s look at a code example.</p>

<h4>An example of code that allows race conditions</h4>


<p>Originally I was going to present the standard (and probably a bit tired) web page hit counter example. But then today I saw somebody&rsquo;s purportedly threadsafe class that is in fact susceptible to race conditions. The code was written by an experienced engineer. So let&rsquo;s use that example instead, shown in Listing 1 below, as it&rsquo;s instructive.</p>

<div>
    <div>
        <span class="code-listing">Listing 1.</span> A class that&#8217;s supposed to be threadsafe, but isn&#8217;t
    </div>
    <pre>public class InMemoryUserDao implements UserDao {
    private Map&lt;String, User&gt; users;

    public InMemoryUserDao() {
        users = Collections.synchronizedMap(new HashMap&lt;String, User&gt;());
    }

    public boolean userExists(String username) {
        return users.containsKey(username);
    }

    public void createUser(User user) {
        String username = user.getUsername();
        if (userExists(username)) {
            throw new DuplicateUserException();
        }
        users.put(username, user);
    }

    public User findUser(String username) {
        User user = users.get(username);
        if (user == null) {
            throw new NoSuchUserException();
        }
        return user;
    }

    public void updateUser(User user) {
        String username = user.getUsername();
        if (!userExists(username)) {
            throw new NoSuchUserException();
        }
        users.put(username, user);
    }

    public void removeUser(String username) {
        if (!userExists(username)) {
            throw new NoSuchUserException();
        }
        users.remove(username);
    }
}</pre>
    </div>


<p>What do you think? See anything? The engineer claims that the class is threadsafe because we&rsquo;ve wrapped our hashmap with a synchronized instance.</p>

<h4>Threadsafety problems with the code</h4>


<p>It turns out that that&rsquo;s not correct. It&rsquo;s a common misconception that as long as you&rsquo;re dealing with a threadsafe collection (like a synchronized map), you&rsquo;ve taken care of any threadsafety issues you might have otherwise had. We&rsquo;ll use this example to show why this belief is just plain wrong.</p>

<p>Before I expose the race conditions, let me state some plausible assumptions about the intended semantics for the class:</p>

<ul class="square">
<li>Calling <code>createUser()</code> with an user whose username already exists in the map should generate a <code>DuplicateUserException</code>.</li>
<li>Calling <code>updateUser()</code> with an user whose username does not already exist should generate a <code>NoSuchUserException</code>.</li>
<li>Calling <code>removeUser()</code> with an user whose username does not already exist should generate a <code>NoSuchUserException</code>.</li>
</ul>


<p>Now let&rsquo;s see how the implementation fails to support those semantics, and in particular how the implementation permits race conditions.</p>

<p><b>createUser() is broken.</b> Here&rsquo;s a race that shows that <code>createUser()</code> does not have the intended semantics:</p>

<ol>

<li>Thread T<sub>1</sub> enters <code>createUser()</code>, with argument user U<sub>1</sub> having username N. N is not already in the map.</li>

<li>Thread T<sub>1</sub> successfully makes it past the <code>if</code> test, but not yet to the line that puts N in the map.</li>

<li>Context switch to thread T<sub>2</sub>, which also enters <code>createUser()</code>, this time with argument user U<sub>2</sub> having the same username N that U<sub>1</sub> has. (You can imagine, for example, two users registering with the same username at the same time.) N is still not in the map, because thread T<sub>1</sub> hasn&#8217;t put it there yet.</li>

<li>Thread T<sub>2</sub> completes its call to <code>createUser()</code> and exits. User U<sub>2</sub> and username N are now in the map.</li>

<li>Thread T<sub>1</sub> completes the method and executes. User U<sub>1</sub> has been placed into the map under the key N.</li>

</ol>


<p>Poof! User U<sub>2</sub> simply disappears from the map, having been overwritten by user U<sub>1</sub>. T<sub>1</sub> never encounters the <code>DuplicateUserException</code> it&rsquo;s supposed to encounter.</p>

<p><b>updateUser() is broken.</b> This one is a little more subtle than the <code>createUser()</code> case. Here&rsquo;s the race:</p>

<ol>
<li>Thread T<sub>1</sub> enters <code>updateUser()</code> with user U having name N. The user already exists in the map, so T<sub>1</sub> passes the <code>if</code> test successfully. It hasn&#8217;t reached the <code>put()</code> part yet.</li>
<li>Context switch to thread T<sub>2</sub>, which enters and exits <code>removeUser()</code> with username N (the same one that T<sub>1</sub> was using). The user U is removed from the map.</li>
<li>Thread T<sub>1</sub> completes, placing U back in the map under key N. User U has essentially been reinstated.</li>
</ol>


<p>The problem here is that the <code>removeUser()</code> method completed successfully, there was no <code>createUser()</code> call, and yet there&rsquo;s still a user sitting in the map with no error having been thrown. Given the semantics described above, that should not be possible. The only two possible outcomes ought to be: (1) the update occurs before the remove, which would mean that when the two threads complete, U is no longer in the map; or (2) the remove occurs before the update, which would mean that U should be gone, and the update should have generated an exception. In either case, U should not be in the map when the two threads complete, and yet there it is. So if T<sub>2</sub> belongs to an admin who thought he was removing a troublesome user, guess again.</p>

<p><b>removeUser() is broken.</b> We&rsquo;ve already seen in the race above that there are situations under which <code>removeUser()</code> would be expected to remove a user but does not actually do that. Here&rsquo;s another race for you, probably less significant, but still a bug:</p>

<ol>
<li>Thread T<sub>1</sub> enters <code>removeUser()</code> with existing username N, and makes it past the <code>if</code> test.</li>
<li>Context switch to thread T<sub>2</sub>, which enters and exits <code>removeUser()</code> with the same username N.</li>
<li>Thread T<sub>1</sub> completes and exits the method.</li>
</ol>


<p>In this case we have two methods that called the <code>removeUser()</code> method with the same username, but neither thread encountered a <code>NoSuchUserException</code>. That is not compatible with the semantics of the class.</p>

<p>Now that we&rsquo;ve seen some problems, let&rsquo;s try to understand what&rsquo;s happening here.</p>

<h4>What the three broken methods have in common</h4>


<p>One thing that all three cases have in common is that they follow a &ldquo;check-then-act&rdquo; pattern, where both the &ldquo;check&rdquo; and &ldquo;act&rdquo; parts reference shared data (in this case, the hashmap). The <code>createUser()</code> method checks whether the username already exists, and if not, adds the user to the map. The <code>updateUser()</code> method checks whether the username already exists, and if so, updates the user. <code>removeUser()</code> checks whether the username exists, and if so, deletes the user.</p>

<p>Note that the <code>findUser()</code> method does <em>not</em> follow the same pattern. It does a single <code>get()</code> against the map, and then does a check that checks the returned user rather than checking something against the map. Though it looks like almost the same thing, it is really a completely different situation because we&rsquo;re performing only one action against the shared data instead of multiple actions.</p>

<p>It turns out that the difference between <code>createUser()</code>, <code>updateUser()</code> and <code>removeUser()</code>, on the one hand, and the <code>findUser()</code> method, on the other, is important from a threadsafety point of view. Essentially what&rsquo;s happening is that the <code>findUser()</code> method is <em>atomic</em> (with a certain qualification, which we&rsquo;ll discuss in the next section), meaning that it executes as a single action. The <code>createUser()</code>, <code>updateUser()</code> and <code>removeUser()</code> methods, on the other hand, are not atomic. The various check and act operations can be interleaved in arbitrary ways across different threads. Intuitively what that means is that checks, which are supposed to provide safety, can become invalid because other actions can be scheduled in between any given check-act pair. The safety checks are invalidated and the class behaves in strange ways (especially as load increases, which is usually the most inopportune time for such issues to arise).</p>

<p>Now let&rsquo;s look at how we can solve race conditions such as the ones we&rsquo;ve been considering.</p>

<h3>Solving race conditions with synchronization</h3>


<p>The key to avoiding race conditions is to coordinate the multiple threads when accessing shared data. There are different ways to do this, but the simplest is the one your mom taught you when you were a kid: take turns.</p>

<h4>Taking turns with mutexes</h4>


<p>Here&rsquo;s how you take turns in software. Suppose that you have some shared data that you want to protect, such as a list of all the posts in a given web-based discussion forum, or a web page hit counter. You have various blocks of code throughout your application that access that data, both reading it and writing it. These blocks of code don&rsquo;t have to be in the same class (though they often are), but they&rsquo;re all accessing the same data.</p>

<p>(Keep in mind that when we describe the data as shared data, we mean that it&rsquo;s shared by multiple threads, not that multiple blocks of code access it. If multiple blocks of code access the data but only one thread ever does, then it&rsquo;s not shared data.)</p>

<p>The trick is to protect the code so that only one thread can enter it at a time. I don&rsquo;t mean that only one thread can enter one of the code blocks at a time. I mean that if you consider the whole set of code blocks as a single group, only one thread can enter that group at a time. So if one thread enters one of the blocks, then all other threads need to be kept out of all other blocks until that first thread is done.</p>

<p>The way we enforce this behavior is to associate with each block of code you want to protect something called a mutual exclusion lock, or <em>mutex</em>. People often just call it a lock as well. You associate a lock with any given piece of data you want to protect, and all the code blocks that access that data use that same lock. A thread is not allowed to enter the code block unless it acquires the lock. So whenever thread T<sub>1</sub> wants to enter, it attempts to grab the lock. If the lock is available, then T<sub>1</sub> takes it and other threads have to wait until T<sub>1</sub> is done. If instead some other thread T<sub>2</sub> has the lock, then T<sub>1</sub> has to wait until T<sub>2</sub> is done.</p>

<p>When a thread leaves the block of code protected by the mutex, known as the <em>critical section</em>, it releases the lock.</p>

<p>Incidentally, I always thought it was kind of funny we talk about grabbing locks. It seems like we should say we grab a key so we can get past the lock. But that&rsquo;s not how people talk about it.</p>

<p>We now introduce the principal way of implementing a mutex in Java, the <code>synchronized</code> keyword.</p>

<h4>The <code>synchronized</code> keyword</h4>


<p>In Java the primary mechanism for enforcing turn-taking across threads is the <code>synchronized</code> keyword. You basically put the code you want to protect inside a <code>synchronized</code> block, specifying a lock object (or more exactly, specifying an object whose <em>monitor</em> will be used as a lock&mdash;in Java, each object has a &ldquo;monitor&rdquo; that can be used as a mutex). If you want to synchronize access to the whole method, you just use the <code>synchronized</code> keyword on the method itself. In this latter case, the locking object is the one on which the method is being called.</p>

<p>Here&rsquo;s an example of a synchronized block:</p>

<pre>synchronized (myList) {
    int lastIndex = myList.size() - 1;
    myList.remove(lastIndex);
}</pre>


<p>Here, we&rsquo;re using the <code>myList</code> instance as the lock. Anytime a thread wants to enter this block of code, or any other block of code protected by the same lock, it needs to grab the lock on the <code>myList</code> instance first. And it releases the lock upon exiting the <code>synchronized</code> block (i.e., the critical section).</p>

<p>Here&rsquo;s an example of a synchronized method:</p>

<pre>public class Order {

    ...

    public synchronized void removeLastLineItem() {
        int lastIndex = myList.size() - 1;
        myList.remove(lastIndex);
    }
}</pre>


<p>In this case, a thread wanting to enter the <code>removeLastLineItem()</code> method would need to grab the lock on the relevant <code>Order</code> instance first, and would release the lock after exiting the method.</p>

<p>Armed with our understanding of mutexes and the <code>synchronized</code> keyword, let&rsquo;s revisit our example from the previous page.</p>

<h4>Our example, revisited: making the code threadsafe</h4>


<p>Listing 2 shows how to apply thread synchronization to make the class threadsafe.</p>

<div>
    <div><span class="code-listing">Listing 2.</span> A threadsafe version of our DAO</div>
    <pre>public final class InMemoryUserDao implements UserDao {
    private Map&lt;String, User&gt; users;

    public InMemoryUserDao() {
        users = Collections.synchronizedMap(new HashMap&lt;String, User&gt;());
    }

    public boolean userExists(String username) {
        return users.containsKey(username);
    }

    public void createUser(User user) {
        String username = user.getUsername();
        synchronized (users) {
            if (userExists(username)) {
                throw new DuplicateUserException();
            }
            users.put(username, user);
        }
    }

    public User findUser(String username) {
        User user = users.get(username);
        if (user == null) {
            throw new NoSuchUserException();
        }
        return user;
    }

    public void updateUser(User user) {
        String username = user.getUsername();
        synchronized (users) {
            if (!userExists(username)) {
                throw new NoSuchUserException();
            }
            users.put(username, user);
        }
    }

    public void removeUser(String username) {
        synchronized (users) {
            if (!userExists(username)) {
                throw new NoSuchUserException();
            }
            users.remove(username);
        }
    }
}</pre>
    </div>


<p>In Listing 2 we&rsquo;ve addressed the three issues that we raised earlier. First note that the <code>users</code> instance is entirely encapsulated by our <code>InMemoryUserDao</code> class (I&rsquo;ve made the class <code>final</code> to prevent inheritance from breaking our encapsulation here), so that means it is entirely within our power to protect every possible access to the <code>users</code> instance. (Hm, that&rsquo;s probably a good interview question: &ldquo;Discuss the relationship between encapsulation and threadsafety.&rdquo;)</p>

<p>Next note that we&rsquo;ve addressed the general problem that we saw by making every &ldquo;check-then-act&rdquo; occurrence atomic. Now the code is such that if thread T checks something (such as checking whether a username exists), we can be sure that the answer doesn&rsquo;t change before the action part, because no other thread is able to access the <code>users</code> instance at all until T is done with it.</p>

<h4>Internal vs. external synchronization</h4>


<p>There&rsquo;s one detail to discuss. Take a look at the <code>userExists()</code> and <code>findUser()</code> methods. In both cases we access the <code>users</code> instance, but there&rsquo;s no <code>synchronized</code> block. The reason this isn&rsquo;t a problem is that both of the following are true:</p>

<ol>
<li>we&#8217;re calling only one method on the <code>users</code> map, and</li>
<li>the map is internally synchronized since we created the map using the <code>Collections.synchronizedMap(...)</code> wrapper.</li>
</ol>


<p>If either of those two conditions had failed, we&rsquo;d need to put the calls in a <code>synchronized</code> block. It&rsquo;s useful to discuss these a little more carefully.</p>

<p>Let&rsquo;s take (1) first. Note that even though we don&rsquo;t have an explicit <code>synchronized</code> block, each individual method call we make against <code>users</code> is threadsafe. That&rsquo;s because the <code>users</code> map is internally synchronized on the monitor for the <code>users</code> instance itself. That is, the map handles synchronization for individual method calls so we don&rsquo;t have to. If we&rsquo;re just going to call a single method on an internally synchronized method, we&rsquo;re usually OK to do so.</p>

<p>The place where we have to pay attention to threadsafety is where we call multiple methods on the <code>users</code> instance. There, the internal synchronization doesn&rsquo;t help us at all because that synchronization doesn&rsquo;t prevent the thread from releasing the lock in between the multiple method calls. And when it releases the lock, another thread can come in and change the data. If your code logic assumes that the multiple method calls behave as an atomic unit, you have a problem. Therefore you must provide your own synchronization on the relevant lock when you use check-then-act and similar patterns.</p>

<p>It is a common error to assume that just because the object is internally synchronized, you don&rsquo;t have to worry about threadsafety anymore. That is simply not true, as we&rsquo;ve just explained.</p>

<p>Now take (2). Clearly if the map didn&rsquo;t have any internal synchronization, then we&rsquo;d need to provide it ourselves, even for single method calls against the map. Otherwise threads could get in and muck things up for other threads. This is true even in many cases where it <em>looks</em> like individual threads are performing atomic actions. For example, if you have some threads making <code>get()</code> calls against a <code>HashMap</code>, and another set of threads making <code>put()</code> calls against the same <code>HashMap</code>, you may think that they are all performing atomic operations and therefore it&rsquo;s OK to do this. But that is not correct. The problem is that they only <em>look</em> like atomic operations; behind the scenes, they&rsquo;re impacting the size of a shared backing array, which in turn impacts how hashcodes are mapped to buckets, which impacts the <code>get()</code> and <code>put()</code> calls themselves. If the class had internal synchronization then <code>get()</code> and <code>put()</code> would both be atomic from the perspective of external code, but without that, they aren&rsquo;t atomic at all.</p>

<p>That was your crash course on solving race conditions with thread synchronization. It&rsquo;s not a simple topic, but you should now have the basics. But even though thread synchronization helps solve one problem, unfortunately it creates another. The problem is that in forcing threads to stop and wait their turn, you create the potential for the situation in which threads might wait indefinitely before they can move on. This is called a deadlock, and we&rsquo;ll turn to it in the next post in the series.</p>

<div class="outro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/10/13/concurrent-programming-for-practicing-software-engineers-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/10/14/concurrent-programming-for-practicing-software-engineers-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/10/15/concurrent-programming-for-practicing-software-engineers-part-3/">Part 3</a></span>
</div>




<div class="endnote">Post migrated from my Wheeler Software site.</div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/7/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/5/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/10/07/handling-json-error-object-responses-with-springs-resttemplate/">Handling JSON error object responses with Spring&#8217;s RestTemplate</a>
      </li>
    
      <li class="post">
        <a href="/2013/10/02/quick-tip-basic-authentication-with-spring-resttemplate/">Quick tip: Basic authentication with Spring RestTemplate</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/25/aggregating-tp90-data-with-splunk/">Aggregating TP90 data with Splunk</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/14/optimistic-locking-with-spring-data-rest/">Optimistic locking with Spring Data REST</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/07/octopress-migration/">Octopress migration</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/williewheeler">@williewheeler</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'williewheeler',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Willie Wheeler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'springinpractice';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

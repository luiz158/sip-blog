
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Spring in Practice</title>
  <meta name="author" content="Willie Wheeler">

  
  <meta name="description" content="We&rsquo;re very excited to announce that we&rsquo;ve been MEAPed. :&ndash;) MEAP is the Manning Early Access Program. MEAP allows you to buy the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://springinpractice.com/blog/page/7">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Spring in Practice" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Forum' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31137459-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <ul class="social-links">
    <li><a href="https://twitter.com/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/twitter.png" alt="Twitter" /></a></li>
    <li><a href="https://github.com/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/github.png" alt="GitHub" /></a></li>
    <li><a href="http://stackoverflow.com/users/41871/willie-wheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/stackoverflow.png" alt="Stack Overflow" /></a></li>
    <li><a href="http://www.linkedin.com/in/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/linkedin.png" alt="LinkedIn" /></a></li>
  </ul>
  <h1><a href="/">Spring in Practice</a></h1>
  
    <h2>Willie Wheeler's Spring blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives/">Archives</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="/code-and-setup/">Code &amp; Setup</a></li>
  <li><a href="/errata/">Errata</a></li>
  <li><a href="/consulting/">Consulting</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/09/30/weve-been-meaped-chapters-4-5-available/">We&#8217;ve Been MEAPed - Chapters 4 & 5 Available</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-30T14:27:53-07:00" pubdate data-updated="true">Sep 30<span>th</span>, 2008</time>
        
         | <a href="/2008/09/30/weve-been-meaped-chapters-4-5-available/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We&rsquo;re very excited to announce that we&rsquo;ve been MEAPed. :&ndash;)</p>

<p>MEAP is the Manning Early Access Program. MEAP allows you to buy the book before it&rsquo;s actually done so you can start getting at the content as it becomes available.</p>

<p>We just released the first pair of chapters: Chapter 4 (User registrations) and Chapter 5 (Authentication). Also the table of contents is online for those who are interested.</p>

<p>MEAP page: <a title="Spring in Practice MEAP page" href="http://www.manning.com/wheeler/"><a href="http://www.manning.com/wheeler/">http://www.manning.com/wheeler/</a></a></p>

<p>Author forum: <a title="Spring in Practice author forum" href="http://www.manning-sandbox.com/forum.jspa?forumID=503"><a href="http://www.manning-sandbox.com/forum.jspa?forumID=503">http://www.manning-sandbox.com/forum.jspa?forumID=503</a></a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/09/06/login-remember-me/">Excerpt: Login and Remember-me Discussion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-06T08:37:16-07:00" pubdate data-updated="true">Sep 6<span>th</span>, 2008</time>
        
         | <a href="/2008/09/06/login-remember-me/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2008-09-06-login-remember-me/retina2.jpg" alt="Human retina" /></p>

<p><em><a href="http://www.manning.com/wheeler/">Spring in Practice</a></em> centers on using Spring to implement technical solutions to common problems, but it&rsquo;s also important for developers to understand the problem they&rsquo;re trying to solve before implementing a solution. In the book we work pretty hard to provide that understanding.</p>

<p>Here&rsquo;s an except from the discussion section for a recipe on implementing login forms and remember-me authentication using Spring Security. While discussion sections might treat the problem, the solution or both, this particular discussion digs a little deeper some security/usability tradeoffs to consider when implementing username/password and remember-me authentication.</p>

<blockquote><p>In the background we briefly mentioned that username/password logins are only one approach to authentication. While other authentication mechanisms are commercially available—for example, there are laptops with thumbprint scanners—for most web-based applications, username/password combinations are the most practical approach. It&rsquo;s simply unrealistic to assume that general web users will have card readers, key fobs, biometric scanners and so forth. Such assumptions may be more plausible in controlled environments.</p>

<p>It&rsquo;s useful to understand some of the drawbacks of username/password authentication. The main drawback is that in general, the stronger a user&rsquo;s password is, the harder it is to remember. That in turn increases the chance that the user will either write it down somewhere or else use it for multiple websites, both of which increase the chance that the password will be compromised. Password reuse is problematic partly because a shared password is distributed across many systems (which can be dangerous if that password is not properly managed; see recipes 4.3 and 4.5), and partly because the damage is not limited in the event that the shared password is compromised.</p>

<p>People have devised different approaches to dealing with parts of this problem. One approach is called single sign-on (SSO), and it works nicely in homogeneous computing environments such as corporate intranets. The idea is that the environment (rather than the application) provides for centralized authentication and then that authentication is shared with the applications in that environment. Another approach is the relatively recent OpenID standard, which differs from SSO in being decentralized. With OpenID, a user picks a participating site to be an authentication provider, and then other participating sites use that provider to authenticate the user. This is different than SSO in that with OpenID, different sites require separate logins. While neither SSO nor OpenID does much to limit the damage when a password is compromised (though a password could be reset from a single location), they do have the benefit that they prevent password fatigue without distributing the password across multiple systems.</p>

<p>Remember-me authentication also highlights the tradeoff between security and usability. It&rsquo;s important to recognize that we&rsquo;re really authenticating the browser rather than the user. Because there are various scenarios in which there&rsquo;s a many-to-one relationship between users and browsers (for example, a shared public machine, the family computer, a computer in somebody&rsquo;s unlocked office), we should treat remember-me authentication as not-entirely-convincing. One good approach is to give a remember-me user access to low-risk functionality, but to force a login if the user tries to access higher-risk functionality. Amazon uses exactly this technique: remember-me users can see product recommendations, but to buy something they have to log in.</p>

<p>The upshot is this: add login forms and remember-me to your app only if it makes sense to do so. In some cases it would make even more sense to use SSO, auto-provision the accounts, externalize your authentication with OpenID, and so on. Just because Spring Security makes it easy to add a login form and remember-me doesn&rsquo;t mean that you should. If you include remember-me in particular, keep in mind the design issues we just discussed.</p>

<p>Now that we&rsquo;ve seen how to create a basic, unstyled login form, it&rsquo;s time to get to work on making it look better. The next recipe will show you how.</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/09/05/just-got-the-book-cover/">Just Got the Book Cover</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-05T03:49:17-07:00" pubdate data-updated="true">Sep 5<span>th</span>, 2008</time>
        
         | <a href="/2008/09/05/just-got-the-book-cover/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2008-09-05-just-got-the-book-cover/sip-cover-sm12.jpg" alt="Book cover" /></p>

<p>Manning just sent us the book cover &ndash; we love it! I&rsquo;m pretty sure we will have a lot more than fifty problems solved (we&rsquo;re targeting about 600 pages) but I think the text is just sample text for now.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/08/31/about-our-book/">About Our Book</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-31T05:20:06-07:00" pubdate data-updated="true">Aug 31<span>st</span>, 2008</time>
        
         | <a href="/2008/08/31/about-our-book/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2008-08-31-about-our-book/2213191214_8db8aba33c2.jpg" alt="Tools" /></p>

<p><strong>In a nutshell:</strong> <em>Spring in Practice</em> is an applied book on the Spring Framework. It&rsquo;s not theoretical, and it&rsquo;s not a reference manual.</p>

<p>Let&rsquo;s look at that statement in more detail, since we&rsquo;d like you to know what you&rsquo;re buying before you buy it. And maybe we can even pique your interest in what we&rsquo;re doing.</p>

<h3>We assume you already have your reasons for using Spring</h3>


<p>While it&rsquo;s true that we like Spring, we assume that you already have your reasons for using it &ndash; maybe you heard it was a good framework and you want to try a few things out, or maybe you&rsquo;ve just joined a development team where it&rsquo;s already been decided by the powers that be that you&rsquo;re going to be using Spring.</p>

<p>Given that assumption, we don&rsquo;t make much of an effort to &ldquo;sell&rdquo; the framework.  We don&rsquo;t rehash the history, and we don&rsquo;t explain in much detail what recommends Spring over this this-or-that alternative.  Instead we give you some bare minimum technical background (mostly around practices that we adopt in the book, such as using the &ldquo;p&rdquo; namespace or using annotations to accomplish various things) and then launch immediately into the &ldquo;how-to&rdquo; materials.</p>

<p>We try to show you not only areas in which Spring excels, but also areas in which Spring doesn&rsquo;t help you out very much or even areas in which Spring seems to make things more difficult than they ought to be.  With respect to the latter, we believe that such information is extremely practical but not necessarily easy to find.</p>

<h3>It&#8217;s not a reference manual</h3>


<p>In saying that <em>Spring in Practice</em> is an applied book, we mean to distinguish it from reference manuals, which generally take a technology-centric perspective in that they organize around the technologies that make up their topic.  For example, reference manuals on the Spring Framework typically start with a history of the framework, and then go on to explain why Spring represents an improvement over traditional approaches. They then continue with chapters on the IoC container, data access, transactions, web services, Spring Web MVC, Spring Web Flow, Spring Security, testing and so forth.</p>

<p>Those are certainly appropriate reference manual topics, but the problem is that it&rsquo;s hard for a novice to become productive without first absorbing a lot of background information.  To build a single vertical in a web application, such as a user registration form (including all aspects of the form &ndash; web presentation, form validation, form processing and storage, security, web flow if necessary, etc.), you potentially have to read several chapters&#8217; worth of material.  It isn&rsquo;t necessarily obvious what you can skip (for example, can you skip the chapter on Spring Web Flow? can you skip the section on programmatic validation?), and it isn&rsquo;t necessarily clear how all the pieces fit together.  The novice must analyze each chapter to understand what is and isn&rsquo;t relevant, and then must further synthesize the relevant pieces into a coherent solution.</p>

<p>In a certain respect, the novice&rsquo;s difficulties are exacerbated by the fact that reference manuals of necessity tend to present toy examples.  On the one hand, the simplification is useful because it allows the reader to grasp the technology without getting bogged down in messy problem domain details.  On the other hand, most readers &ndash; novices included &ndash; are tasked with solving realistic problems, and so there&rsquo;s a gap between the reader&rsquo;s task and what the book directly explains.</p>

<p>Reference manuals are optimized for people who already have a reasonable understanding of the technology and who just need to learn or remember how a certain piece works.  As such they serve an important function; certainly all readers, novices again included, will benefit from having a reference manual handy.  But novices relying solely on a reference manual will usually read a lot of material that isn&rsquo;t directly relevant to what they&rsquo;re trying to do, and spend lots of time figuring how to integrate the pieces.</p>

<h3>We organize around problems rather than around Spring technologies</h3>


<p><em>Spring in Practice</em> takes a completely different approach.  We wanted to contribute something optimized for people who are newer to Spring and who, despite their novice status, are required to solve realistic problems, and quickly.</p>

<p>Except for the first few introductory chapters, the book is organized not around Spring Framework technologies, but instead around <em>problems</em> that you might want or need to solve using Spring.  For instance, you won&rsquo;t find anything in the table of contents that says &ldquo;Integrating Hibernate and Spring&rdquo; or &ldquo;Using Spring Web MVC to do such-and-such;&rdquo; rather we treat problems that can be stated in the language of application domains.  Some of the problems are highly general in that they show up in multiple application categories; examples include the following:</p>

<ul>
    <li>Display a user registration form</li>
    <li>Store user passwords securely</li>
    <li>Allow users to select a site theme</li>
    <li>Use CAPTCHAs to prevent comment spam</li>
    <li>Create a business process monitor (BPM)</li>
</ul>


<p>Other problems are more category-specific (but not tied to any particular industry). Again, here are some examples:</p>

<ul>
    <li><strong>Marketing:</strong> Create HTML e-mail templates for e-mail marketing campaigns</li>
    <li><strong>Lead generation:</strong> Submit leads to a web service</li>
    <li><strong>E-commerce:</strong> Implement a simple shopping cart</li>
    <li><strong>CRM:</strong> Implement contact history</li>
</ul>


<p>Because we focus on domain problems instead of technologies, we can do a few things that are harder for reference manuals to do:</p>

<ul>
    <li><strong>We can treat problems more realistically.</strong> Instead of including only those pieces of the problem that scaffold the technical discussion, we can include other concerns that are often neglected in reference-type treatments, including issues around usability, security, search engine friendliness, and so on.  Often the concerns in these non-functional areas give rise to requirements that further drive the technical discussion.  Our hope is that readers - novices and veterans alike - will find this aspect of our book to be of great value.</li>
    <li><strong>We can focus the solution on those pieces that are directly relevant to the problem.</strong> If user registration forms deal with hashes and salts but not ACLs, then you&#8217;ll read about hashes and salts and you won&#8217;t read about ACLs.</li>
    <li><strong>We can integrate all aspects of the solution in a single place.</strong> You won&#8217;t have to &#8220;put it all together;&#8221; we&#8217;ve already done that for you.</li>
</ul>


<p>Hopefully that gives you a good understanding of the book we&rsquo;re writing.  If you have thoughts or suggestions please do let us know.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/08/31/storing-passwords-securely/">Storing Passwords Securely</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-31T03:28:35-07:00" pubdate data-updated="true">Aug 31<span>st</span>, 2008</time>
        
         | <a href="/2008/08/31/storing-passwords-securely/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When dealing with user account information, there are lots of different security concerns that come up. Some examples include making sure users use strong passwords, preventing automated registrations, helping end users distinguish real sites from phishing sites, transmitting user data securely, and so forth&mdash;the list goes on and on.</p>

<p>In this article we&rsquo;re going to look at a specific piece of the overall user account security puzzle, and that&rsquo;s the problem of storing user passwords securely. Specifically we will see how you can use techniques from cryptography&mdash;hashing and salting your passwords&mdash;to make it harder for would-be attackers to uncover user passwords in the event that the password database (or password file, or whatever) is compromised.</p>

<p>We&rsquo;re only going to cover the concepts and techniques here; we won&rsquo;t get into how to actually implement this on any particular platform or using any particular framework. My brother John and I are currently writing a book for Manning Publications called <a href="http://www.manning.com/wheeler/">Spring in Practice</a> that will explain how to implement password salting and hashing using the <a href="http://www.springframework.org/">Spring Framework</a>, but for this article we&rsquo;ll just look at the concepts and techniques.</p>

<h3>Why store user passwords securely?</h3>


<p>It&rsquo;s worth thinking for a moment whether it&rsquo;s really even necessary to &ldquo;store user passwords securely,&rdquo; if doing so involves anything more than limiting access to password data. If only a small number of trustworthy technical staffers have access to the user passwords, then why can&rsquo;t we just store the data in the clear? Doesn&rsquo;t that make it easier for technical staff to troubleshoot system issues (for example, admins can just log in as other users to try to reproduce errors), and doesn&rsquo;t that make it easier to help users recover forgotten passwords?</p>

<p>The answer to both of those questions is yes, but the story doesn&rsquo;t end there. The problem is that storing plaintext passwords also makes it easier for bad guys to see user passwords, and that&rsquo;s true whether bad guys break in from the outside or whether you have bad guys on your admin team. If attackers can log into your applications under somebody else&rsquo;s account, that&rsquo;s potentially very bad for you and your users. Moreover, because users often have the bad habit of reusing passwords (or else simple variants of passwords) across multiple applications and web sites, it&rsquo;s very difficult for you to limit the scope of the damage once somebody actually gets ahold of user passwords. The situation is possibly very damaging to your users and embarrassing to your organization. In all but the most trivial cases, it makes a lot of sense to store user data securely.</p>

<p>As an aside, note that in doing so, we don&rsquo;t give up the ability to allow admins or tech support reps to impersonate other users, nor do we sacrifice the ability to help users who have forgotten their passwords. We just have to use other techniques to accomplish those things, such as &ldquo;run-as&rdquo; impersonation, and using password resets in lieu of password recovery. Let&rsquo;s however stay focused on storing passwords securely.</p>

<p>So now we&rsquo;ve seen why we don&rsquo;t want to store plaintext passwords. In the rest of this article we&rsquo;re going to look at four increasingly sophisticated cryptographic techniques for making it harder for attackers to get at your passwords. All four are based on something called a hash function, so let&rsquo;s start by talking about hash functions a bit.</p>

<h3>Understanding hash functions</h3>


<p>Hash functions are a tool from cryptography, and they are functions in the mathematical sense: for any given &ldquo;acceptable&rdquo; input, it spits out a specific output. In this case, the domain of acceptable inputs would be plaintext strings, and outputs are garbled-up (i.e., encrypted) versions of the plaintext strings, called <em>hashes</em>.</p>

<p>Let&rsquo;s play around with some examples before we go on, just so you can see what I&rsquo;m talking about. Go to your favorite search engine and type &ldquo;online hash function calculator.&rdquo; (Obviously you can use command line tools and programming APIs to compute hash functions as well.) You should see some links that allow you to calculate hashes using specific hash functions with names like MD5, SHA-1, RIPEMD-160 and others. Here&rsquo;s one:</p>

<ul>
 <li><a href="http://www.hashemall.com/">http://www.hashemall.com/</a></li>
</ul>


<p>Select an MD5 hash calculator, and enter some plaintext. When you hit submit, you should see a hash value. Note that whitespace in your plaintext is significant, so if you hash &lsquo;friend&rsquo; and &lsquo;friend[CR]&rsquo;, the output will be different.</p>

<p>Here are some MD5 hashes:</p>

<table>
 <tr>
  <th style="width:40%">Plaintext input</th>
  <th style="width:60%">MD5 hash (hex)</th>
 </tr>
 <tr>
  <td><code>friend</code></td>
  <td><code>3af00c6cad11f7ab5db4467b66ce503e</code></td>
 </tr>
 <tr>
  <td><code>friends</code></td>
  <td><code>28f20a02bf8a021fab4fcec48afb584e</code></td>
 </tr>
 <tr>
  <td><code>password</code></td>
  <td><code>5f4dcc3b5aa765d61d8327deb882cf99</code></td>
 </tr>
 <tr>
  <td><code>I pledge allegiance to the flag</code></td>
  <td><code>bb00ea10b4ee04c4319c0c05bf9c29fc</code></td>
 </tr>
</table>


<p>Just for kicks let&rsquo;s get some SHA-1 hashes for the same plaintext inputs:</p>

<table>
 <tr>
  <th style="width:40%">Plaintext input</th>
  <th style="width:60%">SHA-1 hash (hex)</th>
 </tr>
 <tr>
  <td><code>friend</code></td>
  <td><code>e69867ca7d5a7b0ab60a2a61e7b791c106f7bf64</code></td>
 </tr>
 <tr>
  <td><code>friends</code></td>
  <td><code>3d9209c4598bfbc38b3c096081bee3a09697e939</code></td>
 </tr>
 <tr>
  <td><code>password</code></td>
  <td><code>5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</code></td>
 </tr>
 <tr>
  <td><code>I pledge allegiance to the flag</code></td>
  <td><code>fc1d13f4e3b942d6c31185ff033c5b7acfe22751</code></td>
 </tr>
</table>


<p>There&rsquo;s a lot of good stuff going on here. The main point is that MD5 and SHA-1 both do essentially the same thing: they convert plaintext into garbled text with certain properties (which we&rsquo;ll discuss momentarily). So they&rsquo;re both hash functions, albeit different hash functions.</p>

<p>I just mentioned &ldquo;certain properties.&rdquo; Here are some worth noting:</p>

<ul>
 <li>All of the MD5 hashes are the same length as each other, and similarly, all of the SHA-1 hashes are the same length. MD5 hashes use 128 bits (usually expressed as 32 hex digits) and SHA-1 hashes use 160 bits (usually expressed as 40 hex digits). In general hash functions (or more exactly, cryptographic hash functions) return fixed-size hashes.</li>
 <li>It was really easy to compute the hashes from the inputs. If you used one of the online calculators, for example, your hash value was calculated more or less instantly after you provided the plaintext.</li>
 <li>Looking at the hashes, there&#8217;s no obvious way to map it back to the plaintext. Ideally it is computationally infeasible to determine the plaintext input from the hash.</li>
 <li>Similar inputs, such as &#8216;friend&#8217; and &#8216;friends&#8217;, produce dramatically different hashes.</li>
</ul>


<p>The properties just given are characteristic of hash functions. For a hash function to be &ldquo;cryptographically secure,&rdquo; we typically want two more properties to be true:</p>

<ul>
 <li>Given a hash, it is computationally infeasible to find an input that produces that hash.</li>
 <li>Given an input, it is computationally infeasible to find another input that produces the same hash.</li>
</ul>


<p>The MD5 and SHA-1 hash functions are generally considered to be secure though researchers have found weaknesses in each. For many practical purposes, it is at the time of this writing (late 2008) safe to use either of the two. <strong>If however you are doing something that requires exceptionally strong security (for example, financial applications), please consult a security expert.</strong></p>

<p>That&rsquo;s what we needed to know about hash functions. Now let&rsquo;s learn how we can use them to store passwords securely.</p>

<h3>Using hashes to protect passwords from casual observers and undetermined attackers</h3>


<p>The first thing we might reasonably want to do is protect passwords from casual observers, such as technical staff who have access to passwords in the database. While your admins are probably people you trust, there&rsquo;s no reason to tempt them, right?</p>

<p>The easiest way to protect passwords from casual observers is to hash the passwords before storing them in the database. That way admins see only hex codes instead of plaintext passwords.</p>

<p>If you recall from the previous section, we mentioned that in general we can&rsquo;t compute the password from the hash. You might wonder then how we accomplish logins. The answer to that is to hash the user&rsquo;s submitted password when he logs in, and then to compare the submitted hash with the stored hash. Because different passwords will almost certainly have different hashes, we can conclude that the authentication was successful if and only if the two hashes match. Sounds great, right?</p>

<p>Not exactly. This scheme does in fact prevent the casual observer from accidentally seeing passwords, and it may even present the newbie attacker from recovering a password. But in jujutsu-like fashion, we can use the for-all-practical-purposes 1-1 nature of the hash function as a tool to defeat it. Let&rsquo;s look at an example, shall we?</p>

<ol>
 <li>Go to Google and search for &#8220;online md5 hash database&#8221;. Here are a couple that I found. (Note that I don&#8217;t have any control over these websites and in particular I can&#8217;t promise that they won&#8217;t have unsavory ads. These two don&#8217;t appear to have that, but sometimes hacker websites do have that sort of thing.)
  <ul>
   <li><a href="http://md5.igrkio.info/md5-hash-database.html">http://md5.igrkio.info/md5-hash-database.html</a> (this is a metasearch)</li>
   <li><a href="http://gdataonline.com/seekhash.php">http://gdataonline.com/seekhash.php</a></li>
  </ul>
 </li>
 <li>Copy the MD5 hash for &#8216;friend&#8217;, &#8216;friends&#8217; or &#8216;password&#8217; above.</li>
 <li>Paste it into the hash database search field submit it.</li>
 <li>Hey, you&#8217;ve recovered your password! Huh?!</li>
</ol>


<p>So what&rsquo;s going on here? It turns out that there are various online hash databases&mdash;essentially lookup tables&mdash;that map hashes to the inputs that generated them. Helpful hackers around the world create such databases by precomputing the hashes associated with dictionary words and close variants (in multiple languages, even). Because different passwords map to different hashes, you can create a lookup table for any explicitly given set of passwords. If an attacker has such a hash database at his disposal, it&rsquo;s pretty easy to launch a so-called <em>dictionary attack</em> against a compromised password database. The attacker can either attack passwords one-by-one, or (more commonly), the attacker can simply look for hashes associated with common passwords (&lsquo;password&rsquo;, &lsquo;qwerty&rsquo;, etc.) and do whatever he wants to do with them afterward.</p>

<p>You&rsquo;ll notice that we did not pick the hash for &lsquo;I pledge allegiance to the flag&rsquo;. If you copy the MD5 hash for &lsquo;I pledge allegiance to the flag&rsquo; into a hash databases, chances are that it won&rsquo;t be able to figure out what generated the hash. (And if it does, it&rsquo;s easy enough to manufacture hashes that won&rsquo;t generate a match.) That&rsquo;s because the hash database creator did not precompute a hash for that particular phrase. And we can use that little tidbit to make our hashing scheme more secure, as we&rsquo;re about to see.</p>

<h3>Using hashes and fixed salts to protect passwords from slightly-determined attackers</h3>


<p>The key insight from the above is that we can thwart simple dictionary attacks by hashing inputs that are unlikely to have been used to generate a hash dictionary. One possibility would be to ask users to use strong passwords with a mix of uppercase, lowercase, digits and punctuation, but we don&rsquo;t want to have to depend on users to do that. (Anyway, the more complicated the passwords are, the more likely the user is to write the password down on a Post-It, which creates its own security issues.) So what else can we do?</p>

<p>The answer is that we can concatenate the plaintext with some given additional piece of text, known as a &ldquo;salt,&rdquo; and then hash and store the result. The salt should be something that you&rsquo;re pretty sure wouldn&rsquo;t be used in generating a generic hash database. That way there&rsquo;s no chance that somebody could use an existing dictionary to attack your passwords.</p>

<p>Let&rsquo;s say, for instance, that we choose <code>iamJeLLy%Dans0R</code> as our salt. Then we can generate safer hashes as follows:</p>

<p> <table>
  <tr>
   <th>Plaintext password</th>
   <th>Password + salt</th>
   <th>MD5 hash of password + salt</th>
  </tr>
  <tr>
   <td><code>friend</code></td>
   <td><code>friend{iamJeLLy%Dans0R}</code></td>
   <td><code>a62dc48775f623e180dd0ff2bc870b24</code></td>
  </tr>
  <tr>
   <td><code>friends</code></td>
   <td><code>friends{iamJeLLy%Dans0R}</code></td>
   <td><code>ec844e0a820ae2e4444f70c5a447c467</code></td>
  </tr>
  <tr>
   <td><code>password</code></td>
   <td><code>password{iamJeLLy%Dans0R}</code></td>
   <td><code>1d7eed225b27a9cd075478e7d5de29a6</code></td>
  </tr>
  <tr>
   <td><code>I pledge allegiance to the flag</code></td>
   <td><code>I pledge allegiance to the flag{iamJeLLy%Dans0R}</code></td>
   <td><code>cd7e0f644ebecb7c7c3558c71a8f7a86</code></td>
  </tr>
 </table></p>

<p>Call me an optimist, but I am pretty sure you are not going to find any of those hashes in an existing hash database. So now we are bulletproof, yes?</p>

<p>No, not really. (And there probably isn&rsquo;t such a thing when it comes to security.) You may have noticed that I kept saying that the hashes wouldn&rsquo;t appear in an <em>existing</em> hash database. That&rsquo;s the clue you need in order to figure out how the attacker can still get at your passwords. Assume also that the attacker knows the salt value, which isn&rsquo;t necessarily unrealistic since he does after all have access to your passwords. Maybe he has access to the salt too. Do you see the attack?</p>

<p>All the attacker needs to do is generate a new lookup table. He grabs a file containing hundreds of thousands of dictionary words, appends each one with the salt, computes the hash and finally creates the lookup entry. Ugh!</p>

<p>How realistic is that? For casual observers and novice attackers, it&rsquo;s unlikely. But if somebody is fairly determined to get the passwords, it&rsquo;s not unlikely at all. Dictionary files in multiple languages are after all readily available&mdash;see, e.g., <a href="http://www.winedt.org/Dict/"><a href="http://www.winedt.org/Dict/">http://www.winedt.org/Dict/</a></a>&mdash;and anyway, it&rsquo;s not even necessary to process the entire dictionary. Just choose say 1,000 common words and do those. That&rsquo;ll get you pretty far if there are enough passwords in the password database.</p>

<p>You might wonder why we would even look at this approach, given that it&rsquo;s easy enough to defeat. There are multiple reasons. First, even though it&rsquo;s easy to defeat, it does in fact create an extra obstacle to getting at the passwords, and that obstacle is sufficiently frustrating that it will filter out attackers who aren&rsquo;t at least fairly determined and knowledgeable. Secondly, we assumed that the salt was known. If you&rsquo;re able to keep the salt a secret (e.g., store it separately from the password database), then you have the makings of a practically impenetrable password storage scheme. The problem however is keeping the salt secret; presumably either the developers or the admins will know it. But if you&rsquo;re able to pull that off, go for it.</p>

<p>The third reason is that we can use a modified version of our salt approach to make password recovery even more difficult still. The trick is to use different salts for different passwords. Let&rsquo;s see how that works.</p>

<h3>Using hashes and variable salts to protect passwords from fairly determined attackers</h3>


<p>To make it even harder to recover passwords from hashes, we&rsquo;re going to force the attacker to create a brand new dictionary for every single password he wants to attack. We do this by using a variable salt instead of a fixed salt. We simply choose some property of the user whose password we want to protect and use that as the salt. For example, we might use the user&rsquo;s numeric primary key, or perhaps the username.</p>

<p>You can see that with this scheme there is no single dictionary that will support the attack. The attacker has to create a new dictionary for each password. The attacker has to have much more patience and be much more determined in order for this attack to work, because now the work is linear in the number of users instead of constant. Of course, the attacker can make his job easier by attacking only a subset of the users or else by focusing on some subset of the dictionary words, but in general the computing problem is more intensive (even though no more difficult logically speaking).</p>

<p>When choosing a property to use as the salt, take care not to choose something that might change. If, for example, you were to choose the user&rsquo;s e-mail address and the user subsequently changed the e-mail address, then the user would suddenly lose the ability to log in.</p>

<p>Our defenses are getting beefier and beefier, but still it&rsquo;s not entirely unlikely that somebody with enough patience and determination could crack our passwords. Can we make it even harder?</p>

<h3>Using key strengthening to protect passwords from strongly determined attackers</h3>


<p>There&rsquo;s a trick we can use called <em>key strengthening</em> or <em>key stretching</em>. The idea is to increase the time associated with recovering any given password so as to increase the amount of patience and determination required on the part of the attacker. It&rsquo;s simple to implement. Take the initial password + variable-salt combination (you could use a fixed salt too, but as we saw above, variable salts turn a constant-time problem into a linear-time problem), hash it iteratively some large number of times&mdash;say 1,000 times&mdash;and store the final result in the password database. The exact number of iterations is strongly dependent on the environment; you want the number of iterations to be small enough that it doesn&rsquo;t impact legitimate end users in a meaningful way when they try to log in (they shouldn&rsquo;t have to wait more than a second or two), but large enough that if you try to hash an entire dictionary, you&rsquo;re going to be waiting an awful long time. If you have lots of end users and logins, you also have to be careful that you don&rsquo;t introduce too much CPU load on your system since hashing is compute-intensive. (It&rsquo;s easy enough to imagine building out a compute farm if you really intend to get this serious about storing passwords securely.)</p>

<p>Can this scheme be broken? Yes, of course. But once again we&rsquo;ve narrowed the circle of folks who are going to attempt it. Most attackers are going to look for a much easier target. Bad for the easier targets but good for you.</p>

<h3>Summary</h3>


<p>In this article we&rsquo;ve considered a series of increasingly sophisticated techniques for protecting your user passwords from attackers. As often happens with engineering, it&rsquo;s important to recognize that there&rsquo;s a tradeoff you&rsquo;re confronting here&mdash;you have to decide how to balance simplicity against security. If you&rsquo;re trying to protect passwords for an academic department&rsquo;s website, it&rsquo;s probably overkill to use key stretching. If on the other hand you&rsquo;re trying to protect financial data, key stretching may be only the starting point for you.</p>

<p>It&rsquo;s important to recognize that security isn&rsquo;t a black-or-white affair. As it does in this case, it usually involves understanding where your likely threats are and then taking measures to protect against those, and perhaps even against threats that are even a little less likely but still plausible.</p>

<div class="endnote">Post migrated from my Wheeler Software site.</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/07/17/annotation-based-validation-with-the-spring-bean-validation-framework/">Annotation-based Validation With the Spring Bean Validation Framework</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-07-17T16:35:36-07:00" pubdate data-updated="true">Jul 17<span>th</span>, 2008</time>
        
         | <a href="/2008/07/17/annotation-based-validation-with-the-spring-bean-validation-framework/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="alert warning">This post predates JSR 303, which describes a standard around bean validation. The Spring Modules Bean Validation Framework isn&#8217;t compliant with that JSR, and anyway, it&#8217;s a defunct library. Use <a href="http://springinpractice.com/2009/02/02/getting-started-with-hibernate-validator/">Hibernate Validator</a> instead.</div>


<p>The Spring Bean Validation Framework, which is part of the <a href="https://springmodules.dev.java.net/">Spring Modules</a> project, allows you to perform validation declaratively using Java annotations. I&rsquo;ve always liked the declarative approach, which we saw for instance in Commons Validator, but annotation-based validation is especially convenient.</p>

<p><a href="http://jcp.org/en/jsr/detail?id=303">JSR 303 (Bean Validation)</a> specifies some standards around bean validation, though the Spring Bean Validation Framework does not adopt those standards. The <a href="http://www.hibernate.org/412.html">Hibernate Validator</a> project, on the other hand, aims to provide an implementation of the emerging JSR 303 standard.</p>

<p>While it very well could be subpar Googling skills on my part, there doesn&rsquo;t seem to be much detailed how-to information out there on actually using the Bean Validation Framework.  Hence this article.</p>

<p>I&rsquo;m using Spring 2.5.x (specifically, Spring 2.5.5) and Spring Modules 0.9.  I assume that you already know Spring and Spring Web MVC in particular.</p>

<p>If you want to download the code, you can do so here:</p>

<center><span class="icon archive"><a href="http://wheelersoftware.s3.amazonaws.com/articles/spring-bean-validation-framework/contact-example.zip">contact-example.zip</a></span></center>


<p>You&rsquo;ll have to download the dependencies separately though.</p>

<h3>Dependencies</h3>


<p>Here&rsquo;s what you&rsquo;ll need (again, I&rsquo;m using Spring 2.5.x and Spring Modules 0.9):</p>

<ul class="square">
    <li><code>commons-collections.jar</code></li>
    <li><code>commons-lang.jar</code></li>
    <li><code>commons-logging.jar</code></li>
    <li><code>spring.jar</code></li>
    <li><code>spring-modules-validation.jar</code></li>
    <li><code>spring-webmvc.jar</code></li>
</ul>




<h3>Java sources</h3>


<p>I&rsquo;m going to do things a little differently than I normally do, and start with the Java first.  We&rsquo;re going to build a very simple &ldquo;Contact Us&rdquo; form of the sort that you might use to ask a question, complain about lousy service, or whatever.  Since we&rsquo;re just showing how validation works, I&rsquo;ve left out the service and persistence tiers.  We&rsquo;re going to do everything with a form bean and a controller.</p>

<p>Here&rsquo;s the form bean:</p>

<div>
<span class="code-listing">Code listing:</span> <code>contact.UserMessage</code>
<pre name="code" class="java">
package contact;

import org.springmodules.validation.bean.conf.loader.annotation.handler.Email;
import org.springmodules.validation.bean.conf.loader.annotation.handler.Length;
import org.springmodules.validation.bean.conf.loader.annotation.handler.NotBlank;

public final class UserMessage {
    
    @NotBlank
    @Length(max = 80)
    private String name;
    
    @NotBlank
    @Email
    @Length(max = 80)
    private String email;
    
    @NotBlank
    @Length(max = 4000)
    private String text;
    
    public String getName() { return name; }

    public void setName(String name) { this.name = name; }
    
    public String getEmail() { return email; }

    public void setEmail(String email) { this.email = email; }

    public String getText() { return text; }

    public void setText(String text) { this.text = text; }
}
</pre>
</div>


<p>The bean itself is pretty uninteresting&mdash;I have field for the user&rsquo;s name, e-mail address, and the message text.  But the cool part is that I&rsquo;ve included annotations that specify validation constraints.  It&rsquo;s probably self-explanatory, but I&rsquo;ve specified that none of the fields is allowed to be blank, and I&rsquo;ve also specified the maximum lengths for each.  (You can also specify minimum lengths, which one could use instead of <code>@NotBlank</code>, but I&rsquo;m using <code>@NotBlank</code> instead for a reason I&rsquo;ll explain in just a bit.)  Finally, I&rsquo;ve specified that <code>email</code> needs to be a valid e-mail address.  It&rsquo;s that simple!</p>

<p>Here are <a href="https://springmodules.dev.java.net/docs/reference/0.8/html_single/#d0e9699">the rest of the validation rules</a> you can use.</p>

<p>Now here&rsquo;s the Spring MVC controller, which I&rsquo;ve implemented as a POJO controller:</p>

<div>
<span class="code-listing">Code listing:</span> <code>contact.ContactController</code>
<pre name="code" class="java">
package contact;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.validation.BindingResult;
import org.springframework.validation.Validator;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@Controller
public final class ContactController {
    
    @Autowired
    private Validator validator;
    
    public void setValidator(Validator validator) {
        this.validator = validator;
    }
    
    @RequestMapping(value = "/form", method = RequestMethod.GET)
    public ModelMap get() {
        
        // Because we're not specifying a logical view name, the
        // DispatcherServlet's DefaultRequestToViewNameTranslator kicks in.
        return new ModelMap("userMessage", new UserMessage());
    }
    
    @RequestMapping(value = "/form", method = RequestMethod.POST)
    public String post(@ModelAttribute("userMessage") UserMessage userMsg,
            BindingResult result) {
        
        validator.validate(userMsg, result);
        if (result.hasErrors()) { return "form"; }
        
        // Use the redirect-after-post pattern to reduce double-submits.
        return "redirect:thanks";
    }
    
    @RequestMapping("/thanks")
    public void thanks() {
    }
}
</pre>
</div>


<p>The Bean Validation Framework includes its own <code>Validator</code> implementation, called <code>BeanValidator</code>, and I&rsquo;m making that injectable here.  Also, note that we&rsquo;re going to autowire it in.</p>

<p>It may be that there&rsquo;s a standard, predefined interceptor to apply <code>BeanValidator</code> (as opposed to injecting the <code>Validator</code> into the controller), but if there is, I haven&rsquo;t seen it.  I&rsquo;d be interested to hear if you, gentle reader, know of one.</p>

<p>The noteworthy method here is the second <code>post()</code> method, which contains the validation code.  I just call the standard <code>validate()</code> method, passing in the form bean and the <code>BindingResult</code>, and return the current logical view name if there&rsquo;s an error.  That way the form shows the validation error messages, which we&rsquo;ll see below.  If everything passes validation, I just redirect to a &ldquo;thank you&rdquo; page.</p>

<p>Now let&rsquo;s look at how we define the validation messages that the end user sees if his form submission fails validation.</p>

<h3>Validation messages</h3>




<div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/classes/errors.properties</code>
<pre name="code" class="java">
UserMessage.name[not.blank]=Please enter your name.
UserMessage.name[length]=Please enter no more than {2} characters.
UserMessage.email[not.blank]=Please enter your e-mail address.
UserMessage.email[email]=Please enter a valid e-mail address.
UserMessage.email[length]=Please enter no more than {2} characters.
UserMessage.text[not.blank]=Please enter a message.
UserMessage.text[length]=Please enter no more than {2} characters.
</pre>
</div>


<p>The keys should be fairly self-explanatory given <code>UserMessage</code> above.  Each key involves a class, a field and an annotation.  The values are parametrizable messages, not unlike Commons Validator messages if you&rsquo;re familiar with those.  In the three <code>length</code> messages, I&rsquo;m using <code>{2}</code> to indicate argument #2&mdash;viz., <code>max</code>&mdash;for the <code>length</code> validation rule.  Argument #1 happens to be <code>min</code>, and argument #0 in general appears to be the form bean itself.  I can imagine that it would be nice to be able to use the form bean to get at the specific submitted value so you could say things like &ldquo;You entered 4012 characters, but the limit is 4000 characters.&rdquo;  And I think there&rsquo;s actually a way to do that though I don&rsquo;t myself know how to do it yet.  (This is another one of those areas where I&rsquo;d appreciate whatever information you may have.)</p>

<p>I mentioned above that I chose <code>@NotBlank</code> instead of <code>@Length(min = 1, max = 80)</code>.  The reason is that I wanted to use a specific error message (&ldquo;Please enter your name&rdquo;) if the message is blank.  I could have just used &ldquo;Please enter a name between 1-80 characters&rdquo; but that sounds slightly silly compared to &ldquo;Please enter your name&rdquo;, and since I&rsquo;m a usability guy I care about such things.</p>

<h3>The JSPs</h3>


<p>We have two JSPs: the form itself, and a basic (really basic) &ldquo;thank you&rdquo; page.</p>

<div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/form.jsp</code>
<pre name="code" class="xml">
&lt;%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %&gt;

&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
    &lt;head&gt;
        &lt;title&gt;Contact Us&lt;/title&gt;
        &lt;style&gt;
            .form-item { margin: 20px 0; }
            .form-label { font-weight: bold; }
            .form-error-field { background-color: #FFC; }
            .form-error-message { font-weight: bold; color: #900; }
        &lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
    
&lt;h1&gt;Contact Us&lt;/h1&gt;

&lt;%-- Give command object a meaningful name instead of using default name, 'command' --%&gt;
&lt;form:form commandName="userMessage"&gt;
    &lt;div class="form-item"&gt;
        &lt;div class="form-label"&gt;Your name:&lt;/div&gt;
        &lt;form:input path="name" size="40" cssErrorClass="form-error-field"/&gt;
        &lt;div class="form-error-message"&gt;&lt;form:errors path="name"/&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="form-item"&gt;
        &lt;div class="form-label"&gt;Your e-mail address:&lt;/div&gt;
        &lt;form:input path="email" size="40" cssErrorClass="form-error-field"/&gt;
        &lt;div class="form-error-message"&gt;&lt;form:errors path="email"/&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="form-item"&gt;
        &lt;div class="form-label"&gt;Your message:&lt;/div&gt;
        &lt;form:textarea path="text" rows="12" cols="60" cssErrorClass="form-error-field"/&gt;
        &lt;div class="form-error-message"&gt;&lt;form:errors path="text"/&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="form-item"&gt;
        &lt;input type="submit" value="Submit" /&gt;
    &lt;/div&gt;
&lt;/form:form&gt;

    &lt;/body&gt;
&lt;/html&gt;
</pre>
</div>


<p>This is just a standard Spring Web MVC form, so I&rsquo;ll invoke my &ldquo;I assume you know Spring Web MVC&rdquo; assumption here.  The <code>cssErrorClass</code> attribute is kind of fun if you don&rsquo;t already know about it.  It indicates the CSS class to use in the event of a validation error.  You can combine that with the <code>cssClass</code> attribute (which applies in the non-error case) though I haven&rsquo;t done that here.</p>

<p>Now here&rsquo;s the basic &ldquo;thank you&rdquo; page:</p>

<div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/thanks.jsp</code>
<pre name="code" class="xml">
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
    &lt;head&gt;
        &lt;title&gt;Thank You&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Thank You&lt;/h1&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
</div>


<p>(I told you it was basic&hellip;)</p>

<p>OK, now we&rsquo;re ready to move onto application configuration.  Almost done!</p>

<h3>Servlet and Spring configuration</h3>


<p>Here&rsquo;s our completely standard <code>web.xml</code>:</p>

<div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/web.xml</code>
<pre name="code" class="xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
        http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
    version="2.5"&gt;
    
    &lt;servlet&gt;
        &lt;servlet-name&gt;contact&lt;/servlet-name&gt;
        &lt;servlet-class&gt;
            org.springframework.web.servlet.DispatcherServlet
        &lt;/servlet-class&gt;
    &lt;/servlet&gt;
    
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;contact&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/contact/*&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;        
&lt;/web-app&gt;
</pre>
</div>


<p>Though I said I&rsquo;m assuming you already know Spring Web MVC, I&rsquo;ll just point out that since I didn&rsquo;t specify a custom location for the application context file, I have to put it at <code>/WEB-INF/contact-servlet.xml</code>.  If you want the file to live elsewhere, or if you want it to be associated with the servlet context instead of the <code>DispatcherServlet</code>, you&rsquo;ll have to set that up in <code>web.xml</code> accordingly.</p>

<p>Here&rsquo;s the Spring application context:</p>

<div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/contact-servlet.xml</code>
<pre name="code" class="xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd"&gt;
    
    &lt;!-- Enable annotation-based validation using Bean Validation Framework --&gt;
    &lt;!-- Using these instead of vld namespace to prevent Eclipse from complaining --&gt;
    &lt;bean id="configurationLoader"
        class="org.springmodules.validation.bean.conf.loader.annotation.AnnotationBeanValidationConfigurationLoader"/&gt;
    &lt;bean id="validator" class="org.springmodules.validation.bean.BeanValidator"
        p:configurationLoader-ref="configurationLoader"/&gt;
    
    &lt;!-- Load messages --&gt;
    &lt;bean id="messageSource"
        class="org.springframework.context.support.ResourceBundleMessageSource"
        p:basenames="errors"/&gt;

    &lt;!-- Discover POJO @Components --&gt;
    &lt;!-- These automatically register an AutowiredAnnotationBeanPostProcessor --&gt;
    &lt;context:component-scan base-package="contact"/&gt;
    
    &lt;!-- Map logical view names to physical views --&gt;
    &lt;bean class="org.springframework.web.servlet.view.InternalResourceViewResolver"
        p:prefix="/WEB-INF/"
        p:suffix=".jsp"/&gt;
&lt;/beans&gt;
</pre>
</div>


<p>(<strong>IMPORTANT:</strong> In the <code>configurationLoader</code> definition, make sure you put the class name on a single line.  I had to break it up for formatting purposes.)</p>

<p>If you&rsquo;re not familiar with it, I&rsquo;m using the <code>p</code> namespace here for syntactic sugar&mdash;it allows me to specify properties using a nice shorthand.</p>

<p>The first two beans basically create the <code>BeanValidator</code> instance we&rsquo;re going to use.  It turns out that instead of defining these two beans explicitly, you can use a special element from a special namespace:</p>

<ul class="square">
    <li>namespace is <code>xmlns:vld="http://www.springmodules.org/validation/bean/validator"</code>;</li>
    <li>purported schema location is <code>http://www.springmodules.org/validation/bean/validator-2.0.xsd</code>;</li>
    <li>element is <code>&lt;vld:annotation-based-validator id="validator"/&gt;</code></li>
</ul>


<p>But when I do it, Eclipse complains (even though the code works when you run it) since there isn&rsquo;t at the time of this writing actually an XSD at the specified location.  (At least there&rsquo;s a <a href="http://jira.springframework.org/browse/MOD-464">JIRA ticket</a> for it.)  So I&rsquo;ll just use the two beans for now.</p>

<p>The other stuff is mostly normal Spring Web MVC stuff.  I put the message source on the app context, scan for the controller (which is why I&rsquo;m autowiring the validator into the controller), and put a view resolver on the context too.</p>

<h3>Finis</h3>


<p>Build and deploy your WAR, and then point your browser to your web app; for example:</p>

<center>http://localhost:8080/contact-example/contact/form</center>


<p>Try submitting the form with empty fields, or an invalid e-mail address, or fields that are too long.  If things are working correctly, you ought to see error messages and even field highlighting when validation fails.</p>

<div class="endnote">Post migrated from my Wheeler Software site.</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/05/15/send-e-mail-using-spring-and-javamail/">Send E-mail Using Spring and JavaMail</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-05-15T14:18:08-07:00" pubdate data-updated="true">May 15<span>th</span>, 2008</time>
        
         | <a href="/2008/05/15/send-e-mail-using-spring-and-javamail/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This brief tutorial will show how to send e-mail using Spring and JavaMail. JavaMail can handle e-mail storage as well, but here we&rsquo;re just worrying about sending e-mail.</p>

<p>I happen to be using Spring 2.5 but this ought to work for earlier versions of Spring as well (at least Spring 2.0 I think).</p>

<p>Let&rsquo;s jump right in. You can configure your JavaMail session either in Spring itself or with JNDI. We&rsquo;ll look at both alternatives.</p>

<h3>Alternative 1: Configuring JavaMail with Spring</h3>


<p>You may be operating in an environment where you don&rsquo;t have a JNDI enterprise naming context (ENC) available. No problem; you can just configure JavaMail in the Spring application context configuration as shown below.</p>

<pre>&lt;!-- Mail service --&gt;
&lt;bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl"&gt;
    &lt;property name="host" value="your.smtphost.com"/&gt;
    &lt;property name="port" value="25"/&gt;
    &lt;property name="username" value="yourusername"/&gt;
    &lt;property name="password" value="yourpassword"/&gt;
    &lt;property name="javaMailProperties"&gt;
        &lt;props&gt;
            &lt;!-- Use SMTP-AUTH to authenticate to SMTP server --&gt;
            &lt;prop key="mail.smtp.auth"&gt;true&lt;/prop&gt;
            &lt;!-- Use TLS to encrypt communication with SMTP server --&gt;
            &lt;prop key="mail.smtp.starttls.enable"&gt;true&lt;/prop&gt;
        &lt;/props&gt;
    &lt;/property&gt;
&lt;/bean&gt;</pre>


<p>This bean is, as its name suggests, a mail sender. It is basically a wrapper around JavaMail SMTP, and the configuration reflects that. In the example I&rsquo;m showing how you would enable SMTP-AUTH (supports authentication to the SMTP server) and TLS (supports message encryption), assuming your SMTP server has those capabilities. For more information see my article <a href="http://springinpractice.com/2008/05/05/smtp-and-smtp-auth/">SMTP and SMTP-AUTH</a>.</p>

<p><strong>IMPORTANT:</strong> You will need to inject <code>mailSender</code> into your mail-sending service bean.</p>

<p>So that&rsquo;s how to configure JavaMail from Spring. Now here&rsquo;s how to do the same thing with JNDI, which you may want to do if you&rsquo;re running in an environment with a JNDI ENC (like an app server or a servlet container).</p>

<h3>Alternative 2: Configuring JavaMail with JNDI</h3>




<h4>Server JNDI configuration (using Tomcat 6 as an example)</h4>


<p>(For a Jetty configuration using Gmail, see <a href="http://springinpractice.com/2012/04/29/configuring-jetty-to-use-gmail-as-an-smtp-provider/">Configuring Jetty to use Gmail as an SMTP provider</a>.)</p>

<p>First you will need to expose a JavaMail session factory through JNDI in your server environment. This is environment-dependent, but let&rsquo;s look at an example.</p>

<p>Say you&rsquo;re using Tomcat 6. There are a couple things you must do. First, move <code>mail.jar</code> and <code>activation.jar</code> to your <code>tomcat/lib</code> directory. I say &ldquo;move&rdquo; rather than &ldquo;copy&rdquo; because you will get an odd error if you leave the two JARs in your application classpath. The error is</p>

<pre>java.lang.IllegalArgumentException: 
    Cannot convert value of type [javax.mail.Session] to required type
    [javax.mail.Session] for property 'session': no matching editors
    or conversion strategy found</pre>


<p>Second, define your Tomcat JNDI configuration, which might look like this (e.g. in your <code>context.xml</code> file):</p>

<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;Context path="/myapp" docBase="myapp" debug="5" crossContext="false"&gt;

    &lt;!-- JavaMail session factory --&gt;
    &lt;Resource name="mail/Session"
              auth="Container"
              type="javax.mail.Session"
              username="yourusername"
              password="yourpassword"
              mail.debug="true"
              mail.user="yourusername"
              mail.password="yourpassword"
              mail.transport.protocol="smtp"
              mail.smtp.host="your.smtphost.com"
              mail.smtp.auth="true"
              mail.smtp.port="25"
              mail.smtp.starttls.enable="true"/&gt;
&lt;/Context&gt;</pre>


<p>As with the non-JNDI example, I&rsquo;m configuring for SMTP-AUTH and TLS. If you are using SMTP-AUTH (authenticated SMTP sessions, which you activate using <code>mail.smtp.auth=&ldquo;true&rdquo;</code>), then you will need to specify the username and password twice, as shown above. Also, if your SMTP server supports it, you can tell JavaMail to encrypt sessions using TLS by setting <code>mail.smtp.starttls.enable=true</code>.</p>

<p>The above discussion applies only to Tomcat 6 (see <a href="http://tomcat.apache.org/tomcat-6.0-doc/jndi-resources-howto.html">Apache Tomcat 6.0 JNDI Resources HOWTO</a> for detailed instructions); you&rsquo;ll need to consult your server docs to expose a JavaMail session factory through JNDI in your environment.</p>

<h4>Spring configuration</h4>


<p>We still need to create a mail sender, but the configuration is simpler since we did all the heavy lifting in <code>context.xml</code> (or whatever, depending on your server environment). So for the Spring application context, all we need is:</p>

<pre>&lt;bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl"&gt;
    &lt;property name="session" ref="mailSession"/&gt;
&lt;/bean&gt;</pre>


<p><strong>IMPORTANT:</strong> As before, you will need to inject <code>mailSender</code> into your mail-sending service bean.</p>

<p>So that takes care of configuring the mail sender, and also the JavaMail session factory if you are using JNDI. Let&rsquo;s visit one more topic before we dive into the code itself.</p>

<h3>Creating an e-mail template (optional)</h3>


<p>Sometimes the e-mail you want to send fits inside a standard template (e.g., maybe it always has the same sender, or maybe the same recipient, or whatever). You can define a template using Spring. Here&rsquo;s an example:</p>

<pre>&lt;!-- Mail message --&gt;
&lt;bean id="mailMessage" class="org.springframework.mail.SimpleMailMessage"&gt;
    &lt;property name="from"&gt;
        &lt;value&gt;&lt;![CDATA[Simple Application Monitor &lt;noreply@somehost.com&gt;]]&gt;&lt;/value&gt;
    &lt;/property&gt;
    &lt;property name="to"&gt;
        &lt;value&gt;&lt;![CDATA[System Administrator &lt;sysadmin@somehost.com&gt;]]&gt;&lt;/value&gt;
    &lt;/property&gt;
    &lt;property name="subject" value="SAM Alert"/&gt;
&lt;/bean&gt;</pre>


<p>You can include as many e-mail templates in a Spring app context configuration, including none if you don&rsquo;t need a template. Here I&rsquo;ve defined a template that specifies a &ldquo;from&rdquo; field, a &ldquo;to&rdquo; field and a &ldquo;subject&rdquo; field. It doesn&rsquo;t specify the date or the body. That template works say for an application monitoring system but it wouldn&rsquo;t work for an e-commerce site&rsquo;s order confirmation e-mail,which would need to have a variable &ldquo;to&rdquo; field.</p>

<p><strong>IMPORTANT:</strong> I didn&rsquo;t show it above, but you will need to inject any e-mail templates (i.e. mail messages) you create into your mail-sending service bean. Otherwise the service bean has no way to use the template.</p>

<p>So that&rsquo;s that. Time for the Java code that actually sends the e-mail.</p>

<h3>How to send the e-mail from your service bean</h3>


<p>It turns out that the coding part is much simpler than the configuration (not that the config was too bad). Let&rsquo;s suppose for the sake of example that we want to send an e-mail based on the template that we defined above, and that you&rsquo;ve injected that template into your service bean as <code>mailMessage</code>. Then here&rsquo;s the service bean code that allows you to use the template to send an e-mail:</p>

<pre>SimpleMailMessage message = new SimpleMailMessage(mailMessage);
message.setSentDate(new Date());
message.setText("Blah blah blah...");
mailSender.send(message);</pre>


<p>You can see we&rsquo;re creating a new message based on the <code>mailMessage</code> e-mail template and <code>mailSender</code> that we injected into said service bean.</p>

<p>And that&rsquo;s it!</p>

<p><span class="icon stickyNote">Post migrated from my Wheeler Software site.</span></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/05/08/session-scoped-beans-in-spring/">Session-scoped Beans in Spring</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-05-08T05:50:20-07:00" pubdate data-updated="true">May 8<span>th</span>, 2008</time>
        
         | <a href="/2008/05/08/session-scoped-beans-in-spring/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This tutorial will show you how to define session-scoped beans in Spring.  The idea here is that you have a web application, and you have various objects that exist on a per-session basis, such as maybe a user profile or a shopping cart. You&rsquo;d like to make those available to some service bean, say, without having to manually pull them off the session and pass them as method arguments every time.  First I&rsquo;ll show you how to do that.  After that I&rsquo;ll talk a little bit about whether I think it&rsquo;s a good idea.</p>

<p>Here&rsquo;s the code for this article: <a href="http://wheelersoftware.s3.amazonaws.com/articles/spring-session-scoped-beans/ssb-example.zip">ssb-example.zip</a></p>

<p>The code uses annotation-based autowiring. If you are unfamiliar with that and it&rsquo;s not reasonably clear what I&rsquo;m doing with the code, you might want to see my articles <a href="#">Annotation-Based Autowiring in Spring 2.5</a> and <a href="#">Annotation-Based MVC in Spring 2.5</a>.</p>

<h3>Dependencies</h3>


<p>I&rsquo;m using Java 6 (though Java 5 should work too) and Spring 2.5.4 (though Spring 2.5.x should work generally).  You will need the following JARs:</p>

<ul>
    <li><code>cglib-nodep-2.1_3.jar</code></li>
    <li><code>commons-logging.jar</code></li>
    <li><code>spring.jar</code></li>
    <li><code>spring-webmvc.jar</code></li>
</ul>




<h3>Java classes</h3>


<p>We have four classes: a controller, a service interface, a service implementation, and a model class.</p>

<p>First, the controller:</p>

<pre>package ssbexample;

import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.ModelAndView;

@Controller
public class MyController {
    private String SHOPPING_CART_KEY = "shoppingCart";
    
    private MyService service;

    public MyService getService() {
        return service;
    }

    public void setService(MyService service) {
        this.service = service;
    }
    
    @RequestMapping("/viewcart.do")
    public ModelMap viewCart() {
        return new ModelMap(SHOPPING_CART_KEY, service.getShoppingCart());
    }
    
    @RequestMapping("/additem.do")
    public ModelAndView addItem() {
        service.addItem();
        ShoppingCart cart = service.getShoppingCart();
        return new ModelAndView("/viewcart", SHOPPING_CART_KEY, cart);
    }
}</pre>


<p>The thing to notice about the controller code is that I&rsquo;m grabbing the shopping cart from the service bean itself, rather than pulling it off of the session directly.  That means that the service bean is somehow able to return a session-specific shopping cart.  (And we&rsquo;ll see how to do that shortly.)  We&rsquo;re also able to tell the service to add an item (to the cart), and the service once again knows exactly which cart to add the item to.</p>

<p>Now here&rsquo;s the service interface:</p>

<pre>package ssbexample;

public interface MyService {
    
    ShoppingCart getShoppingCart();
    
    void addItem();
}</pre>


<p>Here&rsquo;s the service implementation:</p>

<pre>package ssbexample;

import org.springframework.stereotype.Service;

@Service("service")
public class MyServiceImpl implements MyService {
    private ShoppingCart shoppingCart;

    public ShoppingCart getShoppingCart() {
        return shoppingCart;
    }
    
    public void setShoppingCart(ShoppingCart shoppingCart) {
        this.shoppingCart = shoppingCart;
    }
    
    public void addItem() {
        shoppingCart.addItem();
    }
}</pre>


<p>Notice that with the shopping cart getter and setter, we have a way to inject a shopping cart into the service bean.  But we have only a single service bean instance, so it looks a little bit like magic right now.</p>

<p>And finally, here&rsquo;s the model class itself (a simple shopping cart):</p>

<pre>package ssbexample;

import java.io.Serializable;

public class ShoppingCart implements Serializable {
    private int numItems;
    
    public ShoppingCart() {
    }
    
    public int getNumItems() {
        return numItems;
    }
    
    public void addItem() {
        numItems++;
    }
}</pre>


<p>As you may have guessed, the shopping cart is the object we want to save on the session.  I&rsquo;ve implemented <code>Serializable</code> so the servlet container can save the session when you shut it down. (Tomcat does that, anyway.)</p>

<h3>The JSP</h3>


<p>We have just one JSP.</p>

<pre>&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;View Shopping Cart&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;View Shopping Cart&lt;/h1&gt;
        &lt;p&gt;Your shopping cart currently contains ${shoppingCart.numItems} items.&lt;/p&gt;
        &lt;p&gt;&lt;a href="additem.do"&gt;Add item to cart&lt;/a&gt;&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>




<h3>web.xml configuration file</h3>


<p>Nothing special here:</p>

<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
        http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
    version="2.5"&gt;
    
    &lt;servlet&gt;
        &lt;servlet-name&gt;front&lt;/servlet-name&gt;
        &lt;servlet-class&gt;
            org.springframework.web.servlet.DispatcherServlet
        &lt;/servlet-class&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;front&lt;/servlet-name&gt;
        &lt;url-pattern&gt;*.do&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</pre>


<p>Now let&rsquo;s look at our Spring configuration file, which is where the aforementioned magic happens.</p>

<h3>Spring application context</h3>


<p>Here&rsquo;s our Spring config:</p>

<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:aop="http://www.springframework.org/schema/aop"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-2.5.xsd"
    default-autowire="byName"&gt;
    
    &lt;!-- Scan for controllers and services --&gt;
    &lt;context:component-scan base-package="ssbexample"/&gt;
    
    &lt;!-- Create a proxy to generate session-scoped shopping carts --&gt;
    &lt;bean id="shoppingCart" class="ssbexample.ShoppingCart" scope="session"&gt;
        &lt;!-- This requires CGLIB --&gt;
        &lt;aop:scoped-proxy/&gt;
    &lt;/bean&gt;
    
    &lt;!-- Maps a logical view name to a physical resource --&gt;
    &lt;bean class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;
        &lt;property name="prefix" value="/WEB-INF/jsp/"/&gt;
        &lt;property name="suffix" value=".jsp"/&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</pre>


<p>As I noted at the outset, we&rsquo;re autowiring here, so I&rsquo;ll just point out that the <code>shoppingCart</code> bean is automatically injected into the <code>service</code> bean (identified by the <code>@Service(&ldquo;service&rdquo;)</code> annotation inside <code>ssbexample.MyServiceImpl</code>) since I have <code>default-autowire=&ldquo;byName&rdquo;</code> set in the Spring config.</p>

<p>On the <code>shoppingCart</code> bean, we have the scope set to <code>session</code>, which is probably unsurprising.  But that&rsquo;s not the whole story.</p>

<p>The interesting thing about the injection is that we&rsquo;re not injecting any particular shopping cart into the service bean.  Rather we&rsquo;re injecting a web-aware proxy into the service bean.  That&rsquo;s what <code>&lt;aop:scoped-proxy/&gt;</code> is for.  The proxy, being web-aware, can see individual user sessions.  So when any particular user asks for a shopping cart, the proxy grabs the shopping cart off the current session and returns it.</p>

<p>Note that in order to use session scope, you have to be using a web-aware Spring application context, such as <code>XmlWebApplicationContext</code>.  Otherwise there&rsquo;s no way for the scoped proxy to reference a current session.</p>

<h3>Discussion</h3>


<p>I think that this is a pretty nice tool to have in your toolbox. Using this technique, you can move the creation of session-scoped beans into the Spring application context, instead of having to create those manually in the code, and then having to place them manually on the session.  And it does make the service API cleaner, because you can avoid having to include important objects (like a shopping cart) in all the method signatures.  So I like that about session-scoped beans.</p>

<p>The main reservation I have is that despite appearances, there&rsquo;s an important sense in which using session scoping ties the code to Spring, which goes against the whole Spring philosophy of being noninvasive.  Usually service beans are designed and implemented such that a single service bean serves multiple clients, each with its own client session.  And as long as we&rsquo;re able to inject a web-aware shopping cart proxy into the shopping cart slot, we haven&rsquo;t abandoned that.  But that&rsquo;s the problem: if we decide to move away from Spring, we may find ourselves without easy access to a web-aware shopping cart proxy, and so we&rsquo;re forced to redesign the service bean in some way (such as changing the service methods to include a shopping cart parameter).</p>

<p>I don&rsquo;t think this concern invalidates the approach, but it&rsquo;s important to understand its ramifications.</p>

<p><span class="icon stickyNote">Post migrated from my Wheeler Software site.</span></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/05/07/build-a-shopping-cart-with-spring-web-flow-2-part-3/">Build a Shopping Cart With Spring Web Flow 2, Part 3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-05-07T10:51:39-07:00" pubdate data-updated="true">May 7<span>th</span>, 2008</time>
        
         | <a href="/2008/05/07/build-a-shopping-cart-with-spring-web-flow-2-part-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="intro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/05/05/build-a-shopping-cart-with-spring-web-flow-2-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/05/06/build-a-shopping-cart-with-spring-web-flow-2-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/05/07/build-a-shopping-cart-with-spring-web-flow-2-part-3/">Part 3</a></span>
</div>




<h3>Building out the application</h3>


<p>Now that we&rsquo;ve gotten Spring MVC and SWF working, it&rsquo;s time to build out the shopping cart application.  Please download the following file before continuing:</p>

<center><span class="icon archive"><a href="http://wheelersoftware.s3.amazonaws.com/articles/spring-web-flow-2.0/mycart3.zip">mycart3.zip</a></span></center>


<p>We won&rsquo;t be looking at every aspect of this application, but I&rsquo;ll highlight the most interesting pieces from a SWF point of view.</p>

<h4>Dependencies for mycart3.zip</h4>


<p>Besides the dependencies we had for <code>mycart2.zip</code>, there are four others you&rsquo;ll need:</p>

<ul class="square">
<li><code>cglib-nodep-2.1_3.jar</code></li>
<li><code>jstl.jar</code></li>
<li><code>standard.jar</code></li>
<li><code>sitemesh-2.3.jar</code> (from <a href="http://www.opensymphony.com/sitemesh/download.action">www.opensymphony.com/sitemesh/download.action</a>)</li>
</ul>


<p>After you download <code>mycart3.zip</code> (and its dependencies), you can deploy it and then point your browser at</p>

<p><p style="text-align:center"><a href="http://localhost:8080/mycart/home.do">http://localhost:8080/mycart/home.do</a></p>

<p>Here are some notes to keep in mind:</p>

<p><ul class="square"></p>

<p><li>My registration and login flows don&rsquo;t actually &ldquo;do&rdquo; anything. They&rsquo;re not hooked up to Spring Security and they&rsquo;re not hooked up to a database.  So when you register you can just hit the submit button,and when you log in you can just hit the login button.  I just wanted to focus on the flows themselves.</li></p>

<p><li>I&rsquo;m using Sitemesh to ensure a unified layout across the pages. Even if you are not familiar with Sitemesh, don&rsquo;t worry: it is very straightforward.  Basically you just put a servlet filter in front of the pages and the filter decorates the pages with a template (<code>/WEB-INF/jsp/pagetemplate.jsp</code> in this case) according to a simple configuration file (<code>/WEB-INF/decorators.xml</code>). If however you don&rsquo;t want to use Sitemesh, simply remove the filter from <code>web.xml</code> and Sitemesh is gone.</li></p>

<p></ul></p>

<p><h3>Multiple flows</h3></p>

<p>Any given app may contain multiple flows, and <code>mycart3</code> is such an app.  We have four different flows:</p>

<p><ul class="square">
<li><code>addToCart</code>: add an item to a shopping cart</li>
<li><code>checkout</code>: shopping cart checkout process</li>
<li><code>login</code>: log into the app</li>
<li><code>register</code>: register for a new user account</li>
</ul></p>

<p>In some of the cases we have what we would intuitively consider a flow in that there are multiple states involved; in other cases there is only one state to speak of and so it may seem strange to regard the flow as being a flow.  However we&rsquo;ll see how that can make sense in the following section.</p>

<p>To create multiple flows, you will need to do the following. First, create the flow definition files and put them in your <code>/WEB-INF/flows</code> directory (or wherever you decided to put them).  Then add the flow locations to the flow registry, and the flow URL mappings to your <code>SimpleUrlHandlerMapping</code> (if that&rsquo;s what you&rsquo;re using), in your Spring application context, like so:</p>

<p><div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/mycart-servlet.xml</code>
<pre name="code" class="xml">&hellip;</p>

<p>&lt;bean id=&ldquo;flowUrlMappings&rdquo; class=</p>

<pre><code>    "org.springframework.web.servlet.handler.SimpleUrlHandlerMapping"&amp;gt;
&amp;lt;property name="mappings"&amp;gt;
    &amp;lt;value&amp;gt;
        /addToCart.do=flowController
        /checkout.do=flowController
        /account/login.do=flowController
        /account/register.do=flowController
    &amp;lt;/value&amp;gt;
&amp;lt;/property&amp;gt;
&amp;lt;property name="alwaysUseFullPath" value="true"/&amp;gt;
</code></pre>

<p>&lt;/bean&gt;</p>

<p>&lt;flow:flow-registry id=&ldquo;flowRegistry&rdquo; flow-builder-services=&ldquo;flowBuilderServices&rdquo;&gt;</p>

<pre><code>&amp;lt;flow:flow-location path="/WEB-INF/flows/addToCart.xml"/&amp;gt;
&amp;lt;flow:flow-location path="/WEB-INF/flows/checkout.xml"/&amp;gt;
&amp;lt;flow:flow-location path="/WEB-INF/flows/login.xml"/&amp;gt;
&amp;lt;flow:flow-location path="/WEB-INF/flows/register.xml"/&amp;gt;
</code></pre>

<p>&lt;/flow:flow-registry&gt;</p>

<p>&hellip;</pre>
</div></p>

<p>Once you have those in place you should be set up for multiple flows.  Point your links at them and try them out!</p>

<p><h3>Subflows</h3></p>

<p>Going hand-in-hand with the idea of multiple flows is the idea that some flows might be subflows of other flows.  In <code>mycart3</code>,all four flows can be independently accessed, but in addition to that we have the <code>addToCart</code>, <code>login</code> and <code>register</code> flows being subflows to the <code>checkout</code> flow.  See Figure 3.</p>

<p><div style="margin:20px 0;text-align:center"></p>

<pre><code>&lt;div&gt;&lt;img src="http://wheelersoftware.s3.amazonaws.com/articles/spring-web-flow-2.0/subflows.jpg" alt="Figure 3. Subflows." /&gt;&lt;/div&gt;
&lt;div class="caption"&gt;Figure 3. Subflows.&lt;/div&gt;
</code></pre>

<p></div></p>

<p>Here&rsquo;s the idea.  The three flows we&rsquo;ve identified as subflows are defined as separate flows because clearly there are use cases where it makes sense for them to be accessed outside of a checkout process. For example, we want to be able to add products to a shopping cart while we&rsquo;re browsing the product catalog.  And of course we want people to be able to register and login even if they&rsquo;re not in a checkout process.</p>

<p>But those are also flows that we might want to include as part of a checkout process too.  During checkout, we might want to recommend products to the customer.  Or if the user hasn&rsquo;t yet logged in or registered, we&rsquo;d want them to do that as part of the checkout process rather than forcing them to do that before they could enter the checkout process.</p>

<p>By defining the login, registration and add-to-cart as flows, we make them available both independently (as top-level flows) and also as part of a larger flow (like the checkout flow).  That&rsquo;s why we have these defined as flows even though they are currently implemented as single-state flows.  (It is however easy to imagine these being multi-state flows.  For example, the login flow may ask you to answer a challenge question if it detects that you&rsquo;re coming in from an unusual IP address, or the add-to-cart flow may ask you to enter a quantity before proceeding.)</p>

<p>So here is the checkout flow:</p>

<p><div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/flows/checkout.xml</code>
<pre name="code" class="xml">&lt;?xml version=&ldquo;1.0&rdquo; encoding=&ldquo;UTF-8&rdquo;?&gt;
&lt;flow xmlns=&ldquo;<a href="http://www.springframework.org/schema/webflow">http://www.springframework.org/schema/webflow</a>&rdquo;</p>

<pre><code>xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.springframework.org/schema/webflow
    http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"&amp;gt;

&amp;lt;!-- Get the products one time, at the beginning of the flow --&amp;gt;
&amp;lt;on-start&amp;gt;
    &amp;lt;set name="flowScope.products" value="cartService.products"/&amp;gt;
    &amp;lt;set name="flowScope.shippingOptions" value="cartService.shippingOptions"/&amp;gt;
&amp;lt;/on-start&amp;gt;

&amp;lt;!-- If not specified, the start state is the first state specified. --&amp;gt;
&amp;lt;view-state id="viewCart" view="viewcart"&amp;gt;
    &amp;lt;!-- cart is available to SWF but not stored on the session under that
         name when using AOP proxy --&amp;gt;
    &amp;lt;on-render&amp;gt;
        &amp;lt;!-- Carry cart from Spring app context to request scope --&amp;gt;
        &amp;lt;set name="requestScope.shoppingCart" value="shoppingCart"/&amp;gt;
        &amp;lt;set name="requestScope.recommendations" value="cartService.recommendations"/&amp;gt;
    &amp;lt;/on-render&amp;gt;
    &amp;lt;transition on="addToCart" to="addProductToCart"/&amp;gt;
    &amp;lt;transition on="register" to="register"/&amp;gt;
    &amp;lt;transition on="login" to="login"/&amp;gt;
&amp;lt;/view-state&amp;gt;

&amp;lt;subflow-state id="addProductToCart" subflow="addToCart"&amp;gt;
    &amp;lt;!-- This is where we go when the subflow returns. productAdded is
         the name of an end-state. --&amp;gt;
    &amp;lt;transition on="productAdded" to="viewCart"/&amp;gt;
&amp;lt;/subflow-state&amp;gt;

&amp;lt;!-- New customers create a new account before moving forward --&amp;gt;
&amp;lt;subflow-state id="register" subflow="register"&amp;gt;
    &amp;lt;transition on="accountAdded" to="paymentAndShipmentOptions"/&amp;gt;
    &amp;lt;transition on="cancelRegistration" to="viewCart"/&amp;gt;
&amp;lt;/subflow-state&amp;gt;

&amp;lt;!-- Existing customers log in before moving forward --&amp;gt;
&amp;lt;subflow-state id="login" subflow="login"&amp;gt;
    &amp;lt!-- This is where we go when the subflow returns. productAdded is
         the name of an end-state. --&amp;gt;
    &amp;lt;transition on="loginOk" to="paymentAndShipmentOptions"/&amp;gt;
&amp;lt;/subflow-state&amp;gt;

&amp;lt;!-- Payment and shipment options --&amp;gt;
&amp;lt;view-state id="paymentAndShipmentOptions" view="options"&amp;gt;
    &amp;lt;transition on="submit" to="confirmOrder"/&amp;gt;
    &amp;lt;transition on="back" to="viewCart"/&amp;gt;
&amp;lt;/view-state&amp;gt;

&amp;lt;!-- Confirm order --&amp;gt;
&amp;lt;view-state id="confirmOrder" view="confirmorder"&amp;gt;
    &amp;lt;on-render&amp;gt;
        &amp;lt;set name="requestScope.shoppingCart" value="shoppingCart"/&amp;gt;
    &amp;lt;/on-render&amp;gt;
    &amp;lt;transition on="continue" to="thankYou"&amp;gt;
        &amp;lt;evaluate expression="cartService.submitOrderForPayment()"/&amp;gt;
    &amp;lt;/transition&amp;gt;
&amp;lt;/view-state&amp;gt;

&amp;lt;!-- Thank you page --&amp;gt;
&amp;lt;view-state id="thankYou" view="thanks"&amp;gt;
    &amp;lt;transition on="continue" to="shop"/&amp;gt;
&amp;lt;/view-state&amp;gt;

&amp;lt;!-- Exit the flow, letting the user return to shopping --&amp;gt;
&amp;lt;end-state id="shop" view="externalRedirect:contextRelative:/home.do"/&amp;gt;

&amp;lt;global-transitions&amp;gt;
    &amp;lt;transition on="cancelCheckout" to="shop"/&amp;gt;
&amp;lt;/global-transitions&amp;gt;
</code></pre>

<p>&lt;/flow&gt;</pre>
</div></p>

<p>In the code above, we are using the <code>&lt;subflow-state&gt;</code> element to call a subflow from a parent flow.  The <code>subflow</code> attribute specifies one of the flows you registered with the flow registry in the Spring configuration.  The flow starts at the subflow&rsquo;s start state, and continues until the subflow hits an end state.  The end state IDs provide keys that you can reference from the calling flow to effect state transitions.  For example, in the flow above,<code>accountAdded</code> is one of the end states for the <code>register</code> flows, and so one of the <code>&lt;transition&gt;</code> elements references that end state.</p>

<p>Recall from <code>register.xml</code> (see <a href="spring-web-flow-2.0-4.html">page 4</a>) that the end states specified a <code>view</code> attribute.  If the <code>register</code> flow is called directly, then SWF will use the <code>view</code> attribute to decide which view to show the user when the flow reaches a given end state.  If, however, the flow is called as part of a subflow (instead of being called directly), SWF will ignore the <code>view</code> attribute and instead follow whatever transition is defined in the calling <code>&lt;subflow-state&gt;</code>.</p>

<p><h3>Using EL to call services</h3></p>

<p>SWF allows you to make calls against service beans using an expression language (EL).  You can use either Unified EL or else OGNL for that, as mentioned earlier in the article.  We happen to be using OGNL though I understand that Unified EL and OGNL are mostly the same,at least where their core syntax is concerned.</p>

<p>There are various places in your flow where you might want to invoke service beans, and SWF provides various mechanisms for doing that.  Here&rsquo;s a table showing how to call services from different locations in your flow definition file:</p>

<p><div class="table-with-caption"></p>

<pre><code>&lt;div class="table"&gt;
    &lt;table&gt;
        &lt;tr&gt;
            &lt;th&gt;Location&lt;/th&gt;
            &lt;th&gt;How to call the service bean&lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;On flow start&lt;/td&gt;
            &lt;td&gt;&lt;code&gt;/flow/on-start&lt;/code&gt; element&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;On state entry&lt;/td&gt;
            &lt;td&gt;&lt;code&gt;/flow/view-state/on-entry&lt;/code&gt; element&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;Immediately before rendering a view&lt;/td&gt;
            &lt;td&gt;&lt;code&gt;/flow/view-state/on-render&lt;/code&gt; element&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;On state exit&lt;/td&gt;
            &lt;td&gt;&lt;code&gt;/flow/view-state/on-exit&lt;/code&gt; element&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;On state transition&lt;/td&gt;
            &lt;td&gt;&lt;code&gt;/flow/view-state/transition/evaluate&lt;/code&gt; element&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;On flow end&lt;/td&gt;
            &lt;td&gt;&lt;code&gt;/flow/on-end&lt;/code&gt; element&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
&lt;/div&gt;
&lt;div class="caption"&gt;Table 2. How to call service beans from different locations.&lt;/div&gt;
</code></pre>

<p></div></p>

<p>Note that the above does not represent a 100% complete list of places where you can use EL, but it gives you most of the major cases and also the basic idea.</p>

<p>In <code>checkout.xml</code> we&rsquo;ve used a number of the methods above.  For example, we use <code>&lt;on-start&gt;</code> to grab the product catalog and shipping options from the cart service and place them on the flow scope, which allows them to be used for the duration of the flow.  The <code>value</code> attribute on the <code>set</code> element is specified using EL.  (It looks a lot like JSP EL, if you are familiar with that.)  The <code>cartService</code> bean is available because we defined a Spring bean with that ID.</p>

<p>We also use <code>&lt;on-render&gt;</code> to prepare the <code>viewCart</code> state for rendering.  In this case, we place the user&rsquo;s shopping cart on the request scope so the JSP can easily reference it, and we also pull some recommendations off of the cart service and place those on the request scope as well.  Once again the <code>value</code> attribute is specified using EL.</p>

<p><h3>Global transitions</h3></p>

<p>At the end of <code>checkout.xml</code>, you will see that I&rsquo;ve defined a <code>&lt;global-transitions&gt;</code> element.  This allows me to define a transition that applies to all states in the flow.  In this case, any time the user raises the <code>cancelCheckout</code> event, the global transition I&rsquo;ve defined will kick in and carry the user to the <code>shop</code> state. Pretty handy for transitions that occur in multiple places throughout the flow.</p>

<p><h3>That&rsquo;s our whirlwind tour</h3></p>

<p>That concludes this tutorial on Spring Web Flow 2.0.  We&rsquo;ve really only scratched the surface&mdash;for instance, we haven&rsquo;t even touched the new AJAX support that SWF 2.0 introduces&mdash;but this should give you an overall feel for how things work.  The SWF 2.0 distribution comes with a hotel booking sample application that shows you how to get SWF working with form validation and persistence as well (areas I&rsquo;ve suppressed in this article so that I could focus on flow definition).</p>

<p>If you have suggestions and especially corrections to the article or the code, please leave them below.  SWF 2.0 is new so I have no doubt that you will be able to show me places where I could be doing something better.  Thanks!</p>

<p><h3>Resources</h3></p>

<p>A <a href="http://www.springhispano.org/?q=node/319">Maven version of the download</a> is available. The target link is in Spanish but there&rsquo;s a zip file at the bottom called <code>WebFlowExample.zip</code> that you can download. If you want to read the target link in English, you can use <a href="http://babelfish.yahoo.com/translate_txt">Alta Vista&rsquo;s free Babel Fish translation service</a>.</p>

<p><div class="outro">
<span class="icon stickyNote">This post is part of a three-part series: <a href="http://springinpractice.com/2008/05/05/build-a-shopping-cart-with-spring-web-flow-2-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/05/06/build-a-shopping-cart-with-spring-web-flow-2-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/05/07/build-a-shopping-cart-with-spring-web-flow-2-part-3/">Part 3</a></span>
</div></p>

<p><div class="endnote">Post migrated from my Wheeler Software site.</div></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2008/05/06/build-a-shopping-cart-with-spring-web-flow-2-part-2/">Build a Shopping Cart With Spring Web Flow 2, Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-05-06T10:50:53-07:00" pubdate data-updated="true">May 6<span>th</span>, 2008</time>
        
         | <a href="/2008/05/06/build-a-shopping-cart-with-spring-web-flow-2-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="intro">
<span class="icon stickyNote">This post is part of a three part series: <a href="http://springinpractice.com/2008/05/05/build-a-shopping-cart-with-spring-web-flow-2-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/05/06/build-a-shopping-cart-with-spring-web-flow-2-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/05/07/build-a-shopping-cart-with-spring-web-flow-2-part-3/">Part 3</a></span>
</div>




<h3>Creating a simple flow: Spring application context configuration</h3>


<p>Now we have Spring MVC working, so it&rsquo;s time to expand on that and get Spring Web Flow working too.  We&rsquo;ll start by creating a very simple flow&mdash;one that has only a single view state.  First we&rsquo;ll look at the updated Spring application context configuration.  After that we&rsquo;ll look at the flow definition itself.</p>

<p>To make it easier for you to follow along, here&rsquo;s the updated,one-state version of our shopping cart:</p>

<center><span class="icon archive"><a href="http://wheelersoftware.s3.amazonaws.com/articles/spring-web-flow-2.0/mycart2.zip">mycart2.zip</a></span></center>




<h4>Dependencies for mycart2.zip</h4>


<p>Because we&rsquo;re now using SWF, we have additional dependencies. Here&rsquo;s the full set so far:</p>

<p>These come from the Spring 2.5.4 distribution. <a href="http://www.springframework.org/download">[download]</a></p>

<ul class="square">
<li><code>spring.jar</code> (located in <code>/spring-framework-2.5.4/dist</code>)</li>
<li><code>spring-webmvc.jar</code> (located in <code>/spring-framework-2.5.4/dist/modules</code>)</li>
<li><code>commons-logging.jar</code> (located in <code>/spring-framework-2.5.4/jakarta-commons</code>)</li>
</ul>


<p>You will need the following JARs from the Spring Web Flow 2.0 distribution. <a href="http://www.springframework.org/download">[download]</a></p>

<ul class="square">
<li><code>spring-webflow-2.0.0.jar</code></li>
<li><code>spring-binding-2.0.0.jar</code></li>
<li><code>spring-js-2.0.0.jar</code></li>
</ul>


<p>You will need the following JAR from the <a href="http://www.ognl.org/">OGNL web site</a>:</p>

<ul class="square">
<li><code>ognl-2.6.9.jar</code></li>
</ul>


<p>Spring Web Flow uses either OGNL or Unified EL for parsing expressions.  For this article I arbitrarily picked OGNL though you can use <code>jboss-el.jar</code> (currently the only Unified EL implementation that will work with SWF) too.</p>

<h4>web.xml and mycart.CartController</h4>


<p>For now we aren&rsquo;t making any changes to either of these at all.</p>

<div style="margin:10px 0 20px 20px;float:right">
<div><img src="http://wheelersoftware.s3.amazonaws.com/articles/spring-web-flow-2.0/swf-config.gif" alt="Figure 2. Overview of SWF components." /></div>
<div class="caption">Figure 2. Overview of SWF components.</div>
</div>




<h4>Spring application context overview</h4>


<p>Before jumping into the code, let&rsquo;s do a quick overview of the various components involved.  Please see Figure 2.</p>

<p>We already saw <code>DispatcherServlet</code> in <code>web.xml</code>.  (So it&rsquo;s not part of <code>mycart-servlet.xml</code>; we&rsquo;re discussing it here just to show the relationship between the servlet and the <code>FlowController</code>.)  <code>DispatcherServlet</code> is the Spring MVC front controller and it receives any Spring MVC requests&mdash;including SWF requests, as SWF is based on Spring MVC&mdash;according to your <code>web.xml</code> configuration.</p>

<p>We&rsquo;re using <code>SimpleUrlHandlerMapping</code> to map flow requests from <code>DispatcherServlet</code> to <code>FlowController</code>.</p>

<p>So now <code>FlowController</code> has the request. <code>FlowController</code> is just a Spring MVC controller that receives flow requests and passes them to <code>FlowExecutor</code> for actual processing.</p>

<p><code>FlowExecutor</code> contains the actual logic for processing Spring Web Flow requests.  Among other things it determines for any given request which flow is involved and figures out what state transition to enact, based on the request.</p>

<p>When <code>FlowExecutor</code> needs a flow, it grabs the flow from the <code>FlowRegistry</code>, which is responsible for loading the flow from a flow configuration file and maintaining it on behalf of the <code>FlowExecutor</code>.</p>

<p><code>FlowBuilderServices</code> is just a container for various services that <code>FlowRegistry</code> needs when constructing flows. This includes, for example, a service to provide for the creation of view factories.  In our example, we will see that we&rsquo;re specifically using a <code>MvcViewFactoryCreator</code>, which creates view factories for Spring MVC views.</p>

<p>Finally, we define a <code>ViewResolver</code>, which is a Spring MVC interface that carries logical view names to physical resources (such as JSPs).  For example, a <code>ViewResolver</code> might carry the logical name <code>checkout/viewcart</code> to the physical resource <code>/WEB-INF/jsp/checkout/viewcart.jsp</code>.</p>

<div style="clear:both"></div>




<h4>Spring application context configuration file</h4>


<p>And finally here&rsquo;s the configuration file itself:</p>

<div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/mycart-servlet.xml</code>
<pre name="code" class="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:context="http://www.springframework.org/schema/context"
  xmlns:flow="http://www.springframework.org/schema/webflow-config"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
    http://www.springframework.org/schema/context
    http://www.springframework.org/schema/context/spring-context-2.5.xsd
    http://www.springframework.org/schema/webflow-config
    http://www.springframework.org/schema/webflow-config/spring-webflow-config-2.0.xsd"&gt;


    &lt;!-- SPRING MVC STUFF --&gt;

    &lt;!-- This activates post-processors for annotation-based config --&gt;
    &lt;!-- http://www.infoq.com/articles/spring-2.5-part-1 --&gt;
    &lt;context:annotation-config/&gt;

    &lt;context:component-scan base-package="mycart"/&gt;

    &lt;!-- Enables POJO @Controllers (like CartController) --&gt;
    &lt;bean class=
"org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping"/&gt;
    
    &lt;!-- Maps flow requests from DispatcherServlet to flowController --&gt;
    &lt;bean class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping"&gt;
        &lt;property name="mappings"&gt;
            &lt;value&gt;
                /account/register.do=flowController
            &lt;/value&gt;
        &lt;/property&gt;
        &lt;property name="alwaysUseFullPath" value="true"/&gt;
    &lt;/bean&gt;
    
    &lt;!-- Enables annotated methods on POJO @Controllers (like CartController) --&gt;
    &lt;bean class=
"org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter"/&gt;
    
    &lt;!-- Enables plain Controllers (e.g. FlowController) --&gt;
    &lt;bean class=
"org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter"/&gt;
    
    &lt;!-- Maps a logical view name to a physical resource --&gt;
    &lt;bean id="viewResolver" class=
"org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;
        &lt;property name="prefix" value="/WEB-INF/jsp/"/&gt;
        &lt;property name="suffix" value=".jsp"/&gt;
    &lt;/bean&gt;
    
    
    &lt;!-- SPRING WEB FLOW STUFF --&gt;
    
    &lt;bean id="flowController" class=
"org.springframework.webflow.mvc.servlet.FlowController"&gt;
        &lt;property name="flowExecutor" ref="flowExecutor"/&gt;
    &lt;/bean&gt;
    
    &lt;flow:flow-executor id="flowExecutor" flow-registry="flowRegistry"/&gt;
    
    &lt;!-- This creates an XmlFlowRegistryFactory bean --&gt;
    &lt;flow:flow-registry id="flowRegistry"
            flow-builder-services="flowBuilderServices"&gt;
        &lt;flow:flow-location path="/WEB-INF/flows/register.xml"/&gt;
    &lt;/flow:flow-registry&gt;
    
    &lt;flow:flow-builder-services id="flowBuilderServices"
            view-factory-creator="viewFactoryCreator"/&gt;
    
    &lt;bean id="viewFactoryCreator" class=
"org.springframework.webflow.mvc.builder.MvcViewFactoryCreator"&gt;
        &lt;property name="viewResolvers"&gt;
            &lt;list&gt;
                &lt;ref bean="viewResolver"/&gt;
            &lt;/list&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</pre>
</div>


<p>Now let&rsquo;s look at our basic flow definition, which will initially at least be much simpler than the application context file.</p>

<p><h3>Creating a Simple Flow: Flow Definition File and JSPs</h4></p>

<p>We&rsquo;ll now add a SWF flow definition file, update our original home page JSP, and add a new JSP for registering as a new customer.</p>

<p><h4>The flow definition file</h4></p>

<p>Here&rsquo;s a definition for our first flow, which will be a bare-bones registration process.  We&rsquo;ll add more flows to the application but this is our starting point just to get SWF working.  You&rsquo;ll need to create a directory <code>/WEB-INF/flows</code>, and then add the following flow definition file to that directory, naming the file <code>register.xml</code>.</p>

<p><div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/flows/register.xml</code>
<pre name="code" class="xml">&lt;?xml version=&ldquo;1.0&rdquo; encoding=&ldquo;UTF-8&rdquo;?&gt;
&lt;flow xmlns=&ldquo;<a href="http://www.springframework.org/schema/webflow">http://www.springframework.org/schema/webflow</a>&rdquo;
  xmlns:xsi=&ldquo;<a href="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</a>&rdquo;
  xsi:schemaLocation=&ldquo;<a href="http://www.springframework.org/schema/webflow">http://www.springframework.org/schema/webflow</a></p>

<pre><code>http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"&amp;gt;

&amp;lt;!-- By default, the first state is the start state. --&amp;gt;
&amp;lt;view-state id="register" view="account/registerForm"&amp;gt;
    &amp;lt;transition on="submitRegistration" to="accountAdded"/&amp;gt;
    &amp;lt;transition on="cancelRegistration" to="cancelRegistration"/&amp;gt;
&amp;lt;/view-state&amp;gt;

&amp;lt;end-state id="accountAdded"
    view="externalRedirect:contextRelative:/home.do"/&amp;gt;
&amp;lt;end-state id="cancelRegistration"
    view="externalRedirect:contextRelative:/home.do"/&amp;gt;
</code></pre>

<p>&lt;/flow&gt;</pre>
</div></p>

<p>Here we have a single state, called a <em>view state</em>, and all it does is show us the hardcoded JSP that we created earlier.  We&rsquo;re identifying the state itself as <code>register</code>, and the logical view name associated with this view state is <code>account/registerForm</code>.  This is the name that the view resolver we defined in the Spring app context file will map to a physical location; in this case the physical location will be <code>/WEB-INF/jsp/account/registerForm.jsp</code>.</p>

<p>By default, SWF interprets the first state in the file as being the <em>start state</em>, or entry point into the flow.  There must be exactly one start state.  The flow itself is called <code>register</code> (this is because we&rsquo;ve named the flow definition file <code>register.xml</code>).  As it happens we&rsquo;ve also named the first state <code>register</code> though there&rsquo;s no requirement for the start state to have the same name as the flow.</p>

<p>I&rsquo;ve defined a couple of transitions out of the <code>register</code> state.  One transition, <code>submitRegistration</code>, responds to registration submission events on the user interface, such as the user clicking a submit button on a registration form.  The other transition, <code>cancelRegistration</code>, responds to cancelation events on the UI, such as the user clicking a cancel link.  Each of these transitions leads to another state in the flow.  In this case, both of the transitions lead to <em>end states</em>, which are exits out of the flow, but transitions can lead to other view states (or even other sorts of state) as well.  As shown there can be multiple end states for a flow.  Here my end states happen to be doing the same thing; they&rsquo;re redirecting the user to a context-relative (as in relative to the servlet context) path <code>/home.do</code>, which you will recall is just the home page.  There are some other relativizations you can do as well:</p>

<p><div class="table-with-caption">
<div class="table">
<table>
<tr>
<th>Relativization</th>
<th>Example</th>
</tr>
<tr>
<td>Servlet mapping-relative</td>
<td><code>externalRedirect:/hotels/index</code></td>
</tr>
<tr>
<td>Servlet-relative path</td>
<td><code>externalRedirect:servletRelative:/hotels/index</code></td>
</tr>
<tr>
<td>Context-relative path</td>
<td><code>externalRedirect:contextRelative:/dispatcher/hotels/index</code></td>
</tr>
<tr>
<td>Server-relative path</td>
<td><code>externalRedirect:serverRelative:/springtravel/dispatcher/hotels/index</code></td>
</tr>
<tr>
<td>Absolute URL</td>
<td><code>externalRedirect:<a href="http://www.paypal.com/">http://www.paypal.com/</a></code></td>
</tr>
</table>
</div>
<div class="caption">Table 1. Relativizations for externalRedirect.</div>
</div></p>

<p>Anyway we&rsquo;re doing the context-relative redirection in this case. This is how we jump out of SWF and return control to the application. (Or how we return control to a calling flow, but we&rsquo;ll get to that.)</p>

<p><h4>The JSPs</h4></p>

<p>Now let&rsquo;s revisit our home page JSP.  It&rsquo;s still pretty similar but I&rsquo;m adding a registration link.</p>

<p><div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/jsp/home.jsp</code>
<pre name="code" class="html">&lt;!DOCTYPE html PUBLIC &ldquo;&ndash;//W3C//DTD XHTML 1.0 Strict//EN&rdquo;</p>

<pre><code>"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&amp;gt; 
</code></pre>

<p>&lt;html&gt;</p>

<pre><code>&amp;lt;head&amp;gt;
    &amp;lt;title&amp;gt;Products for Geeks - GeekWarez&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
    &amp;lt;h1&amp;gt;Welcome to GeekWarez&amp;lt;/h1&amp;gt;

    &amp;lt;div&amp;gt;&amp;lt;a href="account/register.do"&amp;gt;Register&amp;lt;/a&amp;gt;&amp;lt;/div&amp;gt;
&amp;lt;/body&amp;gt;
</code></pre>

<p>&lt;/html&gt;</pre>
</div></p>

<p>The registration link takes us into the <code>register</code> flow,since the last path segment is <code>register.do</code>.  In our Spring app context we told the flow registry about <code>register.xml</code>, so SWF will know to map requests for <code>/account/register.do</code> to the <code>register</code> flow.</p>

<p>Now we need a registration form.  The following page is our current version of a registration &ldquo;form&rdquo;, but as you can see it isn&rsquo;t really a form at all (yet).  It is just a couple of links:</p>

<p><div>
<span class="code-listing">Code listing:</span> <code>/WEB-INF/jsp/account/registerForm.jsp</code>
<pre name="code" class="html">&lt;!DOCTYPE html PUBLIC &ldquo;&ndash;//W3C//DTD XHTML 1.0 Strict//EN&rdquo;</p>

<pre><code>"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&amp;gt; 
</code></pre>

<p>&lt;html&gt;</p>

<pre><code>&amp;lt;head&amp;gt;
    &amp;lt;title&amp;gt;Register - GeekWarez&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
    &amp;lt;h1&amp;gt;Register&amp;lt;/h1&amp;gt;

    &amp;lt;div&amp;gt;
        &amp;lt;a href="${flowExecutionUrl}&amp;amp;_eventId=submitRegistration"&amp;gt;Submit&amp;lt;/a&amp;gt; |
        &amp;lt;a href="${flowExecutionUrl}&amp;amp;_eventId=cancelRegistration"&amp;gt;Cancel&amp;lt;/a&amp;gt;
    &amp;lt;/div&amp;gt;
&amp;lt;/body&amp;gt;
</code></pre>

<p>&lt;/html&gt;</pre>
</div></p>

<p>The point of the two links is to give the user a way to generate <code>submitRegistration</code> and <code>cancelRegistration</code> events.  We saw in the flow definition that these two events trigger state transitions.  Of special importance is the URL for each of these links.  Notice that by using <code>${flowExecutionUrl}</code>, we&rsquo;re still pointing the user at the same <code>/account/register.do</code> servlet path. That&rsquo;s because we&rsquo;re still working within the <code>register</code> flow.  The <code>${flowExecutionUrl}</code> URL includes an <code>execution</code> HTTP parameter whose value is a key that SWF uses for flow-tracking purposes.  In addition we add an <code>_eventId</code> parameter that we use to drive state transitions.  The event IDs are what we&rsquo;re referencing when we define transitions in the flow definition file.</p>

<p>So really so far all we can do at this point is move back and forth between the home page and the registration page, but we&rsquo;re doing it with Spring Web Flow.</p>

<p><h3>Milestone 2: Spring Web Flow is working</h3></p>

<p>Point your web browser at</p>

<p><center><code><a href="http://localhost:8080/mycart2/home.do">http://localhost:8080/mycart2/home.do</a></code></center></p>

<p>making any adjustments you need to make for the port or application context.  Also note that the context is now <code>mycart2</code> instead of <code>mycart1</code> like it was in the first version of the code.  If you&rsquo;re able to click back and forth between the home page and the registration page, then congrats, Spring Web Flow 2.0 is working!  Celebrate!</p>

<p><div class="outro">
<span class="icon stickyNote">This post is part of a three part series: <a href="http://springinpractice.com/2008/05/05/build-a-shopping-cart-with-spring-web-flow-2-part-1/">Part 1</a> | <a href="http://springinpractice.com/2008/05/06/build-a-shopping-cart-with-spring-web-flow-2-part-2/">Part 2</a> | <a href="http://springinpractice.com/2008/05/07/build-a-shopping-cart-with-spring-web-flow-2-part-3/">Part 3</a></span>
</div></p>

<p><div class="endnote">Post migrated from my Wheeler Software site.</div></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/8/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/6/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/09/14/optimistic-locking-with-spring-data-rest/">Optimistic locking with Spring Data REST</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/07/octopress-migration/">Octopress migration</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/08/seajug-talk-on-spring-data-jpa-spring-data-rest-and-spring-hateoas/">SeaJUG talk on Spring Data JPA</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/08/spring-in-practice-now-available/">Spring in Practice now available</a>
      </li>
    
      <li class="post">
        <a href="/2012/12/09/renaming-node-classes-when-using-spring-data-neo4j/">Renaming node classes when using Spring Data Neo4j</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/williewheeler">@williewheeler</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'williewheeler',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Willie Wheeler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'springinpractice';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

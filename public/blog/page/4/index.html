
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Spring in Practice</title>
  <meta name="author" content="Willie Wheeler">

  
  <meta name="description" content="By default, Spring&rsquo;s &lt;oxm:jaxb2-marshaller&gt; tag uses the Jaxb2Marshaller class. It&rsquo;s painful to use, though, if you have a lot of &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://springinpractice.com/blog/page/4">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Spring in Practice" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Forum' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31137459-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <ul class="social-links">
    <li><a href="https://twitter.com/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/twitter.png" alt="Twitter" /></a></li>
    <li><a href="https://github.com/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/github.png" alt="GitHub" /></a></li>
    <li><a href="http://stackoverflow.com/users/41871/willie-wheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/stackoverflow.png" alt="Stack Overflow" /></a></li>
    <li><a href="http://www.linkedin.com/in/williewheeler"><img src="http://springinpractice.s3.amazonaws.com/blog/theme/icons/linkedin.png" alt="LinkedIn" /></a></li>
  </ul>
  <h1><a href="/">Spring in Practice</a></h1>
  
    <h2>Willie Wheeler's Spring blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives/">Archives</a></li>
  <li><a href="/book/">The Book</a></li>
  <li><a href="/consulting/"><span style="padding-left:20px;background:url(http://springinpractice.com/images/leaf.png) left no-repeat">Spring Consulting</span></a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/12/29/its-back-the-classpathscanningjaxb2marshaller/">ClasspathScanningJaxb2Marshaller</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-29T13:03:00-08:00" pubdate data-updated="true">Dec 29<span>th</span>, 2011</time>
        
         | <a href="/2011/12/29/its-back-the-classpathscanningjaxb2marshaller/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>By default, Spring&rsquo;s <code>&lt;oxm:jaxb2-marshaller&gt;</code> tag uses the <a href="http://static.springsource.org/spring/docs/3.1.x/javadoc-api/org/springframework/oxm/jaxb/Jaxb2Marshaller.html">Jaxb2Marshaller</a> class. It&rsquo;s painful to use, though, if you have a lot of classes, because you have to enumerate them all individually. There are a couple of options here:</p>

<ul>
<li>You can use one of the JAXB2 mechanisms (an <code>ObjectFactory</code> or an <code>jaxb.index</code> file; see <a href="http://docs.oracle.com/javase/6/docs/api/javax/xml/bind/JAXBContext.html">JAXBContext</a>).</li>
<li>You can use the marshaller&#8217;s <code>classesToBeBound</code> property.</li>
</ul>


<p>Both of these options require more work than they ought to. Here, for example, is what the <code>classesToBeBound</code> approach looks like:</p>

<pre>&lt;oxm:jaxb2-marshaller id="marshaller"&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Database" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.DataCenter" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Environment" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Farm" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Instance" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Package" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Package$MyListWrapper" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Person" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Project" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Region" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.relationship.ProjectMembership" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.web.jit.JitNode" /&gt;

    ... and so forth ...

&lt;/oxm:jaxb2-marshaller&gt;</pre>


<p>Every time we add a new entity to the system, we have to go back to the list and add a corresponding entry. Blech.</p>

<p>About a year back I discovered a gem by <a href="https://twitter.com/#!/jwalgemoed">Jarno Walgemoed</a> called <code>ClasspathScanningJaxb2Marshaller</code>. Actually, I don&rsquo;t remember if that&rsquo;s its exact name, because his blog post no longer exists, but that&rsquo;s pretty close if not exactly it. At any rate, it uses Spring&rsquo;s classpath scanning mechanism (you know, the one that finds <code>@Component</code> and <code>@Repository</code> and so forth) to find classes annotated with <code>@XmlRootElement</code>, and then JAXB-binds them.</p>

<p>[EDIT: I found <a href="http://www.walgemoed.org/2010/12/jaxb2-spring-ws/">the original blog post</a> after all. &mdash; WLW]</p>

<p>Here&rsquo;s a slightly modified version of Jarno&rsquo;s class, reposted with his kind permission. (Thanks Jarno!) I&rsquo;ve used it on multiple projects and it works great.</p>

<pre>import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import javax.annotation.PostConstruct;
import javax.xml.bind.annotation.XmlRootElement;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider;
import org.springframework.core.type.filter.AnnotationTypeFilter;
import org.springframework.oxm.jaxb.Jaxb2Marshaller;

public class ClasspathScanningJaxb2Marshaller extends Jaxb2Marshaller {
    private static final Logger log = LoggerFactory.getLogger(ClasspathScanningJaxb2Marshaller.class);
    
    private List basePackages;
    
    public List getBasePackages() { return basePackages; }
    
    public void setBasePackages(List basePackages) { this.basePackages = basePackages; }
    
    @PostConstruct
    public void init() throws Exception {
        setClassesToBeBound(getXmlRootElementClasses());
    }
    
    private Class[] getXmlRootElementClasses() throws Exception {
        ClassPathScanningCandidateComponentProvider scanner =
            new ClassPathScanningCandidateComponentProvider(false);
        scanner.addIncludeFilter(new AnnotationTypeFilter(XmlRootElement.class));
        
        List&lt;Class&gt; classes = new ArrayList&lt;Class&gt;();
        for (String basePackage : basePackages) {
            Set definitions = scanner.findCandidateComponents(basePackage);
            for (BeanDefinition definition : definitions) {
                String className = definition.getBeanClassName();
                log.info("Found class: {}", className);
                classes.add(Class.forName(className));
            }
        }
        
        return classes.toArray(new Class[0]);
    }
}</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/12/28/initializing-lazy-loaded-collections-with-spring-data-neo4j/">Initializing Lazy-loaded Collections With Spring Data Neo4j</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-28T04:22:03-08:00" pubdate data-updated="true">Dec 28<span>th</span>, 2011</time>
        
         | <a href="/2011/12/28/initializing-lazy-loaded-collections-with-spring-data-neo4j/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Spring Data Neo4j has been around for about a year now, but the so-called &ldquo;simple mapping&rdquo; strategy (the one that doesn&rsquo;t use AspectJ) is new. So it doesn&rsquo;t have some of the bells and whistles that you might expect to see if you&rsquo;re coming from, say, Hibernate. In particular, it doesn&rsquo;t (as of Spring Data Neo4j 2.0.0.RELEASE) use proxies for collections.</p>

<p>The <a href="http://stackoverflow.com/questions/8218864/fetch-annotation-in-sdg-2-0-fetching-strategy-questions">question of how to initialize lazily loaded collections</a> came up on StackOverflow. Michael Hunger (Spring Data Neo4j lead) explained that you can use the Neo4jTemplate&rsquo;s fetch() method to perform the initialization. Here&rsquo;s some code showing how to do it:</p>

<pre>package org.skydingo.skybase.service.impl;

import javax.inject.Inject;
import org.skydingo.skybase.model.Person;
import org.skydingo.skybase.repository.PersonRepository;
import org.skydingo.skybase.service.PersonService;
import org.springframework.data.neo4j.support.Neo4jTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Transactional
public class PersonServiceImpl implements PersonService {
    @Inject private Neo4jTemplate template;
    @Inject private PersonRepository personRepo;

    @Override
    public Person findPersonDetails(Long id) {
        Person person = personRepo.findOne(id);
        template.fetch(person.getDirectReports());
        return person;
    }

    ... other methods ...
}</pre>


<p>Have fun.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/12/26/devops-how-not-to-collect-configuration-management-data/">Devops: How NOT to Collect Configuration Management Data</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-26T14:31:55-08:00" pubdate data-updated="true">Dec 26<span>th</span>, 2011</time>
        
         | <a href="/2011/12/26/devops-how-not-to-collect-configuration-management-data/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Hi all, Willie here. This time we&rsquo;re going to step away from the keyboard and get architectural. But no ivory towers here. In my next two blog posts, I&rsquo;m going to give you something that will get you out of lots of pointless meetings.</p>

<p>Got your attention yet? Good!</p>

<p>If you&rsquo;re in devops, one of the things that you have to figure out is how to collect up all the information that will allow you to manage your configuration and also keep your apps up and running. This isn&rsquo;t too hard when you have two apps sitting on a single server. It&rsquo;s much harder when you have 400 apps deployed to thousands of servers across multiple environments and data centers.</p>

<p>So how do you do that? Let&rsquo;s start off by looking at some things that just don&rsquo;t work. In my next post I&rsquo;ll share with you an approach that <em>does</em> work.</p>

<h3>Some quick background</h3>


<p>Probably owing to some psychological glitch, I&rsquo;ve always been an information curator. Especially when I was in management, it was always important to me to understand exactly where my apps were deployed, which servers they were on, which services and databases they depended on, which servers <em>those</em> services and databases lived on, who are the SMEs for a given app, and so on.</p>

<p>If you work in a small environment, you&rsquo;re probably thinking, &ldquo;what&rsquo;s the big deal?&rdquo;</p>

<p>Well, I don&rsquo;t work in a small environment, but the first time I undertook this task, I probably would have said something like, &ldquo;no sweat.&rdquo; (That&rsquo;s the developer in me.) Anyway, for whatever reason, I decided that it was high time that somebody around the department could answer seemingly basic questions about our systems.</p>

<h3>Attempt #1: Wiki Wheeler</h3>


<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-26-devops-how-not-to-collect-configuration-management-data/bullwhip1.jpg" alt="Wiki Wheeler" /></p>

<p>The first time I made the attempt (several years ago), I was a director over a dozen or so app teams. So I created a wiki template with all the information that I wanted, and I chased after my teams to fill it out. My zeal was such that, unbeknownst to me, I acquired the nickname &ldquo;Wiki Wheeler&rdquo;. (One of my managers shared this heartwarming bit of information with me a couple years later.) I guess other managers liked the approach, though, because they chased after their teams too.</p>

<p>This approach started out decently well, since the teams involved could manage their own information, and since I was, well, Wiki Wheeler. But it didn&rsquo;t last. Through different system redesigns and department reorgs, wiki spaces came and went, some spaces atrophied from neglect, and there was redundant but contradictory information everywhere. The QA team had its own list, the release guys had their list, the app teams had their list. The UX guys might have even gotten in on the act. Anyway, after a year or so it was a big mess and to this day our wiki remains a big mess.</p>

<h3>Attempt #2: My huge Visio</h3>


<p><strong></strong>The second time, my approach was to collect the information from all the app development teams. We had hundreds of developers, so to make things efficient, I sent out a department-wide e-mail telling everybody that I was putting together a huge Visio document with all of our systems, and I&rsquo;d appreciate it if they could reply back with the requested information. And while I had to send out more nag e-mails than I would have liked, the end result was in fact a huge Visio diagram that had hundreds of boxes and lines going everywhere. I was very proud of this thing, and I printed out five or six copies on the department plotter and hung them on the walls.</p>

<p>How long do you think it was before it was out of date?</p>

<p>I have no idea. I seriously doubt that it was ever correct in the first place. Nobody (myself included) ever used the diagram to do actual work, and its chief utility was in making our workplace look somewhat more hardcore since there were huge color engineering plots on the walls.</p>

<p>There was one additional effect of this diagram, though I hesitate to call it utility. I acquired the wholly undeserved reputation for knowing what all these apps were and how they related to one another. This went on for years through no fault of my own. I mention it because it&rsquo;s relevant for the next attempt.</p>

<h3>Attempt #3: Disaster recovery</h3>


<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-26-devops-how-not-to-collect-configuration-management-data/asteroid.jpg" alt="When asteroids strike..." /></p>

<p>This one wasn&rsquo;t my attempt, but it&rsquo;s still worth describing since I have to imagine that we aren&rsquo;t the only ones who ever tried it.</p>

<p>As a rapidly growing company, disaster recovery became an increasingly big deal for us several years back, and there was a mandate from up high to put a plan in place. This involved collecting up all the information that would allow us to keep the business running if our primary data center ever got cratered. The person in charge of the effort spent about two years meeting with app teams or else &ldquo;experts&rdquo; (me, along with others who, like me, had only the highest-level understanding of how things were connected up) and documenting it on a Sharepoint site where nobody could see it.</p>

<p>This didn&rsquo;t work at all. Most people were too busy to meet with her, so the quality of the information was poor. Apps were misnamed, app suites were mistaken for apps, and to make a long story short, the result was not correct or maintainable.</p>

<h3>Attempt #4: Our external consultants&#8217; even bigger Visio</h3>


<p>Following a major reorg, we brought in some external consultants and they came up with their own Visio. By this time I had already figured out that interviewing teams and putting together huge Visios is a losing approach, so I was surprised that a bunch of highly-paid consultants would use it. Well, they did, and their diagram was, well, &ldquo;impressive&rdquo;. It was also (to put it gently) neither as helpful nor as maintainable as we would have liked.</p>

<h3>Attempt #5: HP uCMDB autodiscovery</h3>


<p>We have the HP uCMDB tool, and so our IT Services group ran some automated discovery agents to populate it with data. It loaded the uCMDB up with tons of fine-grained detail that nobody cared about, and we couldn&rsquo;t see the stuff that we actually did care about (like apps, web services, databases, etc.).</p>

<h3>Attempt #6: Service catalog</h3>


<p>Our IT Services group was pretty big on ITIL, so they went about putting together a service catalog. The person doing it collected service and app information into an Excel spreadsheet and posted it to a Sharepoint site. But this didn&rsquo;t really get into the details of configuration management. It was mostly around figuring out which business services we offered and which systems support which services.</p>

<p>They ended up printing out a glossy, full-color service catalog for the business, but nobody was really asking for it, so it was more of a curiosity than anything else.</p>

<p>There were other attempts too (Paul led a couple that I haven&rsquo;t even mentioned), but by now you get the picture.</p>

<h3>So why did these attempts fail?</h3>


<p>To understand why these attempts failed, it helps to look at what they had in common:</p>

<ul>
    <li>First, they generally involved trying to collect up information from SMEs and then putting it in some kind of document. This could be wiki pages, Visio diagrams, Word docs on Sharepoint or an Excel spreadsheet.</li>
    <li>Once the information went there, nobody used it. So the information, if it was ever correct and/or complete in the first place, was before long outdated, and there wasn&#8217;t any mechanism in place to bring it up to date.</li>
</ul>


<p>In general, people saw the problem as a data <em>collection</em> problem rather than a data <em>management</em> problem. There needs to be a systematic, ongoing mechanism to discover and fix errors. None of the approaches took the management problem seriously at all&mdash;they all simply assumed that the organization would care about the data enough to keep it up to date.</p>

<p>In the next installment, I&rsquo;ll tell you about the approach we eventually figured out. And as promised, that&rsquo;s also where I&rsquo;ll explain how to get rid of some of your meetings.</p>

<p><span class="icon stickyNote"><em>Interested in configuration management? I&rsquo;m working on an open source CMDB called <a href="http://zkybase.org/">Zkybase</a>.</em></span></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/12/17/domain-modeling-with-spring-data-neo4j-code/">Domain Modeling With Spring Data Neo4j</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-17T15:26:41-08:00" pubdate data-updated="true">Dec 17<span>th</span>, 2011</time>
        
         | <a href="/2011/12/17/domain-modeling-with-spring-data-neo4j-code/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Hi all, Willie here. Last time I told you that I&rsquo;m building the <a href="https://github.com/williewheeler/zkybase">Zkybase</a> CMDB using <a title="Neo4j" href="http://neo4j.org/">Neo4j</a> and <a title="Spring Data Neo4j" href="http://www.springsource.org/spring-data/neo4j">Spring Data Neo4j</a>, and I was excited to get a lot of positive feedback about that. I showed a little code but not that much. In this post I&rsquo;ll show you how I&rsquo;m building out the person <a title="Configuration item" href="http://en.wikipedia.org/wiki/Configuration_item">configuration item</a> (CI) in Zkybase using Spring Data Neo4j.</p>

<h2>Person CI requirements</h2>

<p>We&rsquo;re going to start really simply here by building a person CI. It&rsquo;s useful to have people in the CMDB for various reasons: they allow you to define fine-grained access controls (e.g., Jim can deploy such-and-such apps to the development environment; Eric can deploy whatever he wants wherever he wants; etc.); they allow you to define groups who will receive notifications for critical events and incidents; etc.</p>

<p>Our person CI will have a username, first and last names, some phone numbers, an e-mail address, a manager, direct reports and finally projects he or she works on. We need to be able to display people in a list view, display a given person in a details view, allow users to create, edit and delete people and so on. Here for example is what the list view will look like, at least for now:</p>

<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-17-domain-modeling-with-spring-data-neo4j-code/person_list.png" alt="Person list" /></p>

<p>And here&rsquo;s how our details view will look:</p>

<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-17-domain-modeling-with-spring-data-neo4j-code/person_details.png" alt="Person details" /></p>

<p>The relationship between a person and a project has an associated role. This relationship is also the basis for the list of collaborators: two people are collaborators if there&rsquo;s at least one project of which they&rsquo;re both members.</p>

<p>Our simple requirements should be enough to show what it feels like to write Spring Data Neo4j code.</p>

<h2>Create the Person and ProjectMembership entities</h2>

<p>First we&rsquo;ll create the Person. I&rsquo;ve suppressed the validation and JAXB annotations since they&rsquo;re irrelevant for our current purposes:</p>

<pre>package org.skydingo.zkybase.model;

import java.util.Set;
import org.neo4j.graphdb.Direction;
import org.skydingo.zkybase.model.relationship.ProjectMembership;
import org.springframework.data.neo4j.annotation.*;
import org.springframework.data.neo4j.support.index.IndexType;

@NodeEntity
public class Person implements Comparable&lt;Person&gt; {
    @GraphId private Long id;

    @Indexed(indexType = IndexType.FULLTEXT, indexName = "searchByUsername")
    private String username;

    private String firstName, lastName, title, workPhone, mobilePhone, email;

    @RelatedTo(type = "REPORTS_TO")
    private Person manager;

    @RelatedTo(type = "REPORTS_TO", direction = Direction.INCOMING)
    private Set&lt;Person&gt; directReports;

    @RelatedToVia(type = "MEMBER_OF")
    private Set&lt;ProjectMembership&gt; memberships;

    public Long getId() { return id; }

    public void setId(Long id) { this.id = id; }

    public String getUsername() { return username; }

    public void setUsername(String username) { this.username = username; }

    ... other accessor methods ...

    public Person getManager() { return manager; }

    public void setManager(Person manager) { this.manager = manager; }

    public Set&lt;Person&gt; getDirectReports() { return directReports; }

    public void setDirectReports(Set&lt;Person&gt; directReports) {
        this.directReports = directReports;
    }

    public Iterable&lt;ProjectMembership&gt; getMemberships() { return memberships; }

    public ProjectMembership memberOf(Project project, String role) {
        ProjectMembership membership = new ProjectMembership(this, project, role);
        memberships.add(membership);
        return membership;
    }

    ... equals(), hashCode(), compareTo() ...
}</pre>


<p>There are lots of annotations we&rsquo;re using to put a structure in place. Let&rsquo;s start with nodes and their properties. Then we&rsquo;ll look at simple relationships between nodes. Then we&rsquo;ll look at so-called relationship entities, which are basically fancy relationships. First, here&rsquo;s an abstract representation of our domain model:</p>

<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-17-domain-modeling-with-spring-data-neo4j-code/abstract_graph.png" alt="Abstract graph" /></p>

<p>Now let&rsquo;s look at some details.</p>

<p><strong>Nodes and their properties.</strong> When we have a node-backed entity, first we annotate it with the @NodeEntity annotation. Most of the simple node properties (i.e., properties that aren&rsquo;t relationships to other nodes) come along for the ride. Notice that I didn&rsquo;t have to annotate firstName, lastName, email, and so forth. Spring Data Neo4j will handle the mapping there automatically.</p>

<p>There are a couple of exceptions though. The first one is that I put @GraphId on my id property. This tells Spring Data Neo4j that this is an identifier that we can use for lookups. The other one is the @Indexed annotation, which (surprise) creates an index for the property in question. This is useful when you want an alternative to ID-based lookup.</p>

<p>Now we&rsquo;ll look at relationships. Speaking broadly, there are simple relationships and more advanced relationships. We&rsquo;ll start with the simple ones.</p>

<p><strong>Simple relationships.</strong> At a low level, Neo4j is a graph database, so we can talk about the graph in graph theoretical terms like nodes, edges, directed edges, DAGs and all that. But here we&rsquo;re using graphs for domain modeling, so we interpret low-level graph concepts in terms of higher-level domain modeling concepts. The language that Spring Data Neo4j uses is &ldquo;node entity&rdquo; for nodes, and &ldquo;relationships&rdquo; for edges.</p>

<p>Our Person CI has a simple relationship, called REPORTS_TO, that relates people so we can model reporting hierarchies. Person has two fields for this relationship: manager and directReports. These are opposite sites of the same relationship. We use @RelatedTo(type = &ldquo;REPORTS_TO&rdquo;) to annotate these fields. The annotation has a direction element as well, whose default value is Direction.OUTGOING, which means that &ldquo;this&rdquo; node is the edge tail. That&rsquo;s why we specify direction = Direction.INCOMING explicitly for the directReports field.</p>

<p>What&rsquo;s this look like in the database? <a title="Neoclipse site" href="http://wiki.neo4j.org/content/Neoclipse">Neoclipse</a> reveals all. Here are some example reporting relationships (click the image for a larger view):</p>

<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-17-domain-modeling-with-spring-data-neo4j-code/reports_to_graph.png" alt="Reports-to graph" /></p>

<p>(Small aside: there&rsquo;s a <code>@Fetch</code> annotation&mdash;we&rsquo;ll see it in a moment&mdash;that tells Spring Data Neo4j to eager load a related entity. For some reason I&rsquo;m not having to use it for the manager and direct reports relationships, and I&rsquo;m not sure why. If somebody knows, I&rsquo;d appreciate the explanation.)</p>

<p><strong>Relationship entities.</strong> Besides the REPORTS_TO relationship between people, we care about the MEMBER_OF relationship between people and projects. This one&rsquo;s more interesting than the REPORTS_TO relationship because MEMBER_OF has an associated property&mdash;role&mdash;that&rsquo;s analogous to adding a column to a link table in a RDBMS, as I mentioned in my reply to Brig in the last post. The Person.memberOf() method provides a convenient way to assign a person to a project using a special ProjectMembership &ldquo;relationship entity&rdquo;. Here&rsquo;s the code:</p>

<pre>package org.skydingo.zkybase.model.relationship;

import org.skydingo.zkybase.model.Person;
import org.skydingo.zkybase.model.Project;
import org.springframework.data.neo4j.annotation.*;

@RelationshipEntity(type = "MEMBER_OF")
public class ProjectMembership {
    @GraphId private Long id;
    @Fetch @StartNode private Person person;
    @Fetch @EndNode private Project project;
    private String role;

    public ProjectMembership() { }

    public ProjectMembership(Person person, Project project, String role) {
        this.person = person;
        this.project = project;
        this.role = role;
    }

    public Person getPerson() { return person; }

    public void setPerson(Person person) { this.person = person; }

    public Project getProject() { return project; }

    public void setProject(Project project) { this.project = project; }

    public String getRole() { return role; }

    public void setRole(String role) { this.role = role; }

    ... equals(), hashCode(), toString() ...

}</pre>


<p>ProjectMembership, like Person, is an entity, but it&rsquo;s a relationship entity. We use @RelationshipEntity(type = &ldquo;MEMBER_OF&rdquo;) to mark this as a relationship entity, and as with the Person, we use @GraphId for the id property. The @StartNode and @EndNode annotations indicate the edge tail and head, respectively. @Fetch tells Spring Data Neo4j to load the nodes eagerly. By default, Spring Data Neo4j doesn&rsquo;t eagerly load relationships since risks loading the entire graph into memory.</p>

<h2>Create the PersonRepository</h2>

<p>Here&rsquo;s our PersonRepository interface:</p>

<pre>package org.skydingo.zkybase.repository;

import java.util.Set;
import org.skydingo.zkybase.model.Person;
import org.skydingo.zkybase.model.Project;
import org.springframework.data.neo4j.annotation.Query;
import org.springframework.data.neo4j.repository.GraphRepository;

public interface PersonRepository extends GraphRepository&lt;Person&gt; {

    Person findByUsername(String username);

    @Query("start project=node({0}) match project&lt;--person return person")
    Set&lt;Person&gt; findByProject(Project project);

    @Query(
        "start person=node({0}) " +
        "match person-[:MEMBER_OF]-&gt;project&lt;-[:MEMBER_OF]-collaborator " +
        "return collaborator")
    Set&lt;Person&gt; findCollaborators(Person person);
}</pre>


<p class="size-medium wp-image-215" title="repos">I noted in the last post that all we need to do is extend the GraphRepository interface; Spring Data generates the implementation automatically.</p>


<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-17-domain-modeling-with-spring-data-neo4j-code/repos.png" alt="Spring Data repositories" /></p>

<p>For <code>findByUsername()</code>, Spring Data can figure out what the intended query is there. For the other two queries, we use <code>@Query</code> and the <a title="Cypher query language" href="http://docs.neo4j.org/chunked/milestone/cypher-query-lang.html">Cypher query language</a> to specify the desired result set. The <code>{0}</code> in the queries refers to the finder method parameter. In the <code>findCollaborators()</code> query, we use <code>[:MEMBER_OF]</code> to indicate which relationship we want to follow. These return <code>Set</code>s instead of <code>Iterable</code>s to eliminate duplicates.</p>

<h2>Create the web controller</h2>

<p>We won&rsquo;t cover the entire controller here, but we&rsquo;ll cover some representative methods. Assume that we&rsquo;ve injected a PersonRepository into the controller.</p>

<p><strong>Creating a person.</strong> To create a person, we can use the following:</p>

<pre>@RequestMapping(value = "", method = RequestMethod.POST)
public String createPerson(Model model, @ModelAttribute Person person) {
    personRepo.save(person);
    return "redirect:/people?a=created";
}</pre>


<p>Once again, we&rsquo;re ignoring validation. All we have to do is call the save() method on the repository. That&rsquo;s how updates work too.</p>

<p><strong>Finding all people.</strong> Next, here&rsquo;s how we can get all people:</p>

<pre>@RequestMapping(value = "", method = RequestMethod.GET)
public String getPersonList(Model model) {
    Iterable&lt;Person&gt; personIt = personRepo.findAll();
    List&lt;Person&gt; people =
        new ArrayList&lt;Person&gt;(IteratorUtil.asCollection(personIt));
    Collections.sort(people);
    model.addAttribute(people);
    return "personList";
}</pre>


<p>We have to do some work to get the Iterable that PersonRepository.findAll() returns into the format we want. IteratorUtil, which comes with Neo4j (org.neo4j.helpers.collection.IteratorUtil), helps here.</p>

<p><strong>Finding a single person.</strong> Here we want to display the personal details we built out above. As with findAll(), we have to do some of the massaging ourselves:</p>

<pre>@RequestMapping(value = "/{username}", method = RequestMethod.GET)
public String getPersonDetails(@PathVariable String username, Model model) {
    Person person = personRepo.findByUsername(username);
    List&lt;ProjectMembership&gt; memberships =
        CollectionsUtil.asList(person.getMemberships());
    List&lt;Person&gt; directReports =
        CollectionsUtil.asList(person.getDirectReports());
    List&lt;Person&gt; collaborators =
        CollectionsUtil.asList(personRepo.findCollaborators(person));

    Collections.sort(directReports);
    Collections.sort(collaborators);

    model.addAttribute(person);
    model.addAttribute("memberships", memberships);
    model.addAttribute("directReports", directReports);
    model.addAttribute("collaborators", collaborators);

    return "personDetails";
}</pre>


<p>If you want to see the JSPs, check out the <a title="Zkybase GitHub site" href="http://skydingo.com/blog/?p=28">Zkybase GitHub site</a>.</p>

<h2>Configure the app</h2>

<p>Finally, here&rsquo;s my beans-service.xml file:</p>

<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:neo4j="http://www.springframework.org/schema/data/neo4j"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:tx="http://www.springframework.org/schema/tx"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.0.xsd
        http://www.springframework.org/schema/data/neo4j
        http://www.springframework.org/schema/data/neo4j/spring-neo4j-2.0.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx-3.0.xsd"&gt;

    &lt;context:property-placeholder
        location="classpath:/spring/environment.properties" /&gt;
    &lt;context:annotation-config /&gt;
    &lt;context:component-scan base-package="org.skydingo.zkybase.service" /&gt;

    &lt;tx:annotation-driven mode="proxy" /&gt;

    &lt;neo4j:config storeDirectory="${graphDb.dir}" /&gt;
    &lt;neo4j:repositories base-package="org.skydingo.zkybase.repository" /&gt;
&lt;/beans&gt;</pre>


<p>Neo4j has a basic POJO-based mapping model and an advanced AspectJ-based mapping model. In this blog post we&rsquo;ve been using the basic POJO-based approach, so we don&rsquo;t need to include AspectJ-related configuration like &lt;context:spring-configured /&gt;.</p>

<p>There you have it&mdash;a Person CI backed by Neo4j. Happy coding!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/12/06/jackson-json-jaxb2-xml-spring/">Configuring Jackson to Use JAXB2 Annotations With Spring</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-06T14:17:40-08:00" pubdate data-updated="true">Dec 6<span>th</span>, 2011</time>
        
         | <a href="/2011/12/06/jackson-json-jaxb2-xml-spring/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you want to generate both XML and JSON views of some object, one option is to use JAXB2 annotations for the XML mapping and Jackson annotations for the JSON mapping. But that&rsquo;s a little bit of a nuisance, because you have to declare the what are essentially the same mappings twice. It turns out that it&rsquo;s possible to configure Jackson to use the JAXB2 annotations.</p>

<h3>Maven configuration</h3>


<p>First, make sure you have the <code>jackson-xc</code> dependency (in addition to the other Jackson dependencies) declared. This is the Maven dependency that supports using JAXB2 annotations:</p>

<pre>&lt;dependency&gt;
    &lt;groupId&gt;org.codehaus.jackson&lt;/groupId&gt;
    &lt;artifactId&gt;jackson-xc&lt;/artifactId&gt;
    &lt;version&gt;1.9.2&lt;/version&gt;
&lt;/dependency&gt;</pre>




<h3>Spring configuration</h3>


<p>Next, you&rsquo;ll need a bit of Spring configuration:</p>

<pre>&lt;oxm:jaxb2-marshaller id="marshaller"&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Person" /&gt;
    &lt;oxm:class-to-be-bound name="org.skydingo.skybase.model.Project" /&gt;
&lt;/oxm:jaxb2-marshaller&gt;

&lt;bean id="jaxbAnnIntrospector"
    class="org.codehaus.jackson.xc.JaxbAnnotationIntrospector" /&gt;
&lt;bean id="jacksonObjectMapper" class="org.codehaus.jackson.map.ObjectMapper"&gt;
    &lt;property name="serializationConfig.annotationIntrospector"
        ref="jaxbAnnIntrospector" /&gt;
    &lt;property name="deserializationConfig.annotationIntrospector"
        ref="jaxbAnnIntrospector" /&gt;
&lt;/bean&gt;

&lt;bean class="org.springframework.web.servlet.view.ContentNegotiatingViewResolver"&gt;
    &lt;property name="mediaTypes"&gt;
        &lt;map&gt;
            &lt;entry key="html" value="text/html" /&gt;
            &lt;entry key="json" value="application/json" /&gt;
            &lt;entry key="xml" value="application/xml" /&gt;
        &lt;/map&gt;
    &lt;/property&gt;
    &lt;property name="viewResolvers"&gt;
        &lt;list&gt;
            &lt;bean class="org.springframework.web.servlet.view.InternalResourceViewResolver"
                p:prefix="/WEB-INF/jsp/"
                p:suffix=".jsp" /&gt;
        &lt;/list&gt;
    &lt;/property&gt;
    &lt;property name="defaultViews"&gt;
        &lt;list&gt;
            &lt;bean class="org.springframework.web.servlet.view.json.MappingJacksonJsonView"
                p:objectMapper-ref="jacksonObjectMapper"&gt;
                &lt;property name="renderedAttributes"&gt;
                    &lt;set&gt;
                        &lt;value&gt;person&lt;/value&gt;
                        &lt;value&gt;project&lt;/value&gt;
                    &lt;/set&gt;
                &lt;/property&gt;
            &lt;/bean&gt;
            &lt;bean class="org.springframework.web.servlet.view.xml.MarshallingView"
                p:marshaller-ref="marshaller" /&gt;
        &lt;/list&gt;
    &lt;/property&gt;
&lt;/bean&gt;</pre>


<p>Note the use of the compound property names when injecting into the Jackson <code>ObjectMapper</code>. That&rsquo;s a little-known but useful technique for performing injections in cases where constructor and simple property injection aren&rsquo;t options.</p>

<p>See also</p>

<ul>
    <li><a href="http://hillert.blogspot.com/2011/01/marshal-json-data-using-jackson-in.html">http://hillert.blogspot.com/2011/01/marshal-json-data-using-jackson-in.html</a></li>
    <li><a href="http://wiki.fasterxml.com/JacksonJAXBAnnotations">http://wiki.fasterxml.com/JacksonJAXBAnnotations</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/12/06/why-im-pretty-excited-about-using-neo4j-for-a-cmdb-backend/">Why I&#8217;m Pretty Excited About Using Neo4j for a CMDB Backend</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-06T05:14:44-08:00" pubdate data-updated="true">Dec 6<span>th</span>, 2011</time>
        
         | <a href="/2011/12/06/why-im-pretty-excited-about-using-neo4j-for-a-cmdb-backend/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-06-why-im-pretty-excited-about-using-neo4j-for-a-cmdb-backend/deathburro-200x300.jpg" alt="deathburro" /></p>

<p><a href="https://github.com/williewheeler/zkybase">Zkybase</a> is my first <em>open source</em> configuration management database (CMDB) effort, but it&rsquo;s not the first time I&rsquo;ve built a CMDB. At work a bunch of us built&mdash;and continue to build&mdash;a proprietary, internal system CMDB called deathBURRITO as part of our deployment automation effort. We built deathBURRITO using Java, Spring, Hibernate and MySQL. deathBURRITO even has a <a href="http://theksmith.com/tagged/deathburro/">robotic donkey</a> (really) whose purpose we haven&rsquo;t quite yet identified.</p>

<p>So far deathBURRITO has worked out well for us. Some of its features&mdash;namely, those that directly support deployment automation&mdash;have proven more useful than others. But the general consensus seems to be that deathBURRITO addresses an important configuration management (CM) gap, where previously we were &ldquo;managing&rdquo; CM data on a department wiki, in spreadsheets, in XML files and in Visio diagrams. While there&rsquo;s more work to do, what we&rsquo;ve done so far has been reasonably right-headed, and we&rsquo;ve been able to evolve it as our needs have evolved.</p>

<p>That&rsquo;s not to say that there&rsquo;s nothing I would change. I think there&rsquo;s an opportunity to do something better on the backend. That was indeed the impetus for Zkybase.</p>

<h3>Revisiting the backend with Spring Data</h3>


<p>Because CM involves a lot of different kinds of entities (e.g., regions, data centers, environments, farms, instance types, machine images, instances, applications, middleware, packages, deployments, EC2 security groups, key pairs&mdash;the list goes on and on), it was helpful to build out a bit of framework to handle various cross-cutting concerns more or less automatically, such as standard views (list view, details view, form views), web controllers (CRUD ops, standard queries), DAOs (again, CRUD ops and queries), generic domain object capabilities, security and more. And I think it&rsquo;s fair to say that this helped, though perhaps not quite as much as I would have liked (at least not yet). The fact remains that anytime we want to add a new entity to the system, we still have to do a fair amount of work making each layer of the framework do what it&rsquo;s supposed to do.</p>

<p>My experience has been that the data persistence layer is the one that&rsquo;s most challenging to change. Besides the actual schema changes, we have to write data migration scripts, we have to make corresponding changes to our integration test data scripts, we have to make sure Hibernate&rsquo;s eager- and lazy-loading are doing the right things, sometimes we have to change the domain object APIs and associated Hibernate queries, etc. Certainly doable, but there&rsquo;s generally a good deal of planning, discussion and testing involved.</p>

<p>So I started looking for some ways to simplify the backend.</p>

<p>Recently I started goofing around with <a href="http://www.springsource.org/spring-data">Spring Data</a>, and in particular, <a href="http://www.springsource.org/spring-data/jpa">Spring Data JPA</a> and <a href="http://www.springsource.org/spring-data/mongodb">Spring Data MongoDB</a>. For those who haven&rsquo;t used Spring Data, it offers some nice features that I wanted to try out:</p>

<ul class="square">
    <li>One of the features is that it&#8217;s able to generate DAO implementations automagically using Java&#8217;s dynamic proxy mechanism. Spring Data calls these DAOs &#8220;repositories&#8221;, which is fine with me. Basically what you do as a developer is you write an interface that extends a type-specific Repository interface, such as a JpaRepository or a MongoRepository. You don&#8217;t have to declare CRUD operations because the Repository interface already declares the ones you&#8217;d typically want (e.g., save(), findAll(), findById(), delete(), deleteAll(), exists(), count(), etc.).</li>
    <li>And if you have custom queries, just declare them on the interface using some method naming conventions and Spring Data can figure out how to generate an implementation for you.</li>
    <li>In some cases, Spring Data handles mapping for you. In the case of Spring Data JPA you still have to make sure you have the right JPA annotations in place, and that&#8217;s not too terribly bad. But for MongoDB, since the MongoDB backend is just BSON (binary JSON), the mapping from objects to MongoDB is straightforward and so Spring Data handles that very well, without requiring a bunch of annotations.</li>
</ul>


<p>&ldquo;Game changer&rdquo; might be too strong for the features I&rsquo;ve just described, but man, are they useful. Besides making it easier and faster to implement repos, Spring Data allows me to get rid of a lot of boilerplate code (lots of DAO implementations) and even some Spring Data-like DAO framework code that I usually write. (You know, define a generic DAO interface, a generic abstract DAO class, etc.) My days of building DAOs directly against Hibernate are probably over.</p>

<p>But that&rsquo;s not the only backend change I&rsquo;m looking at.</p>

<h3>Revisiting the backend, part 2: Neo4j + Spring Data Neo4j</h3>


<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-06-why-im-pretty-excited-about-using-neo4j-for-a-cmdb-backend/neo4j-graph.png" alt="Example of a graph in Neo4j" /></p>

<p>Since Spring Data tends to gravitate toward the NoSQL stores, I finally got around to reading up on Neo4j and some other stuff that I probably ought to have read up on a long time ago. Better late than never I guess. It struck me that Neo4j could be a very interesting way to implement a CM backend, and that Spring Data Neo4j could help me keep the DAO layer thin. Here&rsquo;s the thinking:</p>

<ul class="square">
    <li><strong>There are many entities and relationships.</strong> There are lots and lots of entities and relationships in a CMDB. There are different ways of grouping things, like grouping which assets form a stack, which stacks to deploy to which instances, which instances are in which farms, how to define shards and how to define failover farms, grouping features into apps, endpoints into services, etc. We have to associate SLAs and OLAs with app features and service endpoints, we have to define dependencies between components, and so on. There&#8217;s a ton of stuff. It would eliminate a major chunk of work if we could get away with defining the schema one time (say, in the app itself) instead of in both the app and the database.</li>
    <li><strong>We need schema agility to experiment with different CMDB approaches.</strong> Along similar lines, there are some strong forces that push for schema agility. Most fundamentally, the right approach to designing and implementing a CMDB isn&#8217;t necessarily a solved problem. Some tools involve running network discovery agents that collect up millions of configuration items (CIs) from the environment. Other tools focus more on collecting the <em>right</em> data rather than collecting everything. Some tools have more of a traditional enterprise data center customer in mind, where you&#8217;re capturing everything from bare metal to the apps to the ITIL services based on the apps. Other tools are more aligned with cloud infrastructures, starting from virtualized infrastructure and working up, leaving everything under that virtualization layer for the cloud provider to worry about. Some tools treat CIs as supporting configuration management but not application performance management (APM); other tools try to single-source their CM and APM data. Some organizations want to centralize CIs in a single database and other organizations pursue a more federated model. With such a panoply of approaches, it&#8217;s no surprise that schema changes occur.</li>
    <li><strong>We need schema agility to accommodate continuing innovations in infrastructure.</strong> Another schema agility driver is the fact that the way we do infrastructure is rapidly evolving. Infrastructure is steadily moving to the cloud, virtualization is commonplace and new automation and monitoring tools are appearing all the time. The constant stream of innovation demands the ability to adjust quickly, and schema flexibility is a big part of that.</li>
    <li><strong>We need schema flexibility to accommodate the needs of different organizations.</strong> Besides schema agility, a CMDB needs to offer a certain level of flexibility to support the needs of different customers. One org may have everything in the cloud, where another one is just getting its feet wet. One org may have two environments whereas another has seven. Different orgs have different roles, test processes, deployment pipelines and so forth. Any CMDB that hopes to support more than just a single customer needs to support some level of flexibility.</li>
    <li><strong>But we still need structure.</strong> One of the more powerful benefits of driving deployment automation from a CMDB is that you can control drift in the target environments by controlling the data in your CMDB. And defining a schema around that is a great way to do so. If, for example, you expect every instance in a given farm to have the same OS, then your schema should attach the OS to the farm itself, not to the instance. (The instances inherit the OS from the farm.) Or maybe it&#8217;s not just the OS&#8211;you want a certain instance type (in terms of virtual hardware profile), certain machine image, certain middleware stack, certain security configuration, etc. Great: bundle those together in a single server build object and then associate that with the farm. This constrains the instances in the farm to have the same server build. (See <a title="Flexibility" href="http://skydingo.com/blog/?p=56">this post</a> for a more detailed discussion.) While Neo4j is schema-free, Spring Data Neo4j gives us a way to impose schema from the app layer.</li>
    <li><strong>A schemaless backend makes zero-downtime deployments easier.</strong> If you have any apps with hardcore availability requirements, then it goes without saying that you have to have significant automation in place to support that, both on the deployment side and on the incident response side. Since the CMDB is the single source of truth driving that automation, it follows that the CMDB itself must have hardcore availability requirements. Having a schemaless database ought to make it easier to perform zero-downtime deployments of the CMDB itself.</li>
    <li><strong>We want to support intuitive querying.</strong> Once you bring a bunch of CIs together in a CMDB, there are all kinds of queries that pop up. This could be anything from using the dependency structure to diagnose an incident, assess the impact of a change, or sequence project deliverables (e.g. make system components highly available depending on where they sit in the system dependency graph); using org structures to determine support escalation paths and horizontal communications channels; SLA reporting by group, manager, application category; and so forth. Intuitive query languages for graph databases&#8211;and in particular, the Cypher query language for Neo4j&#8211;appear to be especially well-suited for the broad diversity of queries we expect to see.</li>
</ul>


<p>Remember how I mentioned that Spring Data generates repository implementations automatically based on interfaces? Here&rsquo;s what that looks like with Spring Data Neo4j:</p>

<pre><code>package org.skydingo.zkybase.repository;

import org.skydingo.zkybase.model.Person;
import org.skydingo.zkybase.model.Project;
import org.springframework.data.neo4j.annotation.Query;
import org.springframework.data.neo4j.repository.GraphRepository;

public interface ProjectRepository extends GraphRepository&lt;Project&gt; {
    Project findProjectByKey(String key);
    Project findProjectByName(String name);

    @Query("start person=node({0}) match person--&gt;project return project")
    Iterable&lt;Project&gt; findProjectsByPerson(Person person);
}
</code></pre>

<p>Let me repeat that I <em>don&rsquo;t</em> have to write the repository implementation myself. <code>GraphRepository</code> comes with various CRUD operations. Methods like <code>findProjectByKey()</code> and <code>findProjectByName()</code> obey a naming convention that allows Spring Data to produce the backing query automatically. And in the <code>findProjectsByPerson()</code> case, I provided a query using Neo4j&rsquo;s Cypher query language (it uses ASCII art to define queries&mdash;how ridiculously cool is that?).</p>

<h3>Exploring the ideas above with Zkybase</h3>


<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-06-why-im-pretty-excited-about-using-neo4j-for-a-cmdb-backend/dashboard1.png" alt="Zkybase dashboard" /></p>

<p>The point of Zkybase is to see whether we can build a better mousetrap based on the ideas above. I&rsquo;m using Neo4j and Spring Data Neo4j to build it out. I haven&rsquo;t decided yet whether Zkybase will focus on the CMDB piece or whether it&rsquo;s a frontend to configuration management more generally (delegating on the backend to something like <a href="http://www.opscode.com/chef/">Chef</a> or <a href="http://puppetlabs.com/">Puppet</a>, say), but the CMDB will certainly be in there. That will include a representation of the as-is (current) configuration as well as representations for desired configurations as might be defined during a deployment planning activity.</p>

<p>So far I&rsquo;m finding it a lot easier to work with the graph database than with a relational database, and I&rsquo;m finding Spring Data Neo4j to be a big help in terms of repository building and defining app-level schemas. The code is a lot smaller than it was when I did this with a relational database. But it&rsquo;s still early days, so the jury is out.</p>

<p>Watch this space for further developments.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/12/05/skybase-screenshots/">Zkybase Screenshots</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-05T04:43:11-08:00" pubdate data-updated="true">Dec 5<span>th</span>, 2011</time>
        
         | <a href="/2011/12/05/skybase-screenshots/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the things we&rsquo;re working on is an open source configuration management system called <a href="https://github.com/williewheeler/zkybase">Zkybase</a>. It&rsquo;s a new project, and we&rsquo;re still working out a lot of the high-level vision for this thing. I&rsquo;ll post more information about it later, but for now I just wanted to post some screenshots as a way for people to see how it looks. We&rsquo;re using <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a> for the CSS (very nice toolkit&mdash;love it), and Spring/<a href="http://neo4j.org/">Neo4j</a> (along with <a href="http://www.springsource.org/spring-data/neo4j">Spring Data Neo4j</a> on the backend. So far the Neo4j graph data is working out great for configuration management data.</p>

<p>Anyway here are the screenshots.</p>

<p>First, the dashboard:</p>

<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-05-skybase-screenshots/dashboard1.png" alt="Dashboard" /></p>

<p>Here&rsquo;s the project details page:</p>

<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-05-skybase-screenshots/project_details.png" alt="Project details page" /></p>

<p>And here&rsquo;s the page that allows you to create a new project:</p>

<p><img src="http://springinpractice.s3.amazonaws.com/blog/images/2011-12-05-skybase-screenshots/new_project_form.png" alt="New project form" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/10/28/springone-2gx-takeaways/">SpringOne 2GX Takeaways</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-28T05:06:28-07:00" pubdate data-updated="true">Oct 28<span>th</span>, 2010</time>
        
         | <a href="/2010/10/28/springone-2gx-takeaways/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://springinpractice.s3.amazonaws.com/blog/images/springone2gx.png" alt="SpringOne 2GX logo" align="right" /></p>

<p>I attended SpringOne 2GX in Chicago last week and had a good time. Great sessions and keynotes, and I got to see some people I hadn&rsquo;t seen in a while, and meet some new people too.</p>

<p>Here are some of the things that I found most interesting. This is just my own personal list obviously, and there&rsquo;s a huge list of things happening in the Spring world.</p>

<p><strong>Code2Cloud.</strong> This will be cloud-based application lifecycle management (ALM), like source control, issue tracking and continuous integration. One feature that looked particularly interesting was that the ALM system will execute the committed code and complain about code performance issues by creating an issue in the issue tracking system, complete with contextual information surrounding the performance issue in question.</p>

<p><strong>Gradle.</strong> From what I gather, this is like Maven, but Groovy-based instead of XML-based, and much more aggressive about making assumptions about your project. The end result is that the build file is much smaller than a Maven POM file. I suspect that I&rsquo;m not doing Gradle justice with this description but even with that description I&rsquo;m interested because I like Maven&rsquo;s approach, but I wouldn&rsquo;t mind build files that are more compact.</p>

<p><strong>Spring support for NoSQL data stores.</strong> NoSQL (&ldquo;not only SQL&rdquo;) is a pretty important topic and Spring is jumping into this space with support for multiple providers. One thing that was neat was that you can have POJOs that are partially backed by traditional RDBMS databases (say for metadata) and partially backed by a NoSQL store, all using annotations as you might guess.</p>

<p><strong>Spring Social.</strong> It allows developers to create apps that interact with the major social networks. Part of what&rsquo;s involved includes expanded <code>RestTemplate</code>s for making the web service calls. The other part is that it handles the OAuth authorization behind the scenes so developers don&rsquo;t have to mess around with what can be a complicated undertaking.</p>

<p><strong>Spring Mobile.</strong> This allows Spring developers to develop apps for mobile platforms like the iPhone and the Droid.</p>

<p><strong>Support for HTML 5.</strong> Saw some pretty nice demos of HTML 5 apps. I&rsquo;m not sure at this point exactly what this support entails, but it looks like this is one of several areas of effort.</p>

<p><strong>Cache API and support for distributed caches.</strong> Spring has included a preliminary cache API for several years now, but with the uptick in distributed caching they&rsquo;re building this out and will include it in Spring 3.1 I think they said.</p>

<p><strong>Support for environments.</strong> Also a Spring 3.1 feature, there will be support for creating environment-specific beans (e.g. beans for dev, functional test, staging, prod, etc.).</p>

<p><strong>Gemfire data fabric.</strong> I sat in on a session here and there was quite a bit to take in, so I&rsquo;d need to hear the talk again to report on exactly what the offer is here. But the basic idea is highly available, low latency, horizontally scalable data that doesn&rsquo;t sacrifice consistency. I know a lot of organizations could use something like that so I&rsquo;ll be keeping an eye on this.</p>

<p>Those were the things that stood out for me. Any fears that Java and/or Spring aren&rsquo;t keeping with the times would appear to be unfounded.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/10/27/quick-tip-spring-security-role-based-authorization-and-permissions/">Quick Tip: Spring Security Role-based Authorization and Permissions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-27T05:40:13-07:00" pubdate data-updated="true">Oct 27<span>th</span>, 2010</time>
        
         | <a href="/2010/10/27/quick-tip-spring-security-role-based-authorization-and-permissions/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>The problem: hardcoded role-based authorization</h3>


<p>One of the challenges around using Spring Security is that the examples&mdash;both in the documentation and on the web&mdash;tend to promote an overly-simple approach to role-based authorization, hardcoding roles in the source in a non-configurable fashion. For example:</p>

<pre style="margin:20px 0;">
@PreAuthorize("hasRole('facultyMember')")
public Newsletter getFacultyNews() { ... }
</pre>


<p>(Assume for the sake of example that ACL-based authorization is overkill for the method in question. The user either has permission to read faculty newsletters or not.)</p>

<p>The problem is that when we decide to make a change&mdash;for example, maybe teaching assistants should be allowed to read the faculty newsletters too&mdash;we have to go into the code to make a change:</p>

<pre style="margin:20px 0;">
@PreAuthorize("hasRole('facultyMember') or hasRole('teachingAssistant')")
public Newsletter getFacultyNews() { ... }
</pre>


<p>For domain object security there&rsquo;s no problem because the permissions are cleanly separated from roles. We can map associate individual permissions on domain objects with users and roles as we wish. So the code contains annotations like</p>

<pre style="margin:20px 0;">
@PreAuthorize("hasPermission(#message, write)")
public void editMessage(Message message) { ... }
</pre>


<p>and all is good. We probably won&rsquo;t need to change the relationship between the permission and the method itself; we&rsquo;ll only need to change who (which users/roles) actually has the write permission on the message in question, and we can do that in the database. So that is nice, and we want the same thing for role-based authorization.</p>

<h3>Solution: use granted authorities to model <i>permissions</i>, not roles</h3>


<p>Here we assume an authentication source that models the desired relationship between users, roles and permissions. The typical relationship would be a many-many relationship between users and roles, and a many-many relationship between roles and permissions. For example:</p>

<p><img src="http://springinpractice.s3.amazonaws.com/springsecurity/refcard106/sample_user_schema.png" alt="Sample custom user schema" /></p>

<p>It would be possible to have a direct relationship between users and permissions too (say to allow for the assignment of fine-grained permissions to specific users in addition to assigning roles), if that were desired.</p>

<p>The schema can be part of some standard authentication source or it can be a custom <code>UserDetailsService</code>; it doesn&rsquo;t matter.</p>

<p>At the end of the day we need to transform our user representation into a <code>UserDetails</code>, and the trick is to map <i>permissions</i>&mdash;not roles&mdash;to <code>GrantedAuthority</code> objects to support the <code>getAuthorities()</code> contract on the <code>UserDetails</code> interface. We still have roles, but they matter only insofar as they help to bundle permissions up into convenient packages. The <code>UserDetails</code> implementation will probably expose the roles, but the <code>UserDetails</code> interface simply exposes the permissions (not the roles) via the <code>getAuthorities()</code> method.</p>

<p>It&rsquo;s really that simple, and the final result is that we can avoid hardcoding roles in the code:</p>

<pre style="margin:20px 0;">
@PreAuthorize("hasRole('PERM_READ_FACULTY_NEWS')")
public Newsletter getFacultyNews() { ... }
</pre>


<p>As an aside, the predicate name <code>hasRole</code> rather than <code>hasAuthority</code> is a minor annoyance since permissions aren&rsquo;t roles. The backing check is against a <code>GrantedAuthority</code> and so <code>hasRole()</code> seems to reflect either the intended or the typical use of <code>GrantedAuthority</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/10/10/quick-tip-avoid-rule-duplication-when-using-securityauthorize/">Quick Tip: Avoid Rule Duplication When Using Security:authorize</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-10T15:56:42-07:00" pubdate data-updated="true">Oct 10<span>th</span>, 2010</time>
        
         | <a href="/2010/10/10/quick-tip-avoid-rule-duplication-when-using-securityauthorize/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Spring Security features a  tag that allows us to show or hide JSP content based on access rules we can define. Here&rsquo;s an example:</p>

<pre style="margin:20px 0;">
&lt;security:authorize access="hasRole('admin')"&gt;
    &lt;a href="/main/admin.html"&gt;Admin&lt;/a&gt;
&lt;security:authorize&gt;
</pre>


<p>This is probably the most common way to use the tag. The problem with this approach, though, is that it leads to rule duplication, because the same <code>hasRole(&lsquo;admin&rsquo;)</code> rule is defined in the security application context.</p>

<p>A better approach is to bind the display of the tag body to the user&rsquo;s actual access to the URL in question. Suppose for example that we have the following definition in the app context:</p>

<pre style="margin:20px 0;">
&lt;intercept-url pattern="/main/admin.html" method="GET"
    access="hasRole('admin')" /&gt;
</pre>


<p>Then we can simply replace the old JSP tag definition with a new one like this:</p>

<pre style="margin:20px 0;">
&lt;security:authorize url="/main/admin.html" method="GET"&gt;
    &lt;a href="/main/admin.html"&gt;Admin&lt;/a&gt;
&lt;security:authorize&gt;
</pre>


<p>Now we&rsquo;ve successfully eliminated the duplicate rule definition. If we were to decide to change the rule to <code>hasRole(&lsquo;administrator&rsquo;)</code>, or to anything else for that matter, we&rsquo;d be able to do that in a single location.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/5/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/3/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/09/25/aggregating-tp90-data-with-splunk/">Aggregating TP90 data with Splunk</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/14/optimistic-locking-with-spring-data-rest/">Optimistic locking with Spring Data REST</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/07/octopress-migration/">Octopress migration</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/08/seajug-talk-on-spring-data-jpa-spring-data-rest-and-spring-hateoas/">SeaJUG talk on Spring Data JPA</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/08/spring-in-practice-now-available/">Spring in Practice now available</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/williewheeler">@williewheeler</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'williewheeler',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Willie Wheeler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'springinpractice';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
